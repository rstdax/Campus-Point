<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    
    <title>Chat | Campus Point</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-main: #050505; --bg-card: #0F0F10; 
            --accent: #4D6BF8; --accent-glow: rgba(77, 107, 248, 0.4);
            --text: #EDEDED; --text-sec: #888;
            --mine-bg: #4D6BF8; --mine-text: #fff;
            --theirs-bg: #1A1A1C; --theirs-text: #EDEDED;
            --border: #2A2A2E;
        }
        [data-theme="light"] { 
            --bg-main: #F2F4F8; --bg-card: #FFF; 
            --accent: #304FFE; --accent-glow: rgba(48, 79, 254, 0.2);
            --text: #111; --text-sec: #555;
            --mine-bg: #304FFE; --mine-text: #fff;
            --theirs-bg: #EAECEF; --theirs-text: #111;
            --border: #DDE1E6;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        
        /* FIX 2: Better height handling for PWA */
        html { height: 100%; }
        
        body { 
            font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text); 
            
            /* Use dvh for dynamic viewport height (accounts for browser bars) */
            height: 100dvh;
            /* Fallback for older browsers */
            height: 100%;
            
            position: fixed; 
            inset: 0; 
            width: 100%;
            
            display:flex; 
            flex-direction:column; 
            overflow:hidden; 
        }
        
        /* --- HEADER --- */
        .chat-header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            flex-shrink: 0; 
            z-index: 10;
            padding-top: env(safe-area-inset-top); /* Status bar protection */
        }
        .back-btn { 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: var(--text); cursor: pointer;
        }
        .header-avatar {
            width: 38px; height: 38px; border-radius: 50%; background-size: cover; background-position: center;
            border: 1px solid var(--border);
        }
        .header-info { flex: 1; overflow: hidden; }
        .header-name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-status { font-size: 0.75rem; color: var(--text-sec); }

        /* --- MESSAGES --- */
        #messages {
            flex: 1; 
            /* FIX 3: min-height: 0 prevents flex item from overflowing parent */
            min-height: 0; 
            
            overflow-y: auto; padding: 20px 15px; 
            display: flex; flex-direction: column; gap: 8px;
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; 
        }
        
        .msg-container { display: flex; gap: 8px; max-width: 85%; align-items: flex-end; }
        .msg-container.mine { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-avatar { 
            width: 24px; height: 24px; border-radius: 50%; background-size: cover; 
            flex-shrink: 0; margin-bottom: 2px; border: 1px solid var(--border);
        }
        
        .msg-bubble {
            padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
            position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .msg-container.mine .msg-bubble {
            background: var(--mine-bg); color: var(--mine-text);
            border-bottom-right-radius: 4px;
        }
        
        .msg-container.theirs .msg-bubble {
            background: var(--theirs-bg); color: var(--theirs-text);
            border-bottom-left-radius: 4px;
        }

        .timestamp {
            font-size: 0.65rem; color: var(--text-sec); margin-top: 4px; opacity: 0.7; text-align: right;
        }

        /* --- INPUT --- */
        .input-area {
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
            padding: 10px 15px;
            
            /* FIX 4: Robust padding for Home Bar/Gestures */
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            
            flex-shrink: 0; 
            z-index: 20;
        }
        
        .input-wrapper {
            flex: 1; background: var(--bg-main); border-radius: 25px; 
            border: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px;
            min-height: 45px;
        }
        
        input { 
            flex: 1; height: 45px; border: none; background: transparent; 
            color: var(--text); outline: none; font-family: 'Inter'; font-size: 1rem; 
        }
        
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--accent); color: white; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px var(--accent-glow);
            flex-shrink: 0;
        }

        .empty-state { text-align: center; margin-top: 50px; color: var(--text-sec); font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="chat-header">
        <div class="back-btn" onclick="window.location.href='index.html'">
            <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div id="header-avatar" class="header-avatar"></div>
        <div class="header-info">
            <div class="header-name" id="chat-title">User</div>
            <div class="header-status">Online</div>
        </div>
    </div>

    <div id="messages">
        <div class="empty-state">Loading conversation...</div>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="Message..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBg1m_bFN4xzl4yJ_JiG8E6UPDZjFks7PM",
            authDomain: "campus-point-rst.firebaseapp.com",
            projectId: "campus-point-rst",
            storageBucket: "campus-point-rst.firebasestorage.app",
            messagingSenderId: "877074516750",
            appId: "1:877074516750:web:f485c45a1446c030afa55f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let chatId = new URLSearchParams(window.location.search).get('chatId');
        let currentUser;
        let otherUserPhoto = ''; 

        auth.onAuthStateChanged(user => {
            if(!user) window.location.href = 'index.html';
            currentUser = user;
            initChat();
        });

        function initChat() {
            if(!chatId) return;
            
            db.collection('chats').doc(chatId).get().then(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    const otherId = data.participants.find(id => id !== currentUser.uid);
                    const otherUser = data.participantDetails[otherId];
                    document.getElementById('chat-title').innerText = otherUser.name;
                    document.getElementById('header-avatar').style.backgroundImage = `url('${otherUser.photo}')`;
                    otherUserPhoto = otherUser.photo;
                }
            });

            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snap => {
                    const container = document.getElementById('messages');
                    container.innerHTML = ''; 
                    
                    if(snap.empty) {
                        container.innerHTML = '<div class="empty-state">No messages yet.<br>Say hello! ðŸ‘‹</div>';
                        return;
                    }

                    snap.forEach(doc => {
                        const d = doc.data();
                        const isMine = d.senderId === currentUser.uid;
                        
                        let time = '';
                        if(d.timestamp) {
                            const date = d.timestamp.toDate();
                            time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        }

                        const avatarHtml = isMine ? '' : `<div class="msg-avatar" style="background-image: url('${otherUserPhoto}')"></div>`;

                        const msgHtml = `
                            <div class="msg-container ${isMine ? 'mine' : 'theirs'}">
                                ${avatarHtml}
                                <div class="msg-bubble">
                                    ${d.text}
                                    <div class="timestamp" style="color: ${isMine ? 'rgba(255,255,255,0.7)' : ''}">${time}</div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += msgHtml;
                    });
                    
                    // Auto scroll to bottom
                    container.scrollTop = container.scrollHeight; 
                });
        }

        function sendMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;
            
            db.collection('chats').doc(chatId).collection('messages').add({
                text: text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            db.collection('chats').doc(chatId).update({
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: text,           // <--- ADD THIS
                lastSenderId: currentUser.uid // <--- ADD THIS
            });

            input.value = '';
            input.focus();
        }

        document.getElementById('msg-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMsg();
        });

        // FIX 5: Ensure keyboard interactions scroll to bottom smoothly
        const inputField = document.getElementById('msg-input');
        inputField.addEventListener('focus', () => {
            setTimeout(() => {
                const messages = document.getElementById('messages');
                messages.scrollTop = messages.scrollHeight;
                window.scrollTo(0, document.body.scrollHeight);
            }, 300);
        });
    </script>
</body>
</html>