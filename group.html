<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Group Chat | Campus Point</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-main: #050505; --bg-card: #0F0F10; 
            --accent: #4D6BF8; --text: #EDEDED; 
            --text-sec: #888; --border: #2A2A2E;
            --mine-bg: #4D6BF8; --mine-text: #fff;
        }
        [data-theme="light"] { 
            --bg-main: #F2F4F8; --bg-card: #FFF; 
            --accent: #304FFE; --text: #111; 
            --text-sec: #555; --border: #DDE1E6;
            --mine-bg: #304FFE; --mine-text: #fff;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html { height: 100%; }
        body { 
            font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text); 
            height: 100dvh; height: 100%; position: fixed; inset: 0; width: 100%;
            display:flex; flex-direction:column; overflow:hidden; 
        }

        /* --- HEADER --- */
        .chat-header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            flex-shrink: 0; z-index: 10; padding-top: env(safe-area-inset-top); 
        }
        .back-btn { 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: var(--text); cursor: pointer;
        }
        .header-avatar {
            width: 38px; height: 38px; border-radius: 50%; background-size: cover; background-position: center;
            border: 1px solid var(--border);
        }
        .header-info { flex: 1; overflow: hidden; }
        .header-name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-status { font-size: 0.75rem; color: var(--text-sec); }

        /* --- MESSAGES CONTAINER --- */
        #messages {
            flex: 1; min-height: 0; overflow-y: auto; 
            padding: 20px 15px; 
            display: flex; flex-direction: column; gap: 4px; /* Reduced gap */
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: auto; /* Important for lazy loading scroll check */
            -webkit-overflow-scrolling: touch; 
        }

        /* --- CHAT BUBBLE STYLES --- */
        .msg-container { 
            display: flex; gap: 8px; max-width: 85%; align-items: flex-start; 
            align-self: flex-start; /* Default alignment for others */
            margin-top: 4px; 
        }
        .msg-container.mine { 
            align-self: flex-end; 
            flex-direction: row-reverse; 
        }
        
        .msg-avatar { 
            width: 24px; height: 24px; border-radius: 50%; background-size: cover; 
            flex-shrink: 0; margin-top: 4px; border: 1px solid var(--border);
            cursor: pointer;
        }
        
        .msg-content { max-width: 100%; }

        .msg-bubble {
            padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
            position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s; /* For swipe effect */
        }
        
        .msg-container.mine .msg-bubble {
            background: var(--mine-bg); color: var(--mine-text);
            border-bottom-right-radius: 4px;
        }
        
        .msg-container.theirs .msg-bubble {
            /* Unique color will be set by JS via style attribute */
            background: #1A1A1C; /* Default fallback */
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        
        .msg-sender {
            font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;
            /* Sender color will be set by JS */
        }

        .timestamp {
            font-size: 0.65rem; color: var(--text-sec); margin-top: 4px; opacity: 0.8; 
            text-align: right; 
            font-family: 'JetBrains Mono', monospace;
        }

        .msg-container.mine .timestamp {
            color: rgba(255,255,255,0.7);
        }

        /* --- REPLY BUBBLE STYLES --- */
        .reply-bubble {
            background: rgba(136, 136, 136, 0.2); 
            border-left: 3px solid var(--accent); 
            padding: 8px; border-radius: 8px; 
            margin-bottom: 6px;
            font-size: 0.85rem; line-height: 1.3;
            overflow: hidden;
            max-height: 60px; /* Max height to keep it concise */
        }

        .reply-sender {
            font-weight: 600; font-size: 0.8rem; color: var(--accent);
            display: block;
            margin-bottom: 2px;
        }

        .reply-text {
            color: var(--text-sec);
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }

        /* --- REPLY INPUT BAR --- */
        #reply-indicator {
            padding: 8px 15px; 
            background: var(--bg-card); 
            border-top: 1px solid var(--border); 
            display: none; /* Hidden by default */
        }
        #reply-content {
            border-left: 3px solid var(--accent);
            padding: 5px 10px;
            margin-right: 10px;
        }
        #reply-text-preview {
            font-size: 0.85rem; color: var(--text-sec);
            display: -webkit-box;
            -webkit-line-clamp: 1; 
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #reply-close {
            color: var(--text-sec); font-size: 1.1rem; cursor: pointer;
        }

        /* --- INPUT --- */
        .input-area {
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0; z-index: 20;
        }
        
        .input-wrapper {
            flex: 1; background: var(--bg-main); border-radius: 25px; 
            border: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px;
            min-height: 45px;
        }
        
        input { 
            flex: 1; height: 45px; border: none; background: transparent; 
            color: var(--text); outline: none; font-family: 'Inter'; font-size: 1rem; 
        }
        
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--accent); color: white; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px var(--accent-glow);
            flex-shrink: 0;
        }

        .empty-state { text-align: center; margin-top: 50px; color: var(--text-sec); font-size: 0.9rem; }
        
        /* --- MENTION SUGGESTIONS --- */
        #mention-suggestions {
            position: absolute;
            bottom: 60px; /* Adjust based on input area height */
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            z-index: 25;
            display: none;
        }
        .mention-item {
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .mention-item:hover {
            background: var(--border);
        }
        
        /* --- LAZY LOAD SPINNER --- */
        .lazy-load-spinner {
            text-align: center; 
            padding: 10px;
            margin-top: 10px;
            color: var(--text-sec);
            display: none; /* Hidden by default */
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="chat-header">
        <div class="back-btn" onclick="window.location.href='index.html#groups'">
            <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div id="header-avatar" class="header-avatar" style="font-size:1.5rem; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-users"></i>
        </div>
        <div class="header-info">
            <div class="header-name" id="chat-title">Group Chat</div>
            <div class="header-status" id="member-count">0 members</div>
        </div>
    </div>

    <div id="messages">
        <div class="lazy-load-spinner" id="lazy-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i> Loading previous messages...
        </div>
        <div class="empty-state" id="empty-state">No messages yet. Say hello! ðŸ‘‹</div>
    </div>
    
    <div id="mention-suggestions"></div>

    <div id="reply-indicator" style="display: none;">
        <div id="reply-content" style="flex-grow: 1;">
            <div id="reply-sender-preview" style="font-weight: 600; font-size: 0.8rem; color: var(--accent);"></div>
            <div id="reply-text-preview"></div>
        </div>
        <i class="fa-solid fa-xmark" id="reply-close" onclick="cancelReply()"></i>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="Message..." autocomplete="off" onkeypress="handleKeyPress(event)">
        </div>
        <button class="send-btn" onclick="sendGroupMsg()">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBg1m_bFN4xzl4yJ_JiG8E6UPDZjFks7PM",
        authDomain: "campus-point-rst.firebaseapp.com",
        projectId: "campus-point-rst",
        storageBucket: "campus-point-rst.firebasestorage.app",
        messagingSenderId: "877074516750",
        appId: "1:877074516750:web:f485c45a1446c030afa55f"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    let groupName = new URLSearchParams(window.location.search).get('group');
    let currentUser;
    let members = {}; // Stores {uid: {name, color, photo}}
    let spamTimer = null;
    let lastMessageTimestamp = 0;
    let replyToMessageId = null;
    let lastVisible = null; // For lazy loading
    let isLoading = false; 
    let initialLoadComplete = false;
    let realTimeListener = null; // Store the real-time listener reference
    let messageIds = new Set(); // Track displayed message IDs to prevent duplicates

    // Hashing function to get a unique color for a user ID
    function getUniqueColor(uid) {
        if (!uid) return '#4D6BF8';
        let hash = 0;
        for (let i = 0; i < uid.length; i++) {
            hash = uid.charCodeAt(i) + ((hash << 5) - hash);
        }
        let color = '#';
        for (let i = 0; i < 3; i++) {
            let value = (hash >> (i * 8)) & 0xFF;
            color += ('00' + value.toString(16)).substr(-2);
        }
        let r = parseInt(color.substring(1,3), 16);
        let g = parseInt(color.substring(3,5), 16);
        let b = parseInt(color.substring(5,7), 16);
        
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        if (brightness < 100) { 
            r = Math.min(255, r + 100);
            g = Math.min(255, g + 100);
            b = Math.min(255, b + 100);
            color = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        return color;
    }

    // --- INIT ---
    auth.onAuthStateChanged(user => {
        if(!user) window.location.href = 'index.html';
        currentUser = user;
        
        members[currentUser.uid] = { 
            name: currentUser.displayName || "User",
            photo: currentUser.photoURL,
            color: getUniqueColor(currentUser.uid) 
        };
        
        initGroupChat();
    });

    async function initGroupChat() {
        if(!groupName) {
            alert("Invalid group name.");
            window.location.href = 'index.html#groups';
            return;
        }

        document.getElementById('chat-title').innerText = `#${groupName} Lounge`;
        
        const groupRef = db.collection('groups').doc(groupName);
        
        // Initialize group if it doesn't exist
        await groupRef.set({
            name: groupName,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Set up listener for members
        groupRef.collection('members').onSnapshot(snap => {
            snap.forEach(doc => {
                const memberData = doc.data();
                const uid = doc.id;
                if (!members[uid]) {
                    members[uid] = {
                        name: memberData.name || "Anon",
                        photo: memberData.photo,
                        color: getUniqueColor(uid)
                    };
                }
            });
            document.getElementById('member-count').innerText = `${snap.size} members`;
        });

        // Add current user to members
        groupRef.collection('members').doc(currentUser.uid).set({
            name: currentUser.displayName,
            photo: currentUser.photoURL,
            joined: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Start real-time listener for NEW messages only
        startNewMessageListener();
        
        // Load initial messages (history)
        loadMessages(false);
        
        // Add event listeners
        document.getElementById('messages').addEventListener('scroll', checkLazyLoad);
        document.getElementById('msg-input').addEventListener('input', checkMention);
        
        // Auto-focus input
        setTimeout(() => {
            document.getElementById('msg-input').focus();
        }, 500);
    }

    // --- MESSAGE LOADING (LAZY LOAD) ---
    const PAGE_SIZE = 20; 

    async function loadMessages(isLazyLoad = false) {
        const container = document.getElementById('messages');
        const spinner = document.getElementById('lazy-spinner');
        const emptyState = document.getElementById('empty-state');
        
        // If lazy loading and we've reached the end or already loading
        if (isLazyLoad && (!lastVisible || isLoading)) {
            return;
        }
        
        // If initial load already completed and this is not a lazy load
        if (!isLazyLoad && initialLoadComplete) {
            return;
        }
        
        // Set loading state
        isLoading = true;
        
        // Show spinner only for lazy loading
        if (isLazyLoad) {
            spinner.style.display = 'block';
        }

        let query = db.collection('groups').doc(groupName).collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(PAGE_SIZE);

        if (isLazyLoad && lastVisible) {
            query = query.startAfter(lastVisible);
        }

        try {
            const snapshot = await query.get();
            
            // Hide spinner
            spinner.style.display = 'none';
            
            if (snapshot.empty) {
                if (isLazyLoad) {
                    spinner.innerHTML = "No more messages";
                    setTimeout(() => {
                        spinner.style.display = 'none';
                    }, 2000);
                    lastVisible = null;
                } else {
                    emptyState.style.display = 'block';
                }
                return;
            }

            // Hide empty state if showing messages
            emptyState.style.display = 'none';
            
            // Store the last document for next lazy load
            lastVisible = snapshot.docs[snapshot.docs.length - 1];
            
            // Mark initial load as complete
            if (!isLazyLoad) {
                initialLoadComplete = true;
            }
            
            const messagesFragment = document.createDocumentFragment();
            let currentScrollHeight = container.scrollHeight;

            // Process messages in reverse order (oldest first)
            snapshot.docs.reverse().forEach(doc => {
                const messageId = doc.id;
                
                // Skip if message already exists (prevents duplicates)
                if (messageIds.has(messageId)) {
                    return;
                }
                
                messageIds.add(messageId);
                const el = renderGroupMsg(doc);
                
                if (isLazyLoad) {
                    // For lazy load, insert at the top
                    messagesFragment.appendChild(el);
                } else {
                    // For initial load, insert at the top (since we're loading newest first)
                    messagesFragment.appendChild(el);
                }
            });
            
            if (isLazyLoad) {
                // Insert at the top of the messages container
                container.insertBefore(messagesFragment, container.firstChild.nextSibling);
                
                // Maintain scroll position
                const newScrollHeight = container.scrollHeight;
                container.scrollTop = newScrollHeight - currentScrollHeight;
            } else {
                // For initial load, append to the container
                container.appendChild(messagesFragment);
                
                // Scroll to bottom after initial load
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }

        } catch (error) {
            console.error("Error loading messages: ", error);
            spinner.innerHTML = "Error loading messages";
            spinner.style.color = '#ff5555';
            spinner.style.display = 'block';
        } finally {
            isLoading = false;
        }
    }

    function checkLazyLoad() {
        const container = document.getElementById('messages');
        
        // Only trigger lazy load when scrolled near the top
        if (container.scrollTop < 100 && lastVisible && !isLoading) {
            loadMessages(true);
        }
    }

    function startNewMessageListener() {
        // Remove existing listener if any
        if (realTimeListener) {
            realTimeListener();
        }
        
        const container = document.getElementById('messages');
        const emptyState = document.getElementById('empty-state');
        
        // Listen for new messages added
        realTimeListener = db.collection('groups').doc(groupName).collection('messages')
            .orderBy('timestamp', 'desc')
            .limit(1)
            .onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const messageId = change.doc.id;
                        
                        // Skip if message already exists
                        if (messageIds.has(messageId)) {
                            return;
                        }
                        
                        messageIds.add(messageId);
                        const el = renderGroupMsg(change.doc);
                        
                        // Hide empty state
                        emptyState.style.display = 'none';
                        
                        // Append new message at the bottom
                        container.appendChild(el);
                        
                        // Auto-scroll to bottom if user is near the bottom
                        const isNearBottom = container.scrollHeight - container.clientHeight - container.scrollTop < 100;
                        if (isNearBottom) {
                            container.scrollTop = container.scrollHeight;
                        }
                    }
                });
            }, error => {
                console.error("Real-time listener error: ", error);
            });
    }

    // --- SENDING & ANTI-SPAM ---
    function sendGroupMsg() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        const sendButton = document.querySelector('.send-btn');
        
        if(!text) return;
        
        const now = Date.now();
        if (now - lastMessageTimestamp < 3000) {
            if (!spamTimer) {
                sendButton.disabled = true;
                sendButton.style.opacity = 0.5;
                sendButton.innerHTML = `<i class="fa-solid fa-hourglass-start"></i>`;
                spamTimer = setTimeout(() => {
                    sendButton.disabled = false;
                    sendButton.style.opacity = 1;
                    sendButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i>`;
                    spamTimer = null;
                }, 3000);
            }
            alert("Please wait 3 seconds between messages to reduce spam.");
            return;
        }
        
        const messageData = {
            text: text,
            senderId: currentUser.uid,
            senderName: currentUser.displayName || "User",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (replyToMessageId) {
            const replyEl = document.getElementById(replyToMessageId);
            if (replyEl) {
                messageData.replyTo = {
                    id: replyToMessageId,
                    text: replyEl.querySelector('.msg-bubble').textContent.trim().substring(0, 100) + (replyEl.querySelector('.msg-bubble').textContent.trim().length > 100 ? '...' : ''), 
                    senderName: replyEl.querySelector('.msg-sender')?.textContent || 'Original User'
                };
            }
        }
        
        db.collection('groups').doc(groupName).collection('messages').add(messageData)
            .then(() => {
                input.value = '';
                cancelReply();
                lastMessageTimestamp = now; 
            })
            .catch(e => {
                console.error("Error sending message: ", e);
                alert("Error sending message: " + e.message);
            });
    }

    // Handle Enter key press
    function handleKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendGroupMsg();
        }
    }

    // --- UI RENDERING ---
    function renderGroupMsg(doc) {
        const d = doc.data();
        const isMine = d.senderId === currentUser.uid;
        const uid = d.senderId;
        const member = members[uid] || { 
            name: d.senderName || "Unknown", 
            color: getUniqueColor(uid),
            photo: null
        };
        
        let time = '';
        if(d.timestamp) {
            try {
                const date = d.timestamp.toDate();
                const timePart = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const datePart = date.toLocaleDateString([], { month: 'numeric', day: 'numeric' });
                time = `${timePart} | ${datePart}`;
            } catch (e) {
                time = 'Just now';
            }
        }

        const container = document.createElement('div');
        container.className = `msg-container ${isMine ? 'mine' : 'theirs'}`;
        container.id = `msg-${doc.id}`; 
        container.setAttribute('data-sender-name', d.senderName || "Unknown"); 
        container.setAttribute('data-timestamp', d.timestamp ? d.timestamp.toMillis() : Date.now());
        
        // Add swipe for reply functionality
        container.addEventListener('touchstart', handleTouchStart);
        container.addEventListener('touchmove', handleTouchMove);
        container.addEventListener('touchend', handleTouchEnd);
        
        let replyHTML = '';
        if (d.replyTo) {
            replyHTML = `
                <div class="reply-bubble" onclick="scrollToReply('${d.replyTo.id}')">
                    <span class="reply-sender">${d.replyTo.senderName}</span>
                    <div class="reply-text">${d.replyTo.text}</div>
                </div>
            `;
        }

        const textWithMentions = d.text.replace(/@(\w+)/g, (match, username) => {
            const mentionedUid = Object.keys(members).find(key => members[key].name === username);
            const mentionColor = mentionedUid ? members[mentionedUid].color : 'var(--accent)';
            return `<span style="color:${mentionColor}; font-weight: 600;">${match}</span>`;
        });

        // Add avatar click for mention
        const avatarClick = member.photo ? 
            `style="background-image: url('${member.photo}')"` : 
            `style="background-color: ${member.color}; display: flex; align-items: center; justify-content: center; color: white;"`;
        
        container.innerHTML = `
            <div class="msg-avatar" ${avatarClick} onclick="mentionUser('${member.name.replace(/'/g, "\\'")}')">
                ${!member.photo ? member.name.charAt(0).toUpperCase() : ''}
            </div>
            <div class="msg-content">
                ${!isMine ? `<div class="msg-sender" style="color: ${member.color};">${member.name}</div>` : ''}
                ${replyHTML}
                <div class="msg-bubble" style="${!isMine ? `background-color: ${member.color}15; border: 1px solid ${member.color}50;` : ''}">
                    ${textWithMentions}
                    <div class="timestamp">${time}</div>
                </div>
            </div>
        `;
        return container;
    }
    
    // --- REPLY FUNCTIONALITY ---
    function startReply(messageId) {
        const messageEl = document.getElementById(messageId);
        if (!messageEl) return;
        
        const senderName = messageEl.getAttribute('data-sender-name');
        const messageText = messageEl.querySelector('.msg-bubble').textContent.trim();

        replyToMessageId = messageId;
        document.getElementById('reply-sender-preview').innerText = `Replying to ${senderName}`;
        document.getElementById('reply-text-preview').innerText = messageText.substring(0, 100) + (messageText.length > 100 ? '...' : '');
        document.getElementById('reply-indicator').style.display = 'flex';
        document.getElementById('msg-input').focus();
    }

    function cancelReply() {
        replyToMessageId = null;
        document.getElementById('reply-indicator').style.display = 'none';
    }

    function scrollToReply(messageId) {
        const target = document.getElementById(messageId);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            target.style.transform = 'scale(1.03)';
            setTimeout(() => {
                target.style.transform = 'scale(1)';
            }, 500);
        }
    }
    
    // --- SWIPE FOR REPLY (Touch Implementation) ---
    let initialX = null;
    let currentElement = null;

    function handleTouchStart(e) {
        initialX = e.touches[0].clientX;
        currentElement = e.currentTarget;
    }

    function handleTouchMove(e) {
        if (!initialX || !currentElement) return;

        const currentX = e.touches[0].clientX;
        const diffX = currentX - initialX;
        
        // Only allow right swipe (positive diffX)
        if (diffX > 0 && diffX < 100) {
            const bubble = currentElement.querySelector('.msg-bubble');
            bubble.style.transform = `translateX(${Math.min(diffX, 50)}px)`;
        }
    }

    function handleTouchEnd(e) {
        if (!initialX || !currentElement) return;

        const currentX = e.changedTouches[0].clientX;
        const diffX = currentX - initialX;
        const threshold = 50;

        if (diffX > threshold) {
            startReply(currentElement.id);
        }

        // Reset transform
        const bubble = currentElement.querySelector('.msg-bubble');
        if (bubble) {
            bubble.style.transform = 'translateX(0)';
        }
        
        initialX = null;
        currentElement = null;
    }

    // --- MENTION FUNCTIONALITY ---
    function checkMention(e) {
        const input = e.target;
        const text = input.value;
        const cursorPosition = input.selectionStart;
        const mentionSuggestions = document.getElementById('mention-suggestions');
        
        const preText = text.substring(0, cursorPosition);
        const lastAtIndex = preText.lastIndexOf('@');
        
        mentionSuggestions.innerHTML = '';
        
        if (lastAtIndex > -1 && (lastAtIndex === 0 || text[lastAtIndex - 1] === ' ')) {
            const searchTerm = preText.substring(lastAtIndex + 1);
            
            const matches = Object.keys(members)
                .filter(uid => uid !== currentUser.uid)
                .map(uid => ({
                    name: members[uid].name,
                    uid: uid
                }))
                .filter(member => 
                    member.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            
            if (matches.length > 0) {
                mentionSuggestions.style.display = 'block';
                matches.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'mention-item';
                    item.innerHTML = `<strong>${member.name}</strong>`;
                    item.onclick = () => selectMention(member.name, lastAtIndex, cursorPosition);
                    mentionSuggestions.appendChild(item);
                });
                return;
            }
        }
        
        mentionSuggestions.style.display = 'none';
    }

    function selectMention(name, lastAtIndex, cursorPosition) {
        const input = document.getElementById('msg-input');
        const currentText = input.value;
        
        const newText = currentText.substring(0, lastAtIndex) + `@${name} ` + currentText.substring(cursorPosition);
        
        input.value = newText;
        document.getElementById('mention-suggestions').style.display = 'none';
        
        const newCursorPos = lastAtIndex + name.length + 2;
        input.setSelectionRange(newCursorPos, newCursorPos);
        input.focus();
    }

    function mentionUser(name) {
        const input = document.getElementById('msg-input');
        const currentValue = input.value.trim();
        input.value = currentValue + (currentValue ? ' ' : '') + `@${name} `;
        input.focus();
    }
    
    // Clean up listeners when page unloads
    window.addEventListener('beforeunload', () => {
        if (realTimeListener) {
            realTimeListener();
        }
    });
</script>
</body>
</html>