<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Group Chat | Campus Point</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --bg-main: #050505; --bg-card: #0F0F10; 
            --accent: #4D6BF8; --text: #EDEDED; 
            --text-sec: #888; --border: #2A2A2E;
            --mine-bg: #4D6BF8; --mine-text: #fff;
        }
        [data-theme="light"] { 
            --bg-main: #F2F4F8; --bg-card: #FFF; 
            --accent: #304FFE; --text: #111; 
            --text-sec: #555; --border: #DDE1E6;
            --mine-bg: #304FFE; --mine-text: #fff;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html { height: 100%; }
        body { 
            font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text); 
            height: 100dvh; height: 100%; position: fixed; inset: 0; width: 100%;
            display:flex; flex-direction:column; overflow:hidden; 
        }

        /* --- HEADER --- */
        .chat-header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; gap: 12px;
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            flex-shrink: 0; z-index: 10; padding-top: env(safe-area-inset-top); 
        }
        .back-btn { 
            width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; color: var(--text); cursor: pointer;
        }
        .header-avatar {
            width: 38px; height: 38px; border-radius: 50%; background-size: cover; background-position: center;
            border: 1px solid var(--border);
        }
        .header-info { flex: 1; overflow: hidden; }
        .header-name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-status { font-size: 0.75rem; color: var(--text-sec); }

        /* --- MESSAGES CONTAINER --- */
        #messages {
            flex: 1; min-height: 0; overflow-y: auto; 
            padding: 20px 15px; 
            display: flex; flex-direction: column; gap: 4px; /* Reduced gap */
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: auto; /* Important for lazy loading scroll check */
            -webkit-overflow-scrolling: touch; 
        }

        /* --- CHAT BUBBLE STYLES --- */
        .msg-container { 
            display: flex; gap: 8px; max-width: 85%; align-items: flex-start; 
            align-self: flex-start; /* Default alignment for others */
            margin-top: 4px; 
        }
        .msg-container.mine { 
            align-self: flex-end; 
            flex-direction: row-reverse; 
        }
        
        .msg-avatar { 
            width: 24px; height: 24px; border-radius: 50%; background-size: cover; 
            flex-shrink: 0; margin-top: 4px; border: 1px solid var(--border);
            cursor: pointer;
        }
        
        .msg-content { max-width: 100%; }

        .msg-bubble {
            padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4;
            position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s; /* For swipe effect */
        }
        
        .msg-container.mine .msg-bubble {
            background: var(--mine-bg); color: var(--mine-text);
            border-bottom-right-radius: 4px;
        }
        
        .msg-container.theirs .msg-bubble {
            /* Unique color will be set by JS via style attribute */
            background: #1A1A1C; /* Default fallback */
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        
        .msg-sender {
            font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;
            /* Sender color will be set by JS */
        }

        .timestamp {
            font-size: 0.65rem; color: var(--text-sec); margin-top: 4px; opacity: 0.8; 
            text-align: right; 
            font-family: 'JetBrains Mono', monospace;
        }

        .msg-container.mine .timestamp {
            color: rgba(255,255,255,0.7);
        }

        /* --- REPLY BUBBLE STYLES --- */
        .reply-bubble {
            background: rgba(136, 136, 136, 0.2); 
            border-left: 3px solid var(--accent); 
            padding: 8px; border-radius: 8px; 
            margin-bottom: 6px;
            font-size: 0.85rem; line-height: 1.3;
            overflow: hidden;
            max-height: 60px; /* Max height to keep it concise */
        }

        .reply-sender {
            font-weight: 600; font-size: 0.8rem; color: var(--accent);
            display: block;
            margin-bottom: 2px;
        }

        .reply-text {
            color: var(--text-sec);
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;  
            overflow: hidden;
        }

        /* --- REPLY INPUT BAR --- */
        #reply-indicator {
            padding: 8px 15px; 
            background: var(--bg-card); 
            border-top: 1px solid var(--border); 
            display: none; /* Hidden by default */
        }
        #reply-content {
            border-left: 3px solid var(--accent);
            padding: 5px 10px;
            margin-right: 10px;
        }
        #reply-text-preview {
            font-size: 0.85rem; color: var(--text-sec);
            display: -webkit-box;
            -webkit-line-clamp: 1; 
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        #reply-close {
            color: var(--text-sec); font-size: 1.1rem; cursor: pointer;
        }

        /* --- INPUT --- */
        .input-area {
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            flex-shrink: 0; z-index: 20;
        }
        
        .input-wrapper {
            flex: 1; background: var(--bg-main); border-radius: 25px; 
            border: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px;
            min-height: 45px;
        }
        
        input { 
            flex: 1; height: 45px; border: none; background: transparent; 
            color: var(--text); outline: none; font-family: 'Inter'; font-size: 1rem; 
        }
        
        .send-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--accent); color: white; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 10px var(--accent-glow);
            flex-shrink: 0;
        }

        .empty-state { text-align: center; margin-top: 50px; color: var(--text-sec); font-size: 0.9rem; }
        
        /* --- MENTION SUGGESTIONS --- */
        #mention-suggestions {
            position: absolute;
            bottom: 60px; /* Adjust based on input area height */
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            z-index: 25;
            display: none;
        }
        .mention-item {
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .mention-item:hover {
            background: var(--border);
        }
        
        /* --- LAZY LOAD SPINNER --- */
        .lazy-load-spinner {
            text-align: center; 
            padding: 10px;
            margin-top: 10px;
            color: var(--text-sec);
        }
    </style>
</head>
<body>

    <div class="chat-header">
        <div class="back-btn" onclick="window.location.href='index.html#groups'">
            <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div id="header-avatar" class="header-avatar" style="font-size:1.5rem; display:flex; align-items:center; justify-content:center;">
            <i class="fa-solid fa-users"></i>
        </div>
        <div class="header-info">
            <div class="header-name" id="chat-title">Group Chat</div>
            <div class="header-status" id="member-count">0 members</div>
        </div>
    </div>

    <div id="messages">
        <div class="lazy-load-spinner hidden" id="lazy-spinner">
            <i class="fa-solid fa-spinner fa-spin"></i> Loading previous messages...
        </div>
        <div class="empty-state" id="empty-state">No messages yet. Say hello! ðŸ‘‹</div>
    </div>
    
    <div id="mention-suggestions"></div>

    <div id="reply-indicator" class="h-flex">
        <div id="reply-content" style="flex-grow: 1;">
            <div id="reply-sender-preview" style="font-weight: 600; font-size: 0.8rem; color: var(--accent);"></div>
            <div id="reply-text-preview"></div>
        </div>
        <i class="fa-solid fa-xmark" id="reply-close" onclick="cancelReply()"></i>
    </div>

    <div class="input-area">
        <div class="input-wrapper">
            <input type="text" id="msg-input" placeholder="Message..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendGroupMsg()">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBg1m_bFN4xzl4yJ_JiG8E6UPDZjFks7PM",
            authDomain: "campus-point-rst.firebaseapp.com",
            projectId: "campus-point-rst",
            storageBucket: "campus-point-rst.firebasestorage.app",
            messagingSenderId: "877074516750",
            appId: "1:877074516750:web:f485c45a1446c030afa55f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let groupName = new URLSearchParams(window.location.search).get('group');
        let currentUser;
        let members = {}; // Stores {uid: {name, color}}
        let spamTimer = null;
        let lastMessageTimestamp = 0;
        let replyToMessageId = null;
        let lastVisible = null; // For lazy loading
        let isLoading = false; // <-- Add this global variable above initGroupChat()

        // Hashing function to get a unique color for a user ID
        function getUniqueColor(uid) {
            let hash = 0;
            for (let i = 0; i < uid.length; i++) {
                hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            // Ensure color is distinguishable on a dark/light background
            let r = parseInt(color.substring(1,3), 16);
            let g = parseInt(color.substring(3,5), 16);
            let b = parseInt(color.substring(5,7), 16);
            
            // Adjust to ensure brightness (avoiding black/gray on dark theme)
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            if (brightness < 100) { // If too dark, increase brightness
                r = Math.min(255, r + 100);
                g = Math.min(255, g + 100);
                b = Math.min(255, b + 100);
                color = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return color;
        }

        // --- INIT ---
        auth.onAuthStateChanged(user => {
            if(!user) window.location.href = 'index.html';
            currentUser = user;
            
            // Initialize user data in members list to ensure current user has a color
            members[currentUser.uid] = { 
                name: currentUser.displayName, 
                color: getUniqueColor(currentUser.uid) 
            };
            
            initGroupChat();
        });

        async function initGroupChat() {
            if(!groupName) {
                alert("Invalid group name.");
                window.location.href = 'index.html#groups';
                return;
            }

            document.getElementById('chat-title').innerText = `#${groupName} Lounge`;
            
            // Ensure group document exists and update member count
            const groupRef = db.collection('groups').doc(groupName);
            await groupRef.set({
                name: groupName,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // Set up listener for members (for color/name mapping)
            groupRef.collection('members').onSnapshot(snap => {
                snap.forEach(doc => {
                    const memberData = doc.data();
                    const uid = doc.id;
                    members[uid] = {
                        name: memberData.name || "Anon",
                        color: getUniqueColor(uid)
                    };
                });
                document.getElementById('member-count').innerText = `${snap.size} members`;
            });

            // Add current user to members list
            groupRef.collection('members').doc(currentUser.uid).set({
                name: currentUser.displayName,
                photo: currentUser.photoURL,
                joined: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // Start message loading - first batch
            await loadMessages(false);

            // Start real-time listener for NEW messages only
            startNewMessageListener();
            
            // Set up lazy load scroll detection
            document.getElementById('messages').addEventListener('scroll', checkLazyLoad);

            // Set up message input keypress for mentions
            document.getElementById('msg-input').addEventListener('input', checkMention);
        }

        // --- MESSAGE LOADING (LAZY LOAD) ---
        // --- MESSAGE LOADING (LAZY LOAD) ---
        const PAGE_SIZE = 15; // Number of messages to load per batch

        async function loadMessages(isLazyLoad = false) {
            const container = document.getElementById('messages');
            const spinner = document.getElementById('lazy-spinner');
            
            // 1. Only show the spinner if we are doing a lazy load
            if (isLazyLoad) {
                spinner.classList.remove('hidden');
            }
            
            let query = db.collection('groups').doc(groupName).collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(PAGE_SIZE);

            if (isLazyLoad && lastVisible) {
                query = query.startAfter(lastVisible);
            }

            try {
                const snapshot = await query.get();
                
                // 2. Hide spinner once data is fetched (relevant for lazy load)
                spinner.classList.add('hidden');
                
                if (snapshot.empty) {
                    if (isLazyLoad) {
                        // If this was a lazy load request and it returned nothing, we hit the end.
                        spinner.innerHTML = "End of history.";
                        spinner.style.color = 'var(--accent)';
                        spinner.classList.remove('hidden'); // Keep "End of history" visible
                    }
                    // If it's an initial load (and empty), show the empty state message.
                    document.getElementById('empty-state').style.display = container.children.length > 2 ? 'none' : 'block';
                    return;
                }

                document.getElementById('empty-state').style.display = 'none';

                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                const messagesFragment = document.createDocumentFragment();
                let firstMessageElement;

                snapshot.docs.reverse().forEach(doc => {
                    const el = renderGroupMsg(doc);
                    messagesFragment.appendChild(el);
                    if (!firstMessageElement) firstMessageElement = el;
                });
                
                // Prepend to container for lazy load
                // Note: The spinner element is children[0], so we insert after it.
                container.insertBefore(messagesFragment, container.children[1]); 

                // Scroll logic
                if (isLazyLoad && firstMessageElement) {
                    // Lazy load: Scroll to maintain position
                    container.scrollTop = firstMessageElement.offsetTop - 50;
                } else if (!isLazyLoad) {
                    // Initial load: scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }

            } catch (error) {
                console.error("Error loading messages: ", error);
                spinner.innerHTML = "Error loading messages.";
                spinner.classList.remove('hidden');
            }
        }

        function checkLazyLoad() {
            const container = document.getElementById('messages');
            // Load more when scroll is near the top AND we are not already loading
            if (container.scrollTop < 50 && lastVisible && !isLoading) {
                isLoading = true; // Set flag to prevent immediate re-trigger
                loadMessages(true).finally(() => {
                    isLoading = false; // Reset flag after loading finishes (success or fail)
                });
            }
        }

        function startNewMessageListener() {
            // Listen for new messages added since the initial load
            db.collection('groups').doc(groupName).collection('messages')
                .where('timestamp', '>', firebase.firestore.Timestamp.fromMillis(Date.now() - 5000)) // Fetch recent messages
                .orderBy('timestamp', 'asc')
                .limit(1) // Only look for the latest message
                .onSnapshot(snap => {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added' && change.doc.data().timestamp.toMillis() > lastMessageTimestamp) {
                            // Check if the message is already in the main container (lazy load)
                            if (!document.getElementById(`msg-${change.doc.id}`)) {
                                const container = document.getElementById('messages');
                                container.appendChild(renderGroupMsg(change.doc));
                                container.scrollTop = container.scrollHeight; // Scroll down for new messages
                            }
                            lastMessageTimestamp = change.doc.data().timestamp.toMillis();
                        }
                    });
                });
        }

        // --- SENDING & ANTI-SPAM ---
        function sendGroupMsg() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            const sendButton = document.querySelector('.send-btn');
            
            if(!text) return;
            
            // 1. Anti-spam Check: Limit to 1 message every 3 seconds
            const now = Date.now();
            if (now - lastMessageTimestamp < 3000) {
                if (!spamTimer) {
                    sendButton.disabled = true;
                    sendButton.style.opacity = 0.5;
                    sendButton.innerHTML = `<i class="fa-solid fa-hourglass-start"></i>`;
                    spamTimer = setTimeout(() => {
                        sendButton.disabled = false;
                        sendButton.style.opacity = 1;
                        sendButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i>`;
                        spamTimer = null;
                    }, 3000);
                }
                alert("Please wait 3 seconds between messages to reduce spam.");
                return;
            }
            
            const messageData = {
                text: text,
                senderId: currentUser.uid,
                senderName: currentUser.displayName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add reply data if present
            if (replyToMessageId) {
                const replyEl = document.getElementById(replyToMessageId);
                if (replyEl) {
                    messageData.replyTo = {
                        id: replyToMessageId,
                        text: replyEl.querySelector('.msg-bubble').textContent.trim().substring(0, 100) + '...', // Short preview
                        senderName: replyEl.querySelector('.msg-sender')?.textContent || 'Original User'
                    };
                }
            }
            
            db.collection('groups').doc(groupName).collection('messages').add(messageData)
                .then(() => {
                    input.value = '';
                    cancelReply();
                    lastMessageTimestamp = now; 
                    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                })
                .catch(e => alert("Error sending message: " + e.message));
        }

        // --- UI RENDERING ---
        function renderGroupMsg(doc) {
            const d = doc.data();
            const isMine = d.senderId === currentUser.uid;
            const uid = d.senderId;
            const member = members[uid] || { name: d.senderName || "Unknown", color: getUniqueColor(uid) };
            
            let time = '';
            if(d.timestamp) {
                const date = d.timestamp.toDate();
                // Format: HH:MM AM/PM - DD/MM
                const timePart = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const datePart = date.toLocaleDateString([], { month: 'numeric', day: 'numeric' });
                time = `${timePart} | ${datePart}`;
            }

            const container = document.createElement('div');
            container.className = `msg-container ${isMine ? 'mine' : 'theirs'}`;
            container.id = `msg-${doc.id}`; // Add ID for replies
            container.setAttribute('data-sender-name', d.senderName); // For mention/reply quick access
            
            // Add swipe event listener for reply
            container.addEventListener('touchstart', handleTouchStart);
            container.addEventListener('touchmove', handleTouchMove);
            container.addEventListener('touchend', handleTouchEnd);
            
            // Reply structure
            let replyHTML = '';
            if (d.replyTo) {
                replyHTML = `
                    <div class="reply-bubble" onclick="scrollToReply('${d.replyTo.id}')">
                        <span class="reply-sender">${d.replyTo.senderName}</span>
                        <div class="reply-text">${d.replyTo.text}</div>
                    </div>
                `;
            }

            // Replace mentions with HTML
            const textWithMentions = d.text.replace(/@(\w+)/g, (match, username) => {
                const mentionedUid = Object.keys(members).find(key => members[key].name === username);
                const mentionColor = mentionedUid ? members[mentionedUid].color : 'var(--text)';
                return `<span style="color:${mentionColor}; font-weight: 600;">${match}</span>`;
            });

            container.innerHTML = `
                <div class="msg-avatar" style="background-image: url('${member.photo || ''}')" onclick="mentionUser('${d.senderName}')"></div>
                <div class="msg-content">
                    ${!isMine ? `<div class="msg-sender" style="color: ${member.color};">${member.name}</div>` : ''}
                    ${replyHTML}
                    <div class="msg-bubble" style="${!isMine ? `background-color: ${member.color}15; border: 1px solid ${member.color}50;` : ''}">
                        ${textWithMentions}
                        <div class="timestamp">${time}</div>
                    </div>
                </div>
            `;
            return container;
        }
        
        // --- REPLY FUNCTIONALITY ---
        function startReply(messageId) {
            const messageEl = document.getElementById(messageId);
            const senderName = messageEl.getAttribute('data-sender-name');
            const messageText = messageEl.querySelector('.msg-bubble').textContent.trim();

            replyToMessageId = messageId;
            document.getElementById('reply-sender-preview').innerText = `Replying to ${senderName}`;
            document.getElementById('reply-text-preview').innerText = messageText;
            document.getElementById('reply-indicator').style.display = 'flex';
            document.getElementById('msg-input').focus();
        }

        function cancelReply() {
            replyToMessageId = null;
            document.getElementById('reply-indicator').style.display = 'none';
        }

        function scrollToReply(messageId) {
            const target = document.getElementById(messageId);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.style.transform = 'scale(1.03)';
                setTimeout(() => {
                    target.style.transform = 'scale(1)';
                }, 500);
            }
        }
        
        // --- SWIPE FOR REPLY (Touch Implementation) ---
        let initialX;
        let currentElement = null;

        function handleTouchStart(e) {
            initialX = e.touches[0].clientX;
            currentElement = e.currentTarget.querySelector('.msg-bubble');
        }

        function handleTouchMove(e) {
            if (!initialX || !currentElement) return;

            const currentX = e.touches[0].clientX;
            const diffX = currentX - initialX;
            const threshold = 50; 
            
            // Right swipe only
            if (diffX > 0) {
                currentElement.style.transform = `translateX(${Math.min(diffX, 50)}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!initialX || !currentElement) return;

            const currentX = e.changedTouches[0].clientX;
            const diffX = currentX - initialX;
            const threshold = 50;

            if (diffX > threshold) {
                startReply(currentElement.closest('.msg-container').id);
            }

            // Snap back
            currentElement.style.transform = 'translateX(0)';
            initialX = null;
            currentElement = null;
        }

        // --- MENTION FUNCTIONALITY ---
        function checkMention(e) {
            const input = e.target;
            const text = input.value;
            const cursorPosition = input.selectionStart;
            const mentionSuggestions = document.getElementById('mention-suggestions');
            
            // Find the word being typed backwards from the cursor
            const preText = text.substring(0, cursorPosition);
            const lastAtIndex = preText.lastIndexOf('@');
            
            mentionSuggestions.innerHTML = '';
            
            if (lastAtIndex > -1) {
                const searchTerm = preText.substring(lastAtIndex + 1);
                
                // Get list of members (excluding self)
                const memberList = Object.keys(members)
                    .filter(uid => uid !== currentUser.uid)
                    .map(uid => members[uid].name);

                const matches = memberList.filter(name => 
                    name.toLowerCase().startsWith(searchTerm.toLowerCase())
                );
                
                if (matches.length > 0) {
                    mentionSuggestions.style.display = 'block';
                    matches.forEach(name => {
                        const item = document.createElement('div');
                        item.className = 'mention-item';
                        item.innerText = name;
                        item.onclick = () => selectMention(name, lastAtIndex, cursorPosition);
                        mentionSuggestions.appendChild(item);
                    });
                    return;
                }
            }
            
            mentionSuggestions.style.display = 'none';
        }

        function selectMention(name, lastAtIndex, cursorPosition) {
            const input = document.getElementById('msg-input');
            const currentText = input.value;
            
            // Construct the new text: (Text before @) + (@Name) + (Text after cursor)
            const newText = currentText.substring(0, lastAtIndex) + `@${name}` + currentText.substring(cursorPosition);
            
            input.value = newText;
            document.getElementById('mention-suggestions').style.display = 'none';
            
            // Set cursor to end of the new mention
            const newCursorPos = lastAtIndex + 1 + name.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
            input.focus();
        }

        function mentionUser(name) {
            const input = document.getElementById('msg-input');
            input.value = input.value.trim() + ` @${name}`;
            input.focus();
        }
    </script>
</body>
</html>