<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#050505">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-title" content="CampusPoint">

<link rel="apple-touch-icon" href="https://ik.imagekit.io/rstofficial/CAMPUS.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campus Point</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    


    <style>
        :root {
            /* --- ORIGINAL DESIGN VARIABLES --- */
            --bg-main: #050505;
            --bg-glass: rgba(20, 20, 21, 0.98);
            --bg-card: #0F0F10;
            --bg-input: #1A1A1C;
            --border: #2A2A2E;
            --text-primary: #EDEDED;
            --text-secondary: #888888;
            --accent: #008cff;
            --accent-backup: #4dabf8;
            --accent-glow: rgba(77, 107, 248, 0.4);
            --boost-color: #FFD700;
            --header-h: 60px;
            --nav-h: 70px;
        }

        [data-theme="light"] {
            --bg-main: #F2F4F8;
            --bg-glass: rgba(255, 255, 255, 0.98);
            --bg-card: #FFFFFF;
            --bg-input: #EAECEF;
            --border: #DDE1E6;
            --text-primary: #111111;
            --text-secondary: #555555;
            --accent: #304FFE;
            --accent-glow: rgba(48, 79, 254, 0.2);
            --boost-color: #F9A825;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow-y: auto;
            min-height: 100vh;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }

        /* Allow selection in input fields so users can still type! */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        .app-container {
            width: 100%; max-width: 480px; margin: 0 auto;
            min-height: 100vh; position: relative; padding-bottom: 80px;
        }

        /* --- Header --- */
        .header {
            height: var(--header-h); padding: 0 20px;
            background: var(--bg-glass); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            position: fixed; top: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; z-index: 1000;
        }

        /* --- Content Sections --- */
        .content-area {
            padding-top: calc(var(--header-h) + 20px);
            padding-left: 20px; padding-right: 20px;
        }
        .hidden { display: none !important; }

        /* --- Forms & Inputs --- */
        .nexus-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            padding: 14px; border-radius: 8px; color: var(--text-primary);
            font-family: 'Inter', sans-serif; margin-bottom: 15px; outline: none;
            transition: border-color 0.3s;
        }
        .nexus-input:focus { border-color: var(--accent); }
        
        label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }

        .auth-btn, .action-btn {
            background: var(--accent); color: #FFFFFF; border: none; padding: 14px 25px;
            border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px var(--accent-glow); margin-top: 10px;
        }
        .action-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- LOGIN HERO IMAGE STYLES --- */
.hero-illustration {
    width: 100%; /* Adjust size as needed */
    height: auto;
    margin-bottom: 10px;
    /* Adds a cool glow matching your accent color */ 
    animation: floatHero 4s ease-in-out infinite;
}

@keyframes floatHero {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

/* --- PINTEREST-STYLE AUTH SCREEN --- */
#auth-overlay {
    background-color: #000000 !important; /* Pitch black background */
    padding: 40px 25px;
    display: flex !important;
    flex-direction: column;
    justify-content: space-between; /* Pushes footer to bottom */
    align-items: center;
    z-index: 9999; /* Ensure it's on top */
}

#auth-overlay.hidden {
    display: none !important;
}

/* Center Content Area */
.auth-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 360px; /* Mobile width */
}

/* Logo Area */
.auth-logo-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 20px;
}

/* Headline: "Create a life you love" style */
.auth-headline {
    font-size: 2rem;
    font-weight: 600;
    color: #ffffff;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
}

.auth-subhead {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 40px;
    text-align: center;
}

/* Pinterest-style Google Button (Dark with outline) */
.pinterest-google-btn {
    width: 100%;
    background-color: transparent;
    border: 1px solid #3f3f3f;
    border-radius: 50px; /* Full pill shape */
    padding: 14px 20px;
    color: #ffffff;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    margin-bottom: 20px;
}

.pinterest-google-btn:active {
    background-color: #1a1a1a;
    transform: scale(0.98);
    border-color: #666;
}

/* Bottom Legal Text */
.auth-footer {
    width: 100%;
    max-width: 300px;
    text-align: center;
    font-size: 0.75rem;
    color: #777;
    line-height: 1.5;
    padding-bottom: 10px;
}

.auth-footer a {
    color: #fff;
    text-decoration: none;
    font-weight: 500;
}
        
        .secondary-btn {
            background: transparent; color: var(--text-primary); border: 1px solid var(--border);
            padding: 8px 20px; border-radius: 50px; font-size: 0.85rem; cursor: pointer; margin-top: 10px;
        }

        .secondary-btn2 {
            background: transparent; color: var(--text-primary); border: 1px solid var(--border); padding: 14px 25px;
            border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px var(--accent-glow); margin-top: 10px;
        
        }

        /* --- Cards --- */
        .post-card, .chat-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 18px; margin-bottom: 15px;
        }
        
        /* --- FEED IMAGE STYLES --- */
.feed-post-img {
    width: 100%;
    display: block;
    margin-top: 0px;
    border-radius: 8px;
    border: 1px solid var(--border);
    
    /* 1. KEY: Crop content that exceeds dimensions without stretching */
    object-fit: cover; 
    
    /* 2. Default to natural height so square/standard images look normal */
    height: auto;

    /* 3. "Max 4:3 ratio in portrait" 
       On a mobile screen (~400px width), a 550px height acts as a 3:4 limit. 
       Anything taller gets cropped. */
    max-height: 550px; 

    /* 4. "Lowest size 16:9 ratio"
       On a mobile screen, 225px is roughly the 16:9 height.
       This forces thin panoramas to be taller and cropped to fill the space. */
    min-height: 225px; 
}

        .chat-item { display: flex; align-items: center; cursor: pointer; }
        .chat-item:hover { border-color: var(--accent); }

        .post-actions {
            display: flex; gap: 20px; margin-top: 15px; padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .action-item {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            font-size: 0.9rem; color: var(--text-secondary); transition: 0.2s;
        }
        
        .action-item.boosted { color: var(--boost-color); }
        .action-item:hover { color: var(--text-primary); }

        .discussion-area {
            margin-top: 15px; background: var(--bg-input); 
            border-radius: 8px; padding: 10px; display: none;
        }
        .discussion-area.show { display: block; }
        
        .comment-item {
            font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid var(--border);
        }
        .comment-item:last-child { border-bottom: none; }

        /* --- Nav --- */
        .bottom-nav {
            height: var(--nav-h); background: var(--bg-glass);
            backdrop-filter: blur(12px); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; z-index: 1000;
        }
        .nav-item { font-size: 1.3rem; color: var(--text-secondary); cursor: pointer; padding: 10px; }
        .nav-item.active { color: var(--accent); }
        
        /* --- Floating Action Button (FAB) --- */
        .floating-fab {
            position: fixed; bottom: 90px; right: 20px;
            width: 56px; height: 56px; background: var(--accent); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 20px var(--accent-glow);
            z-index: 1100; cursor: pointer; transition: transform 0.2s;
        }
        .floating-fab:active { transform: scale(0.9); }

        /* --- Radar UI --- */
        .radar-view { height: 40vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; }
        .radar-circle { width: 220px; height: 220px; border: 1px solid var(--border); border-radius: 50%; position: relative; background: radial-gradient(circle, transparent 30%, var(--bg-card) 100%); }
        .radar-sweep { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(transparent 270deg, var(--accent-glow)); animation: radarSpin 3s linear infinite; }
        
        .radar-blip { 
            width: 12px; height: 12px; background: var(--accent); border-radius: 50%; 
            position: absolute; box-shadow: 0 0 8px var(--accent); cursor: pointer; 
            z-index: 2; animation: pulse 2s infinite; transition: transform 0.2s;
        }
        .radar-blip:hover { transform: scale(1.5); background: #fff; }

        .blip-tooltip {
            position: absolute; background: var(--bg-card); border: 1px solid var(--border);
            padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; pointer-events: none;
            white-space: nowrap; z-index: 10; transform: translate(-50%, -150%);
        }

        .user-list-item {
            display: flex; align-items: center; background: var(--bg-card);
            border: 1px solid var(--border); padding: 12px; margin-bottom: 10px;
            border-radius: 10px; cursor: pointer;
        }

        /* --- Profile Stats --- */
        .stats-row { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-box { text-align: center; }

        /* --- Utils --- */
        .h-flex { display: flex; align-items: center; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .avatar { width: 40px; height: 40px; border-radius: 10px; background-size: cover; margin-right: 12px; border: 1px solid var(--border); flex-shrink: 0; }
        .goal-tag { font-size: 0.7rem; padding: 4px 8px; background: var(--accent-glow); color: var(--accent); border-radius: 6px; border: 1px solid var(--accent); margin-left: auto; }
        
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-main); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @keyframes radarSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- NEW STYLES FOR BIO & HOBBIES --- */
.bio-text { 
    font-size: 0.9rem; line-height: 1.5; color: var(--text-secondary); 
    margin: 10px auto; max-width: 300px; font-style: italic;
}
.future-goal-display { 
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent); 
    margin-bottom: 15px; padding: 8px; border: 1px dashed var(--accent); 
    border-radius: 8px; display: inline-block;
}
/* Tinder-like Chips */
.interests-container { 
    display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; 
}
.interest-chip { 
    padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; 
    border: 1px solid var(--border); color: var(--text-secondary); 
    cursor: pointer; transition: all 0.2s; background: var(--bg-card);
}
.interest-chip.selected { 
    background: var(--accent); color: white; border-color: var(--accent); 
    box-shadow: 0 0 10px var(--accent-glow); transform: scale(1.05);
}
/* Hide unselected chips when viewing a profile */
.interest-chip.display-only { cursor: default; pointer-events: none; }

/* --- INSTALL MODAL STYLES --- */
#install-modal {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    padding: 25px 20px;
    z-index: 5000;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
    display: none; /* Hidden by default */
    flex-direction: column;
    align-items: center;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.install-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 15px;
    background: rgba(77, 107, 248, 0.1);
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
}

.install-title {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.install-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 25px;
    line-height: 1.5;
}

.install-buttons {
    display: flex;
    width: 100%;
    gap: 15px;
}

/* --- POST MENU STYLES --- */
.post-header-right {
    position: relative; 
    margin-left: auto; /* Pushes menu to the far right */
}

.menu-trigger {
    padding: 5px 10px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    width: 160px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    display: none; /* Hidden by default */
    z-index: 100;
    overflow: hidden;
}

.dropdown-menu.show {
    display: block;
    animation: fadeIn 0.2s ease;
}

.dropdown-item {
    padding: 12px 15px;
    font-size: 0.85rem;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
    border-bottom: 1px solid var(--border);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item:hover {
    background: var(--bg-input);
}

.dropdown-item.danger {
    color: #ff5555;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- LOADING SPINNER --- */
.loader-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin { 
    to { transform: rotate(360deg); } 
}

/* --- STORY TRAY STYLES --- */
.stories-wrapper {
    /* 1. Layout & Scroll */
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    scrollbar-width: none; /* Firefox */
    
    /* 2. "Post Card" Styling */
    background: var(--bg-card);
    border: 1px solid var(--border); /* Full border all around */
    border-radius: 12px;             /* Rounded corners like posts */
    margin-bottom: 15px;             /* Space between stories and first post */
    
    /* 3. Internal Padding */
    padding: 15px 0;                 /* Vertical spacing inside the card */
}

/* Hide scrollbar for Chrome/Safari */
.stories-wrapper::-webkit-scrollbar { display: none; }

.story-tray {
    display: inline-flex;
    padding: 0 15px;
    gap: 15px;
}

.story-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    width: 70px;
}

/* The Gradient Ring Container */
.story-ring-container {
    width: 68px;
    height: 68px;
    border-radius: 50%;
    padding: 2px; /* Thickness of the gap */
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Unseen Story Gradient (Instagram colors) */
.story-ring-container.unseen {
    background-backup: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    background: linear-gradient(45deg, #f09433 0%, #e6d83c 25%, #4edc27 50%, #23a7cc 75%, #185cbc 100%);
}

/* Seen Story (Gray) */
.story-ring-container.seen {
    background: #555;
}

/* No Story (Transparent/Border only) */
.story-ring-container.none {
    background: transparent;
    border: 1px solid var(--border);
    padding: 0;
}

/* The actual profile picture */
.story-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid var(--bg-card); /* Gap color matching background */
}

/* The "Add" (+) badge for current user */
.add-story-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    background: var(--accent);
    border: 2px solid var(--bg-card);
    border-radius: 50%;
    color: white;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.story-username {
    font-size: 0.75rem;
    margin-top: 5px;
    width: 100%;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-primary);
}

/* --- FULL SCREEN STORY VIEWER --- */
#story-viewer-modal {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    display: none;
    flex-direction: column;
}

/* Progress Bars at top */
.story-progress-container {
    display: flex;
    gap: 5px;
    padding: 10px 10px;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 10;
}
.story-progress-bar {
    height: 3px;
    background: rgba(255,255,255,0.3);
    flex: 1;
    border-radius: 2px;
    overflow: hidden;
}
.story-progress-fill {
    height: 100%;
    background: #fff;
    width: 0%; 
    /* transition: width 5s linear; <-- Will be handled via JS */
}

.story-header-overlay {
    position: absolute;
    top: 25px;
    left: 15px;
    right: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
    color: white;
}

.story-image-view {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Show full image */
}

/* --- CUSTOM STORY OPTIONS MODAL --- */
#story-options-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6); /* Dimmed background */
    z-index: 10000;
    display: none; /* Hidden by default */
    align-items: flex-end; /* Align to bottom */
    justify-content: center;
}

#story-options-modal.flex {
    display: flex !important;
}

.story-options-sheet {
    background: var(--bg-card);
    width: 100%;
    max-width: 480px;
    border-radius: 20px 20px 0 0;
    border-top: 1px solid var(--border);
    padding: 10px 0;
    animation: slideUp 0.2s ease-out;
}

/* The buttons inside the sheet */
.story-opt-btn {
    width: 100%;
    padding: 18px 25px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text-primary);
    font-size: 1rem;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: 'Inter', sans-serif;
}

.story-opt-btn:active {
    background: var(--bg-input);
}

.story-opt-btn:last-child {
    border-bottom: none;
}

.story-opt-btn i {
    font-size: 1.2rem;
    width: 25px;
    text-align: center;
}

/* --- EDIT PROFILE PIC STYLES --- */
.edit-pic-wrapper {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 25px auto;
    cursor: pointer;
}

.edit-pic-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
}

.edit-pic-badge {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 30px;
    height: 30px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border: 2px solid var(--bg-card);
    font-size: 0.9rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* --- CROPPER MODAL STYLES --- */
#cropper-modal {
    position: fixed;
    inset: 0;
    background: #000000;
    z-index: 9999;
    display: none; /* Hidden by default */
    flex-direction: column;
}

.cropper-container-wrapper {
    flex: 1;
    background: #111;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* Ensure image fits max area */
#cropper-target-img {
    display: block;
    max-width: 100%;
}

.cropper-toolbar {
    height: 80px;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 20px;
}

.crop-btn {
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 1.2rem;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    cursor: pointer;
}

.crop-btn i { font-size: 1.4rem; }
.crop-btn.save { color: var(--accent); }
.crop-btn.cancel { color: #ff5555; }

/* --- BANNER & PROFILE HEADER STYLES --- */
.profile-header-wrapper {
    position: relative;
    margin-bottom: 60px; /* Space for the overlapping profile pic */
}

.banner-img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    background-color: var(--bg-card);
    border-radius: 0 0 16px 16px; /* Rounded bottom corners */
    border-bottom: 1px solid var(--border);
}

/* Position the Profile Picture (Circle) to overlap the banner */
.profile-pic-overlap {
    position: absolute;
    bottom: -50px; /* Half of height to overlap */
    left: 50%;
    transform: translateX(-50%);
    width: 110px;
    height: 110px;
    border-radius: 50%;
    border: 4px solid var(--bg-main); /* Creates a "cutout" effect */
    background-color: var(--bg-main);
    z-index: 2;
}

/* --- BANNER PICKER MODAL --- */
#banner-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    display: none;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
}

.banner-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 Columns */
    gap: 15px;
    margin-top: 20px;
}

.banner-option {
    width: 100%;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.banner-option:hover, .banner-option.selected {
    border-color: var(--accent);
    transform: scale(1.02);
}

/* --- UPLOAD PROGRESS MODAL --- */
#upload-progress-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 12000; /* Highest priority */
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.upload-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 30px;
    border-radius: 20px;
    width: 80%;
    max-width: 300px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.upload-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--bg-input);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    margin: 0 auto 20px auto;
    animation: spin 1s linear infinite;
}

.progress-track {
    width: 100%;
    height: 6px;
    background: var(--bg-input);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 15px;
}

.progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px var(--accent-glow);
}

.upload-status-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.upload-subtext {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* --- NOTIFICATIONS STYLES --- */
.header-icon-btn {
    position: relative;
    margin-right: 20px;
    cursor: pointer;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
}

.notif-badge {
    position: absolute;
    top: 0px;
    right: -2px;
    width: 9px;
    height: 9px;
    background: #ff5555;
    border-radius: 50%;
    display: none; /* Hidden by default */
    border: 1px solid var(--bg-glass);
}

.notif-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    background: var(--bg-card);
}

.notif-item:active {
    background: var(--bg-input);
}

.notif-content {
    margin-left: 12px;
    flex: 1;
}

.notif-text {
    font-size: 0.9rem;
    color: var(--text-primary);
    line-height: 1.4;
}

.notif-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* --- STORY VIEWS STYLES --- */
#sv-views-btn {
    position: absolute;
    bottom: 20px;
    left: 20px;
    color: white;
    z-index: 10;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 12px;
    border-radius: 20px;
    backdrop-filter: blur(4px);
    display: none; /* Hidden by default */
    font-size: 0.9rem;
    align-items: center;
    gap: 6px;
}

/* --- VIEWER LIST MODAL (Bottom Sheet) --- */
#views-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 11000; /* Above story viewer */
    display: none;
    align-items: flex-end; /* Bottom sheet style */
}

.views-sheet {
    background: var(--bg-card);
    width: 100%;
    height: 60vh; /* Takes up 60% of screen */
    border-radius: 20px 20px 0 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease-out;
}

.views-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    padding-bottom: 15px;
    margin-bottom: 10px;
}

.views-list {
    flex: 1;
    overflow-y: auto;
}

/* --- THEME MODAL STYLES --- */
#theme-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 12000;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.theme-card {
    background: var(--bg-card);
    width: 90%;
    max-width: 320px;
    border-radius: 16px;
    padding: 20px;
    border: 1px solid var(--border);
    animation: scaleIn 0.2s ease-out;
}

.theme-title {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    margin-bottom: 20px;
    font-size: 1.1rem;
    color: var(--text-primary);
}

.theme-option {
    display: flex;
    align-items: center;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
}

.theme-option:hover {
    background: var(--bg-input);
}

.theme-option.active {
    border-color: var(--accent);
    background: rgba(77, 107, 248, 0.1); /* Subtle accent tint */
}

.theme-option i {
    font-size: 1.2rem;
    width: 30px;
    color: var(--text-secondary);
}

.theme-option.active i {
    color: var(--accent);
}

@keyframes scaleIn {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* --- STORY EDITOR MODAL --- */
#story-editor-modal {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 11000;
    display: none;
    flex-direction: column;
}

.story-canvas-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #111;
    overflow: hidden;
}

.story-toolbar-top {
    height: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 10;
}

.story-toolbar-bottom {
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: space-around;
    background: #000;
    z-index: 10;
}

.editor-btn {
    color: white;
    font-size: 1.5rem;
    background: rgba(255,255,255,0.1);
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
}

.sticker-tray {
    position: absolute;
    bottom: 80px;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.9);
    padding: 10px;
    display: flex;
    gap: 15px;
    overflow-x: auto;
    display: none; /* Hidden by default */
}

.sticker-option {
    font-size: 2rem;
    cursor: pointer;
}

/* Font Styles for Story Text */
.font-classic { font-family: 'Inter', sans-serif; font-weight: 700; }
.font-mono { font-family: 'JetBrains Mono', monospace; }
.font-cursive { font-family: 'cursive'; font-style: italic; }
.font-serif { font-family: 'serif'; font-weight: bold; }

/* --- STORY EDITOR EXTRA TOOLS --- */

/* Font Picker Tray */
.font-tray {
    position: absolute;
    bottom: 80px;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.9);
    padding: 15px;
    display: none; /* Hidden by default */
    gap: 15px;
    overflow-x: auto;
    z-index: 20;
}

.font-option {
    color: white;
    font-size: 1.2rem;
    padding: 5px 15px;
    border: 1px solid #444;
    border-radius: 20px;
    white-space: nowrap;
    cursor: pointer;
}

.font-option.selected {
    background: var(--accent);
    border-color: var(--accent);
}

/* Text Edit Modal (Dialog) */
#text-edit-dialog, #mention-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 12000;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.edit-card {
    background: var(--bg-card);
    width: 90%;
    max-width: 350px;
    padding: 20px;
    border-radius: 15px;
    border: 1px solid var(--border);
}

/* User Search List */
.search-results {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
}

.search-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
}

.search-item:hover { background: var(--bg-input); }

/* --- NOTIFICATION POST PREVIEW --- */
.notif-post-thumb {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    margin-left: 10px;
    object-fit: cover;
    background: var(--bg-input);
    border: 1px solid var(--border);
    flex-shrink: 0; /* Prevent shrinking on small screens */
}

/* Style for Text-Only Placeholder */
.notif-post-thumb.placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    font-size: 1.2rem;
}

/* --- DISCUSSION ROOM STYLES --- */
#section-discussion-room {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--bg-main);
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 2000;
}

.room-header {
    height: 60px;
    display: flex;
    align-items: center;
    padding: 0 15px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-glass);
    backdrop-filter: blur(10px);
}

.room-scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.room-footer {
    padding: 15px;
    border-top: 1px solid var(--border);
    background: var(--bg-card);
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Specific Comment Styles */
.room-comment-bubble {
    background: var(--bg-input);
    padding: 12px;
    border-radius: 12px;
    border-bottom-left-radius: 2px;
    border: 1px solid var(--border);
}

.preview-comment-item {
    padding: 10px;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
    color: var(--text-secondary);
}
.preview-comment-item strong {
    color: var(--text-primary);
    margin-right: 5px;
}

/* --- MULTI-IMAGE CAROUSEL (FEED) --- */
.post-carousel {
    position: relative;
    width: 100%;
    margin-top: 10px;
}

.carousel-track {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none; /* Firefox */
    border-radius: 8px;
    border: 1px solid var(--border);
}

.carousel-track::-webkit-scrollbar { display: none; }

.carousel-slide {
    min-width: 100%;
    scroll-snap-align: center;
    position: relative;
}

/* Updated Image Style for Carousel */


/* Dots Indicator */
.carousel-dots {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 10px;
}

.dot {
    width: 6px;
    height: 6px;
    background: var(--text-secondary);
    border-radius: 50%;
    opacity: 0.5;
}

.dot.active {
    background: var(--accent);
    opacity: 1;
    transform: scale(1.2);
}

/* --- CUSTOM GALLERY PICKER MODAL --- */
#gallery-picker-modal {
    position: fixed;
    inset: 0;
    background: var(--bg-main);
    z-index: 11000;
    display: none;
    flex-direction: column;
}

.gallery-header {
    height: 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-glass);
}

.gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    padding: 2px;
    overflow-y: auto;
    flex: 1;
}

.gallery-item {
    position: relative;
    padding-bottom: 100%; /* Square */
    background: #222;
    cursor: pointer;
}

.gallery-thumb {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.gallery-item.selected .gallery-thumb {
    opacity: 1;
    border: 2px solid var(--accent);
}

.selection-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    border: 1px solid white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
    font-weight: bold;
}

.gallery-item.selected .selection-badge {
    background: var(--accent);
    border-color: var(--accent);
}

/* Preview area in "New Update" screen */
.selected-thumbs-preview {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.thumb-preview-item {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--border);
    flex-shrink: 0;
}

/* --- REELS STYLES --- */
.reels-scroll-wrapper {
    height: 100vh; /* Full height */
    overflow-y: scroll;
    scroll-snap-type: y mandatory; /* The magic snap property */
    scrollbar-width: none; /* Hide scrollbar */
}
.reels-scroll-wrapper::-webkit-scrollbar { display: none; }

.reel-item {
    width: 100%;
    height: 100vh; /* dynamic viewport height */
    scroll-snap-align: start;
    position: relative;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.reel-video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Fill screen */
    cursor: pointer;
}

/* Overlay Gradients & Info */
.reel-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 40%);
    pointer-events: none; /* Let clicks pass through to video */
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 20px 20px 70px 20px; /* Padding bottom for nav bar */
}

.reel-info {
    color: white;
    margin-bottom: 10px;
    pointer-events: auto;
}

.reel-username {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.reel-desc {
    font-size: 0.9rem;
    line-height: 1.4;
    max-width: 85%;
    opacity: 0.9;
}

/* Right Side Actions */
.reel-actions {
    position: absolute;
    bottom: 100px;
    right: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    pointer-events: auto;
    z-index: 10;
}

.reel-action-btn {
    color: white;
    font-size: 1.8rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    text-shadow: 0 2px 5px rgba(0,0,0,0.5);
    cursor: pointer;
}

.reel-action-btn span {
    font-size: 0.8rem;
    font-weight: 600;
}

.reel-mute-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.6);
    padding: 15px;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
}

/* --- NEW REEL CONTROLS --- */

/* Center Play Button Overlay */
.reel-play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 4rem;
    color: rgba(255, 255, 255, 0.8);
    pointer-events: none; /* Let clicks pass through to the container */
    display: none; /* Hidden by default (when playing) */
    z-index: 5;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

/* Bottom Right Mute Button */
.reel-custom-mute-btn {
    position: absolute;
    bottom: 20px; 
    right: 20px;
    width: 40px;
    height: 40px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    z-index: 20; /* Above overlay */
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.2s;
}

.reel-custom-mute-btn:active {
    transform: scale(0.9);
}


    </style>
</head>
<body>

    <div id="install-modal">
        <div class="install-icon">
            <i class="fa-solid fa-mobile-screen-button"></i>
        </div>
        <div class="install-title">Install Campus Point</div>
        <p class="install-desc">Add this app to your home screen for faster access, fullscreen view, and a better experience.</p>
        <div class="install-buttons">
            <button class="secondary-btn" onclick="hideInstallPrompt()" style="margin-top:0; flex:1;">Not Now</button>
            <button class="action-btn" onclick="triggerInstall()" style="margin-top:0; flex:1;">Install App</button>
        </div>
    </div>

    <div id="share-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5001; display: flex; justify-content: center; align-items: flex-end;">
        <div id="share-card" style="background: var(--bg-card); width: 100%; max-width: 480px; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden;">

            <div style="width: 100%; height: 180px; overflow: hidden; margin-bottom: 20px;">
                <img 
                    src="https://ik.imagekit.io/rstofficial/heroimagecampuspoint.gif" 
                    style="width: 100%; height: 100%; object-fit: cover; display: block;"
                    alt="Friends connecting and collaborating GIF"
                >
            </div>
            <div style="padding: 0 20px 25px; text-align: center;">
                <div class="install-title" style="text-align: center;">Grow Your Network!</div>
                <p class="install-desc" style="margin-top: 8px; text-align: center;">
                    CampusPoint thrives on connection. Share this app with your classmatesâ€”because "friendship builds comfort".
                </p>
                <div class="install-buttons">
                    <button class="secondary-btn" onclick="hideShareModal()" style="margin-top:0; flex:1;">Maybe Later</button>
                    <button class="action-btn" id="share-button-trigger" style="margin-top:0; flex:1;">
                        <i class="fa-solid fa-share-nodes"></i> Share App
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <div id="story-options-modal" onclick="hideStoryOptions()">
    <div class="story-options-sheet" onclick="event.stopPropagation()">
        
        <div style="width: 40px; height: 5px; background: var(--border); margin: 10px auto 15px auto; border-radius: 10px;"></div>
        
        <button class="story-opt-btn" onclick="triggerViewStory()">
            <i class="fa-regular fa-eye"></i> View Your Story
        </button>
        
        <button class="story-opt-btn" onclick="triggerAddStory()">
            <i class="fa-solid fa-circle-plus"></i> Add to Story
        </button>

    </div>
</div>

    <div id="boost-gif-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: flex; justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <img src="https://cdn.pixabay.com/animation/2025/06/04/04/25/04-25-36-422_512.gif" style="width: 150px; height: 150px; border-radius: 10px; opacity: 0.9;" alt="Boost Animation">
            <p class="mono" style="color: var(--boost-color); font-weight: 700; font-size: 1.2rem; margin-top: 10px;">BOOSTED!</p>
        </div>
    </div>

    
    <div id="auth-overlay">
    
            <div class="auth-content">
                <img src="https://ik.imagekit.io/rstofficial/heroimagecampuspoint.gif" class="hero-illustration" style="width:100%; margin-bottom:15px;" alt="Logo">
                
                <h1 class="auth-headline">Connect.<br>Collaborate.<br>Thrive.</h1>
                <p class="auth-subhead">Your campus network starts here.</p>

                <div id="auth-loader" class="loader-spinner"></div>

                <button id="google-btn" class="pinterest-google-btn hidden" onclick="googleLogin()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1024px-Google_%22G%22_logo.svg.png" style="width:20px; height:20px;">
                    Continue with Google
                </button>

                <p id="auth-error" style="color: #ff5555; font-size: 0.8rem; height: 20px;"></p>
            </div>

            <div class="auth-footer">
                By continuing, you agree to Campus Point's 
                <a href="#" onclick="alert('Terms of Service: Be kind and respectful.')">Terms of Service</a> 
                and acknowledge you've read our 
                <a href="#" onclick="alert('Privacy Policy: We respect your data.')">Privacy Policy</a>.
            </div>

        </div>

    <div class="app-container">
        
        <header class="header">
            <div class="brand mono" style="font-weight:700;">CAMPUS<span style="color:var(--accent)">POINT</span></div>
            <div class="h-flex">
                <div class="header-icon-btn" onclick="openNotifications()">
                    <i class="fa-regular fa-bell" style="font-size: 1.2rem;"></i>
                    <div id="notif-badge" class="notif-badge"></div>
                </div>

                <i class="fa-solid fa-moon" id="theme-btn" onclick="openThemeModal()" style="margin-right: 20px; color: var(--text-secondary); cursor:pointer;"></i>
                <img id="header-avatar" src="" style="width:28px; height:28px; border-radius:6px; display:none;">
            </div>
        </header>

        <div class="floating-fab" onclick="switchTab('create', null)">
            <i class="fa-solid fa-pen"></i>
        </div>

        <main id="section-setup" class="content-area hidden" style="padding-top: 0;">
    
            <div class="profile-header-wrapper" style="margin-bottom: 50px;">
            
                <img id="setup-banner-preview" src="" class="banner-img">
                
                <button class="secondary-btn" onclick="openBannerModal()" style="position: absolute; bottom: 10px; right: 10px; width: auto; background: rgba(0,0,0,0.6); color: white; border: none; font-size: 0.8rem; padding: 5px 12px; z-index: 10; border-radius: 6px;">
                    <i class="fa-solid fa-image"></i> Change Banner
                </button>

                <div class="edit-pic-wrapper profile-pic-overlap" onclick="document.getElementById('setup-file-input').click()" style="margin: 0;">
                    <img id="setup-pic-preview" src="" class="edit-pic-img">
                    <div class="edit-pic-badge">
                        <i class="fa-solid fa-pencil"></i>
                    </div>
                </div>
            </div>

    <div style="padding: 0 20px 80px 20px;"> <h2 class="mono" style="text-align:center; margin-bottom: 20px;">EDIT PROFILE</h2>
        
        <input type="file" id="setup-file-input" accept="image/*" style="display:none;" onchange="previewProfilePic()">

        <label>FULL NAME</label>
        <input type="text" id="setup-name" class="nexus-input">
        
        <label>INSTITUTION</label>
        <input type="text" id="setup-university" class="nexus-input">
        
        <label>MAJOR</label>
        <input type="text" id="setup-major" class="nexus-input">
        
        <label>YEAR</label>
        <input type="text" id="setup-year" class="nexus-input">

        <label>BIO <span id="bio-count" style="float:right; font-size:0.7rem;">0/150</span></label>
        <textarea id="setup-bio" class="nexus-input" rows="3" maxlength="150" oninput="updateBioCount()"></textarea>

        <label>INTERESTS</label>
        <div id="setup-interests" class="interests-container"></div>

        <label>FUTURE VISION</label>
        <input type="text" id="setup-goal" class="nexus-input">
        
        <button id="btn-save-profile" class="action-btn" onclick="completeSetup()">SAVE PROFILE</button>
        <button class="secondary-btn" onclick="cancelSetup()" style="width:100%;">Cancel</button>
    </div>
</main>

        <main id="section-feed" class="content-area hidden">
            <div class="stories-wrapper">
        <div id="stories-tray" class="story-tray">
            </div>
    </div>
            <div id="feed-container"></div>
        </main>

        <input type="file" id="story-file-input" accept="image/*" style="display:none;" onchange="handleStoryFileSelect()">


<div id="story-viewer-modal">
    <div id="story-progress-bars" class="story-progress-container"></div>
    
    <div class="story-header-overlay">
        <div class="h-flex">
            <div id="sv-avatar" class="avatar" style="border:none; width:32px; height:32px;"></div>
            <div id="sv-name" style="font-weight:600; font-size:0.9rem; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">User</div>
            <div id="sv-time" style="font-size:0.8rem; opacity:0.8; margin-left:10px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">1h</div>
        </div>
        <i class="fa-solid fa-xmark" onclick="closeStoryViewer()" style="font-size:1.5rem; cursor:pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
    </div>

    <img id="sv-image" src="" class="story-image-view">
    
    <div style="position:absolute; top:0; bottom:0; left:0; width:30%; z-index:5;" onclick="prevStory()"></div>
    <div style="position:absolute; top:0; bottom:0; right:0; width:30%; z-index:5;" onclick="nextStory()"></div>

    <div id="sv-views-btn" onclick="openStoryViews()">
        <i class="fa-solid fa-eye"></i> <span id="sv-views-count">0</span>
    </div>

    <div id="sv-delete-btn" onclick="deleteCurrentStory()" style="position:absolute; bottom:20px; right:20px; color:white; z-index:10; display:none; cursor:pointer;">
        <i class="fa-solid fa-trash"></i>
    </div>
</div>

<main id="section-reels" class="content-area hidden" style="padding: 0; background: #000; height: 100vh; overflow: hidden;">
    <div id="reels-container" class="reels-scroll-wrapper">
        </div>
</main>

        <main id="section-chat-list" class="content-area hidden">
            <h2 class="mono" style="margin-bottom:20px;">MESSAGES</h2>
            <div id="chat-list-container">
                <p style="text-align:center; color:var(--text-secondary)">Loading chats...</p>
            </div>
        </main>

        <main id="section-create" class="content-area hidden">
    <h2 class="mono" style="margin-bottom: 20px;">NEW UPDATE</h2>
    
    <label>TOPIC TAG</label>
    <input type="text" id="post-goal" class="nexus-input" placeholder="#ExamPrep, #Project... ">
    
    <label>CONTENT</label>
    <textarea id="post-text" class="nexus-input" rows="5" placeholder="Share your thoughts..."></textarea>
    
    <label>MEDIA (Photos or Video)</label>
    
    <div id="final-preview-container" class="selected-thumbs-preview" style="display:none; flex-wrap: wrap;"></div>

    <input type="file" id="raw-gallery-input" accept="image/*, video/mp4, video/quicktime" multiple style="display:none;" onchange="handleRawInput(this)">

    <p id="upload-type-indicator" style="font-size: 0.8rem; color: var(--accent); display: none; margin-bottom: 10px; text-align: center;">
        <i class="fa-solid fa-film"></i> Video Selected (Reel Mode)
    </p>

    <div class="h-flex" style="gap: 10px; margin-bottom: 20px;">
        
        <button class="secondary-btn" onclick="document.getElementById('raw-gallery-input').click()" style="flex: 1; text-align:center; border-style: dashed; padding: 15px; margin-top: 0;">
            <i class="fa-solid fa-image" style="font-size: 1.2rem; display: block; margin-bottom: 5px;"></i> 
            Select Photos
        </button>

        <button class="secondary-btn" onclick="triggerVideoUpload()" style="flex: 1; text-align:center; border-style: dashed; padding: 15px; margin-top: 0;">
            <i class="fa-solid fa-video" style="font-size: 1.2rem; display: block; margin-bottom: 5px;"></i> 
            Upload Reel
        </button>

    </div>

    <button id="btn-post" class="action-btn" onclick="createPost()">POST UPDATE</button>
</main>

        <main id="section-radar" class="content-area hidden">
    
    <div style="width: 100%; display: flex; justify-content: center; margin-bottom: 20px;">
        <div id="gps-status-indicator" class="mono" style="font-size: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); padding: 6px 16px; border-radius: 50px; color: var(--text-secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <i class="fa-solid fa-satellite-dish"></i> GPS: CHECKING...
        </div>
    </div>

    <div id="radar-permission-warning" class="hidden" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; text-align: center; padding: 0 20px;">
        
        <div style="width: 70px; height: 70px; background: rgba(255, 85, 85, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <i class="fa-solid fa-map-location-dot" style="font-size: 1.8rem; color: #ff5555;"></i>
        </div>

        <h3 class="mono" style="margin-bottom: 10px; font-size: 1rem;">LOCATION REQUIRED</h3>
        
        <p id="gps-msg" style="color: var(--text-secondary); max-width: 280px; margin-bottom: 25px; line-height: 1.5; font-size: 0.9rem;">
            To see students nearby, CampusPoint needs access to your GPS location.
        </p>

        <button id="btn-gps-retry" class="action-btn" onclick="retryGPS()" style="width: auto; padding: 12px 30px;">
            <i class="fa-solid fa-location-crosshairs"></i> Allow Location
        </button>
        
        <p id="gps-manual-instruction" class="hidden" style="font-size: 0.8rem; color: #ff5555; margin-top: 15px; border: 1px dashed #ff5555; padding: 10px; border-radius: 8px; background: rgba(255,85,85,0.05);">
            <i class="fa-solid fa-lock"></i> <b>Permission Blocked</b><br>
            Tap the <b>Lock Icon ðŸ”’</b> in your browser address bar and hit "Reset Permission".
        </p>
    </div>

    <div id="radar-content" class="hidden">
        <div class="radar-view">
            <div class="radar-circle">
                <div class="radar-sweep"></div>
            </div>
        </div>
        <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; text-align: center;">NEARBY STUDENTS</h3>
        <div id="user-list"></div>
    </div>

</main>

<main id="section-notifications" class="content-area hidden">
    <div class="h-flex" style="margin-bottom: 20px;">
        <i class="fa-solid fa-arrow-left" onclick="window.history.back()" style="font-size: 1.2rem; cursor: pointer; padding: 10px;"></i>
        <div class="mono" style="font-weight: 700; font-size: 1.1rem; margin-left: 10px;">NOTIFICATIONS</div>
    </div>
    <div id="notification-list">
        <p style="text-align:center; color:var(--text-secondary); margin-top:30px;">No new notifications.</p>
    </div>
</main>


<main id="section-groups" class="content-area hidden">
            <h2 class="mono" style="margin-bottom: 20px;">GROUP CHATS</h2>
            <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:30px;">Find people passionate about the same things.</p>
            
            <div id="group-list-container">
                <p style="text-align:center; color:var(--text-secondary)">Loading available groups...</p>
            </div>
        </main>

        <main id="section-profile" class="content-area hidden" style="padding-top: 0;">
            <div class="profile-header-wrapper">
                <img id="profile-banner" src="" class="banner-img">
                <img id="profile-pic" src="" class="profile-pic-overlap">
            </div>

            <div style="text-align: center; padding: 0 20px;">
                <h2 id="profile-name">User</h2>
                <p id="profile-academic" class="mono" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 5px;"></p>
                <p id="profile-uni" style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 15px;"></p>

                <div id="profile-bio" class="bio-text"></div>
<div id="profile-goal-container" style="display:none;">
    <div class="future-goal-display">
        <i class="fa-solid fa-rocket"></i> 5y Goal: <span id="profile-goal"></span>
    </div>
</div>
<div id="profile-interests" class="interests-container"></div>
                
                <div class="stats-row">
                    <div class="stat-box"><h3 id="stat-followers" style="color:var(--accent)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWERS</span></div>
                    <div class="stat-box"><h3 id="stat-following" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWING</span></div>
                    <div class="stat-box"><h3 id="stat-posts" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">POSTS</span></div>
                </div>

                <div class="h-flex" style="justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <button class="secondary-btn" onclick="editProfile()">Edit Profile</button>
                    <button class="secondary-btn" style="border-color: #ff5555; color: #ff5555;" onclick="firebase.auth().signOut()">Logout</button>
                </div>
            </div>
            <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">MY POSTS</h3>
            <div id="profile-feed"></div>
        </main>

        <main id="section-other-profile" class="content-area hidden" style="padding-top: 0;">
    <div class="profile-header-wrapper">
        <img id="other-banner" src="" class="banner-img">
        <div id="other-pic" class="profile-pic-overlap" style="background-size: cover; border-width: 4px; border-style: solid; border-color: var(--bg-main);"></div>
    </div>
    <div style="text-align: center; padding: 20px 0;">
        <h2 id="other-name">User</h2>
        <p id="other-academic" class="mono" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 5px;"></p>
        
        <div id="other-bio" class="bio-text"></div>
        
        <div id="other-goal-container" style="display:none;">
            <div class="future-goal-display">
                <i class="fa-solid fa-rocket"></i> 5y Goal: <span id="other-goal"></span>
            </div>
        </div>
        
        <div id="other-interests" class="interests-container"></div>
        
        <div class="stats-row">
            <div class="stat-box"><h3 id="other-stat-followers" style="color:var(--accent)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWERS</span></div>
            <div class="stat-box"><h3 id="other-stat-following" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWING</span></div>
        </div>

        <div class="h-flex" style="justify-content: center; gap: 10px; margin-bottom: 20px;">
            <button id="btn-follow" class="action-btn" style="width:auto; margin-top:0;" onclick="toggleFollow()">Follow</button>
            <button class="secondary-btn2" style="margin-top:0;" onclick="startChat()">Message</button>
        </div>
    </div> 
    <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">ACTIVITY</h3>
    <div id="other-profile-feed"></div>
</main>

        <main id="section-follow-list" class="content-area hidden">
            <div class="h-flex" style="margin-bottom: 20px;">
                <i class="fa-solid fa-arrow-left" onclick="closeFollowList()" style="font-size: 1.2rem; cursor: pointer; padding: 10px;"></i>
                <div id="follow-list-title" class="mono" style="font-weight: 700; font-size: 1.1rem; margin-left: 10px;">TITLE</div>
            </div>
            <div id="follow-list-content">
                </div>
        </main>

        <nav class="bottom-nav hidden" id="main-nav">
            <div class="nav-item active" onclick="switchTab('feed', this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="switchTab('reels', this)"><i class="fa-brands fa-youtube"></i></div>
            <div class="nav-item" onclick="switchTab('radar', this)"><i class="fa-regular fa-compass"></i></div>
            <div class="nav-item" onclick="switchTab('groups', this)"><i class="fa-solid fa-users"></i></div>
            <div class="nav-item" onclick="switchTab('chat-list', this)"><i class="fa-regular fa-comments"></i></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><i class="fa-regular fa-user"></i></div>
        </nav>

    </div>


    <div id="cropper-modal">
        <div class="cropper-container-wrapper">
            <img id="cropper-target-img" src="">
        </div>
        
        <div class="cropper-toolbar">
            <button class="crop-btn cancel" onclick="cancelCrop()">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button class="crop-btn" onclick="rotateImage(-90)">
                <i class="fa-solid fa-rotate-left"></i> Rotate
            </button>
            <button class="crop-btn" onclick="rotateImage(90)">
                <i class="fa-solid fa-rotate-right"></i> Rotate
            </button>
            <button class="crop-btn save" onclick="finishCrop()">
                <i class="fa-solid fa-check"></i> Done
            </button>
        </div>
    </div>

    <div id="banner-modal">
    <div class="h-flex" style="justify-content: space-between; margin-bottom: 10px;">
        <h3 style="color: white;">Select Banner</h3>
        <i class="fa-solid fa-xmark" onclick="closeBannerModal()" style="color: white; font-size: 1.5rem; cursor: pointer;"></i>
    </div>
    <div id="banner-grid-container" class="banner-grid">
        </div>
</div>

<div id="upload-progress-modal">
    <div class="upload-card">
        <div class="upload-spinner"></div>
        <div class="upload-status-text">UPLOADING...</div>
        <div id="upload-subtext" class="upload-subtext">Compressing media</div>
        <div class="progress-track">
            <div id="upload-progress-bar" class="progress-bar"></div>
        </div>
    </div>
</div>

<div id="views-modal" onclick="closeStoryViews()">
    <div class="views-sheet" onclick="event.stopPropagation()">
        <div class="views-header">
            <div class="mono" style="font-weight: 700;">Story Views</div>
            <i class="fa-solid fa-xmark" onclick="closeStoryViews()" style="font-size: 1.2rem; cursor:pointer; color:var(--text-secondary);"></i>
        </div>
        <div id="views-list-content" class="views-list">
            <div class="loader-spinner" style="margin: 30px auto;"></div>
        </div>
    </div>
</div>

<div id="theme-modal" onclick="closeThemeModal()">
    <div class="theme-card" onclick="event.stopPropagation()">
        <div class="theme-title">Appearance</div>
        
        <div class="theme-option" onclick="setTheme('light')" id="opt-light">
            <i class="fa-regular fa-sun"></i>
            <div>Light Mode</div>
        </div>

        <div class="theme-option" onclick="setTheme('dark')" id="opt-dark">
            <i class="fa-solid fa-moon"></i>
            <div>Dark Mode</div>
        </div>

        <div class="theme-option" onclick="setTheme('system')" id="opt-system">
            <i class="fa-solid fa-desktop"></i>
            <div>System Default</div>
        </div>
        
        <button class="secondary-btn" onclick="closeThemeModal()" style="width:100%; margin-top:10px;">Cancel</button>
    </div>
</div>

<div id="story-editor-modal">
    <div class="story-toolbar-top">
        <i class="fa-solid fa-xmark" onclick="closeStoryEditor()" style="color: white; font-size: 1.5rem; cursor: pointer;"></i>
        <div class="h-flex" style="gap: 15px;">
            <i class="fa-solid fa-rotate-left" onclick="editorUndo()" style="color: white; cursor: pointer;"></i>
            <i class="fa-solid fa-rotate-right" onclick="editorRedo()" style="color: white; cursor: pointer;"></i>
        </div>
    </div>

    <div class="story-canvas-container" id="canvas-wrapper">
        <canvas id="story-canvas"></canvas>
    </div>

    <div id="sticker-tray" class="sticker-tray">
        <span class="sticker-option" onclick="addSticker('ðŸ”¥')">ðŸ”¥</span>
        <span class="sticker-option" onclick="addSticker('â¤ï¸')">â¤ï¸</span>
        <span class="sticker-option" onclick="addSticker('ðŸ˜‚')">ðŸ˜‚</span>
        <span class="sticker-option" onclick="addSticker('ðŸŽ‰')">ðŸŽ‰</span>
        <span class="sticker-option" onclick="addSticker('ðŸŽ“')">ðŸŽ“</span>
        <span class="sticker-option" onclick="addSticker('ðŸ“')">ðŸ“</span>
        <span class="sticker-option" onclick="addSticker('ðŸ‘€')">ðŸ‘€</span>
        <span class="sticker-option" onclick="addSticker('ðŸ’¯')">ðŸ’¯</span>
    </div>

    <div id="font-tray" class="font-tray">
        <div class="font-option font-classic" onclick="applyFont('Inter')">Classic</div>
        <div class="font-option font-mono" onclick="applyFont('JetBrains Mono')">Code</div>
        <div class="font-option font-cursive" onclick="applyFont('cursive')">Style</div>
        <div class="font-option font-serif" onclick="applyFont('serif')">Formal</div>
        <div class="font-option" style="font-family: impact" onclick="applyFont('Impact')">Bold</div>
    </div>

    <div class="story-toolbar-bottom">
        <button class="editor-btn" onclick="addNewTextLayer()"><i class="fa-solid fa-font"></i></button>
        <button class="editor-btn" onclick="toggleFonts()"><i class="fa-solid fa-text-height"></i></button>
        <button class="editor-btn" onclick="toggleStickers()"><i class="fa-regular fa-face-smile"></i></button>
        <button class="editor-btn" onclick="openMentionDialog()"><i class="fa-solid fa-at"></i></button>
        
        <button class="action-btn" onclick="uploadStoryFromCanvas()" style="width: auto; padding: 10px 20px; margin: 0; font-size: 0.9rem;">
            Post <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>

<div id="text-edit-dialog">
    <div class="edit-card">
        <label>EDIT TEXT</label>
        <textarea id="story-text-input" class="nexus-input" rows="3" style="font-size: 1.2rem;"></textarea>
        <div class="h-flex" style="gap: 10px;">
            <button class="secondary-btn" onclick="document.getElementById('text-edit-dialog').style.display='none'">Cancel</button>
            <button class="action-btn" onclick="saveTextEdit()">Done</button>
        </div>
        <button class="secondary-btn" onclick="deleteActiveObject()" style="width:100%; border-color:#ff5555; color:#ff5555; margin-top:10px;">Delete Element</button>
    </div>
</div>

<div id="mention-modal">
    <div class="edit-card">
        <label>MENTION A FRIEND</label>
        <input type="text" id="mention-search" class="nexus-input" placeholder="Search name..." oninput="searchUsersForMention(this.value)">
        <div id="mention-results" class="search-results"></div>
        <button class="secondary-btn" onclick="document.getElementById('mention-modal').style.display='none'" style="width:100%; margin-top:10px;">Close</button>
    </div>
</div>

<main id="section-discussion-room" class="hidden">
    <div class="room-header">
        <i class="fa-solid fa-arrow-left" onclick="closeDiscussionRoom()" style="font-size: 1.2rem; cursor: pointer; padding: 10px;"></i>
        <div class="mono" style="font-weight: 700; font-size: 1.1rem; margin-left: 10px;">DISCUSSION ROOM</div>
    </div>
    
    <div id="room-comments-list" class="room-scroll-area">
        </div>

    <div class="room-footer">
        <div class="avatar" id="room-my-avatar" style="width: 35px; height: 35px;"></div>
        <input type="text" id="room-input" class="nexus-input" style="margin:0; flex:1;" placeholder="Join the discussion...">
        <button class="action-btn" onclick="postRoomComment()" style="width: auto; margin: 0; padding: 10px 15px;">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</main>

<div id="gallery-picker-modal">
    <div class="gallery-header">
        <i class="fa-solid fa-xmark" onclick="closeGalleryPicker()" style="font-size: 1.5rem; cursor:pointer;"></i>
        <div class="mono" style="font-weight:700;">Select Photos</div>
        <div class="action-btn" onclick="processSelectedGallery()" style="width:auto; margin:0; padding: 8px 15px; font-size:0.9rem;">
            Next <i class="fa-solid fa-arrow-right"></i>
        </div>
    </div>
    <div id="gallery-grid" class="gallery-grid">
        </div>
</div>

    <script>

        // Pre-defined high quality banners (Unsplash)
const BANNER_OPTIONS = [
    "https://images.unsplash.com/photo-1674257751921-4ec8fc65e563?w=600&q=80", // Gradient Blue
    "https://images.unsplash.com/photo-1557683316-973673baf926?w=600&q=80", // Gradient Dark
    "https://plus.unsplash.com/premium_photo-1723924899327-48f529ba853b?w=600&q=80", // Night Sky
    "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=600&q=80", // Tech/Globe
    "https://images.unsplash.com/photo-1493246507139-91e8fad9978e?w=600&q=80", // Mountains
    "https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?w=600&q=80", // Neon City
    "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=600&q=80", // Beach
    "https://images.unsplash.com/photo-1571470804270-af65e8b3d106?w=600&q=80", // Code
    "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=600&q=80", // Matrix/Cyber
    "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=600&q=80"  // Library/Books
];

let selectedBannerUrl = BANNER_OPTIONS[0]; // Default
const DEFAULT_BANNER = BANNER_OPTIONS[0];

// --- IMPROVED PWA INSTALLATION LOGIC (Android & iOS) ---

// 1. Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker Registered'))
            .catch(err => console.log('Service Worker Failed', err));
    });
}

// 2. iOS Detection Helper
function isIOS() {
    return [
        'iPad Simulator',
        'iPhone Simulator',
        'iPod Simulator',
        'iPad',
        'iPhone',
        'iPod'
    ].includes(navigator.platform)
    // iPad on iOS 13 detection
    || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

// 3. Logic to Show Install Prompt
let deferredPrompt;
const installModal = document.getElementById('install-modal');
const isAppInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

// Check if already installed to avoid showing modal
if (!isAppInstalled) {
    
    // ANDROID / DESKTOP LOGIC
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show modal if not dismissed recently
        if (!localStorage.getItem('installDismissed')) {
            setTimeout(() => {
                showInstallModal('android');
            }, 2000);
        }
    });

    // iOS LOGIC (Since beforeinstallprompt doesn't fire)
    if (isIOS() && !localStorage.getItem('installDismissed')) {
        setTimeout(() => {
            showInstallModal('ios');
        }, 2000);
    }
}

function showInstallModal(platform) {
    installModal.style.display = 'flex';
    
    if (platform === 'ios') {
        // Change text and hide button for iOS
        document.querySelector('.install-title').innerText = "Install on iOS";
        document.querySelector('.install-desc').innerHTML = `
            To install this app on your iPhone:<br><br>
            1. Tap the <b>Share</b> button <i class="fa-solid fa-arrow-up-from-bracket"></i><br>
            2. Scroll down and tap <b>"Add to Home Screen"</b> <i class="fa-regular fa-square-plus"></i>
        `;
        // Hide the "Install App" button since we can't trigger it programmatically
        document.querySelector('.action-btn').style.display = 'none';
        // Make "Not Now" span full width
        document.querySelector('.secondary-btn').style.width = '100%';
        document.querySelector('.secondary-btn').innerText = "Close";
    }
}

function hideInstallModal() {
    installModal.style.display = 'none';
}

// Rename your existing function to match the call above
function hideInstallPrompt() {
    hideInstallModal();
}

function openBannerModal() {
    const container = document.getElementById('banner-grid-container');
    container.innerHTML = '';
    
    BANNER_OPTIONS.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'banner-option';
        if(url === selectedBannerUrl) img.classList.add('selected');
        
        img.onclick = () => {
            selectedBannerUrl = url;
            // Visual feedback
            document.querySelectorAll('.banner-option').forEach(el => el.classList.remove('selected'));
            img.classList.add('selected');
            
            // Update preview
            document.getElementById('setup-banner-preview').src = url;
            
            // Close modal after short delay
            setTimeout(closeBannerModal, 200);
        };
        container.appendChild(img);
    });
    
    document.getElementById('banner-modal').style.display = 'flex';
}

function closeBannerModal() {
    document.getElementById('banner-modal').style.display = 'none';
}

// --- UPLOAD MODAL HELPERS ---
function showUploadModal(text) {
    document.getElementById('upload-progress-modal').style.display = 'flex';
    document.getElementById('upload-subtext').innerText = text || "Processing...";
    updateProgressBar(10); // Start little bit
}

function hideUploadModal() {
    document.getElementById('upload-progress-modal').style.display = 'none';
    updateProgressBar(0); // Reset
}

function updateProgressBar(percent) {
    document.getElementById('upload-progress-bar').style.width = percent + '%';
}

// --- ANIMATION & SOUND FUNCTION ---
function showBoostAnimation() {
    const modal = document.getElementById('boost-gif-modal');
    
    // 1. Show the visual GIF
    modal.classList.remove('hidden');

    // 2. Play Sound Effect
    // Using a free "pop" sound effect
    const audio = new Audio('https://campuspoint.netlify.app/boosted.mp3');
    audio.volume = 1.0; // Adjust volume (0.0 to 1.0)
    audio.play().catch(error => console.log("Audio playback failed:", error));

    // 3. Hide after 1 second
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 1000);
}

// --- GROUP CHAT LOBBY LOGIC (index.html) ---

function loadGroupLobby() {
    const container = document.getElementById('group-list-container');
    container.innerHTML = '';
    
    // Use the HOBBIES_LIST array to create rooms (HOBBIES_LIST should be global in index.html)
    HOBBIES_LIST.forEach(hobby => {
        const details = getHobbyIcon(hobby); // Get both icon and color
        
        container.innerHTML += `
            <div class="chat-item" onclick="checkGroupJoin('${hobby}')" style="cursor:pointer;">
                <div class="avatar" style="
                    background: ${details.color}15; 
                    font-size:1.3rem; 
                    color: ${details.color}; 
                    display:flex; 
                    align-items:center; 
                    justify-content:center;
                    border: 1px solid ${details.color}40;
                ">
                    <i class="fa-solid ${details.icon}"></i>
                </div>
                <div>
                    <div style="font-weight:600;">#${hobby} Lounge</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">Live group chat for ${hobby} enthusiasts.</div>
                </div>
                <button class="secondary-btn" style="
                    margin-top:0; 
                    margin-left:auto; 
                    padding: 6px 12px; 
                    font-weight:600; 
                    border-color: ${details.color}; 
                    color: ${details.color};
                ">Join</button>
            </div>
        `;
    });
}

function previewProfilePic() {
    startCropper('setup-file-input', 'profile');
}

function rotateImage(deg) {
    if(cropper) cropper.rotate(deg);
}

function cancelCrop() {
    document.getElementById('cropper-modal').style.display = 'none';
    document.getElementById('setup-file-input').value = ""; // Reset input
    if(cropper) {
        cropper.destroy();
        cropper = null;
    }
}



function getHobbyIcon(hobby) {
    // Map hobby to a specific Font Awesome class and a unique Hex color code.
    const map = {
        "Coding": { icon: "fa-code", color: "#FF5555" },       // Bright Red/Pink (Tech/Logic)
        "Music": { icon: "fa-compact-disc", color: "#FFD700" }, // Gold (Media/Creativity)
        "Travel": { icon: "fa-plane-departure", color: "#4DABF8" }, // Accent Blue (Exploration)
        "Gaming": { icon: "fa-gamepad", color: "#9B59B6" },    // Purple (Entertainment)
        "Reading": { icon: "fa-book", color: "#2ECC71" },      // Emerald Green (Knowledge)
        "Fitness": { icon: "fa-dumbbell", color: "#E67E22" },  // Orange (Energy/Health)
        "Photography": { icon: "fa-camera-retro", color: "#F39C12" }, // Yellow/Orange (Art)
        "Art": { icon: "fa-palette", color: "#E91E63" },       // Rose Pink (Visual Creation)
        "Startups": { icon: "fa-lightbulb", color: "#3498DB" },  // Bright Blue (Ideas)
        "AI": { icon: "fa-robot", color: "#1ABC9C" },          // Cyan/Teal (Future Tech)
        "Foodie": { icon: "fa-utensils", color: "#95A5A6" },   // Gray/Silver (Lifestyle)
        "Movies": { icon: "fa-clapperboard", color: "#D35400" }, // Dark Orange/Brown (Cinema)
        "Sports": { icon: "fa-basketball", color: "#E74C3C" }, // Coral Red (Activity)
        "Writing": { icon: "fa-pen-nib", color: "#9B59B6" },   // Purple (Intellectual)
        "Dance": { icon: "fa-compact-disc", color: "#00BCD4" }, // Turquoise/Cyan (Rhythm/Movement)
        "Nature": { icon: "fa-leaf", color: "#16A085" },       // Dark Green (Environment)
        "Fashion": { icon: "fa-shirt", color: "#AF7AC5" },     // Light Purple (Style)
        "Politics": { icon: "fa-gavel", color: "#7F8C8D" }     // Dark Gray (Authority/Civic)
    };
    
    // Return the color and icon, or a fallback.
    return map[hobby] || { icon: "fa-hashtag", color: "#888888" };
}

function checkGroupJoin(groupName) {
    const confirmation = confirm(`Joining #${groupName} Lounge:

Agreement:
1. Be respectful to all members.
2. No spamming, excessive links, or abuse.
3. Excessive violations WILL result in a permanent ban.

Do you agree to these terms and wish to enter?`);

    if (confirmation) {
        // Redirect to the new group chat file
        window.location.href = `group.html?group=${groupName}`;
    }
}

// Call the loadGroupLobby in the loadAppInterface
// Find loadAppInterface and add:
/*
function loadAppInterface(userData) {
    // ... existing code ...
    startNotificationListener(); 
    loadGroupLobby(); // <--- ADD THIS
    // ... existing code ...
}
*/

async function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        deferredPrompt = null;
        installModal.style.display = 'none';
    }
}

window.addEventListener('appinstalled', () => {
    installModal.style.display = 'none';
    console.log('PWA was installed');
});

// --- SHARE MODAL FUNCTIONS ---

// The URL you want to share
const SHARE_URL = "https://campuspoint.netlify.app";

function showShareModal() {
    document.getElementById('share-modal').classList.remove('hidden');
}

function hideShareModal() {
    document.getElementById('share-modal').classList.add('hidden');
}

document.getElementById('share-button-trigger').onclick = async () => {
    hideShareModal();
    
    // Check if the Web Share API is available (Best for mobile)
    if (navigator.share) {
        try {
            await navigator.share({
                title: 'Campus Point',
                text: 'Connect with students on your campus for projects, discussions, and networking!',
                url: SHARE_URL,
            });
            console.log('Share successful');
        } catch (error) {
            // This happens if the user cancels the share, which is fine
            console.log('Error sharing:', error);
        }
    } else {
        // Fallback for browsers that don't support navigator.share (e.g., Desktop browsers)
        // Copy link to clipboard instead.
        navigator.clipboard.writeText(SHARE_URL);
        alert(`Link copied to clipboard! Share it with friends:\n${SHARE_URL}`);
    }
};

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBg1m_bFN4xzl4yJ_JiG8E6UPDZjFks7PM",
        authDomain: "campus-point-rst.firebaseapp.com",
        projectId: "campus-point-rst",
        storageBucket: "campus-point-rst.firebasestorage.app",
        messagingSenderId: "877074516750",
        appId: "1:877074516750:web:f485c45a1446c030afa55f",
        measurementId: "G-M4WDE31CTL"
    };

    // --- IMAGEKIT CONFIG (Replace with your keys) ---
    const IMAGEKIT_URL_ENDPOINT = "https://ik.imagekit.io/rstofficial"; 
    const IMAGEKIT_PUBLIC_KEY = "public_tHyBprcdz5rljWej0F2U9xfKYU0="; 
    

    const HOBBIES_LIST = [
    "Coding", "Music", "Travel", "Gaming", "Reading", "Fitness", 
    "Photography", "Art", "Startups", "AI", "Foodie", "Movies", 
    "Sports", "Writing", "Dance", "Nature", "Fashion", "Politics"
];
let selectedHobbies = new Set();

    let db, auth, currentUser;
    let globalProfileData = {};
    let myLocation = null;
    let viewingUserId = null;
    let lastProfileTab = 'profile'; // Remembers where to go back to
    let cropper = null; 
let finalCroppedFile = null; // Stores the edited file ready for upload
// --- EDITOR GLOBALS ---
let cropContext = null; // 'post', 'profile', or 'story'
let fabricCanvas = null;
let editorHistory = [];
let historyStep = -1;
let finalPostFile = null; // Store the edited post file
let currentRoomPostId = null;
let roomListener = null; // To stop realtime updates when leaving
let rawFiles = []; // All files user picked from system
let selectedIndices = []; // Indices of files user selected in our custom grid
let croppedBlobs = []; // Final processed images ready for upload
let currentCropIndex = 0; // To track which image we are cropping in the queue

let selectedVideoFile = null; // Stores the raw video file

    // --- 1. NEW ROUTER SYSTEM ---
    
    // This function handles the actual UI changes based on the URL hash
    function router() {
        // Get the hash (remove the #) or default to 'feed'
        const hash = window.location.hash.slice(1) || 'feed';
        
        // Hide all sections
        document.querySelectorAll('.content-area').forEach(el => el.classList.add('hidden'));
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        // Handle specific screens
        const activeSection = document.getElementById('section-' + hash);
        
        if (activeSection) {
            // Show the section matching the hash
            activeSection.classList.remove('hidden');
            
            // Highlight the corresponding Bottom Nav item (if it exists)
            // We match based on the onclick attribute containing the hash name
            const navBtn = document.querySelector(`.nav-item[onclick*="'${hash}'"]`);
            if (navBtn) navBtn.classList.add('active');
        } else {
            // Fallback: If hash doesn't match any ID, go to feed
            window.location.hash = 'feed';
        }

        // Special handling for Floating Action Button (Only show on feed)
        const fab = document.querySelector('.floating-fab');
        if (fab) {
            fab.style.display = (hash === 'feed') ? 'flex' : 'none';
        }

        if (hash === 'reels') {
            if(!reelsObserver) initReelsObserver();
            loadReels();
        }
    }

    // 1. User picks files from system -> Show Custom Grid
function handleRawInput(input) {
    if (input.files && input.files.length > 0) {
        const file = input.files[0];
        const isVideo = file.type.startsWith('video/');

        // Reset previous states
        selectedVideoFile = null;
        rawFiles = [];
        selectedIndices = [];
        document.getElementById('upload-type-indicator').style.display = 'none';
        document.getElementById('final-preview-container').innerHTML = '';

        if (isVideo) {
            // --- VIDEO FLOW ---
            if (file.size > 50 * 1024 * 1024) { // 50MB Limit
                alert("Video is too large. Max size is 50MB.");
                input.value = "";
                return;
            }

            selectedVideoFile = file; // Store the video file
            
            // Show Video Preview
            const container = document.getElementById('final-preview-container');
            container.style.display = 'flex';
            container.innerHTML = `
                <div style="position:relative; width:100%;">
                    <video src="${URL.createObjectURL(file)}" style="width:100%; max-height:200px; border-radius:8px; background:#000;" controls></video>
                    <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:5px 10px; border-radius:4px; font-size:0.8rem;">
                        Reel Preview
                    </div>
                </div>
            `;
            
            // Show indicator text
            document.getElementById('upload-type-indicator').style.display = 'block';
            
        } else {
            // --- IMAGE FLOW (Default) ---
            // Reset accept attribute back to default
            document.getElementById('raw-gallery-input').accept = "image/*, video/mp4, video/quicktime";
            
            rawFiles = Array.from(input.files);
            selectedIndices = []; 
            renderGalleryGrid(); // Show your existing gallery grid
            document.getElementById('gallery-picker-modal').style.display = 'flex';
        }
    }
    input.value = ""; // Reset input so same file can be selected again if needed
}

// 2. Render the Grid
function renderGalleryGrid() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';

    rawFiles.forEach((file, index) => {
        const url = URL.createObjectURL(file);
        const isSelected = selectedIndices.includes(index);
        const selectionOrder = isSelected ? selectedIndices.indexOf(index) + 1 : '';

        const div = document.createElement('div');
        div.className = `gallery-item ${isSelected ? 'selected' : ''}`;
        div.onclick = () => toggleGallerySelection(index);

        div.innerHTML = `
            <img src="${url}" class="gallery-thumb">
            <div class="selection-badge">${selectionOrder}</div>
        `;
        grid.appendChild(div);
    });
}

// 3. Toggle Selection (Max 3)
function toggleGallerySelection(index) {
    const pos = selectedIndices.indexOf(index);
    
    if (pos > -1) {
        // Deselect
        selectedIndices.splice(pos, 1);
    } else {
        // Select (Limit 3)
        if (selectedIndices.length >= 3) {
            alert("You can select up to 3 photos.");
            return;
        }
        selectedIndices.push(index);
    }
    renderGalleryGrid(); // Re-render to update numbers
}

function closeGalleryPicker() {
    document.getElementById('gallery-picker-modal').style.display = 'none';
}

// 4. Start Processing (Crop Queue)
function processSelectedGallery() {
    if (selectedIndices.length === 0) return alert("Select at least one photo.");
    
    closeGalleryPicker();
    croppedBlobs = []; // Clear old results
    currentCropIndex = 0; // Start at first image
    
    // Start cropping the first image
    openCropperForIndex(currentCropIndex);
}

// 5. Open Cropper for specific image in queue
function openCropperForIndex(queueIndex) {
    const fileIndex = selectedIndices[queueIndex];
    const file = rawFiles[fileIndex];
    
    // Re-use your existing startCropper logic but customize it
    const reader = new FileReader();
    reader.onload = function(e) {
        const imgElement = document.getElementById('cropper-target-img');
        imgElement.src = e.target.result;
        document.getElementById('cropper-modal').style.display = 'flex';
        
        if(cropper) cropper.destroy();
        
        cropper = new Cropper(imgElement, {
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            background: false,
        });
        
        // Temporarily override the save button to call our specific function
        const saveBtn = document.querySelector('.crop-btn.save');
        saveBtn.onclick = () => saveGalleryCrop();
    }
    reader.readAsDataURL(file);
}

// 6. Save Crop & Move to Next
function saveGalleryCrop() {
    if(!cropper) return;
    
    const canvas = cropper.getCroppedCanvas({ width: 1080 });
    
    canvas.toBlob((blob) => {
        croppedBlobs.push(blob);
        
        // Cleanup current crop
        document.getElementById('cropper-modal').style.display = 'none';
        cropper.destroy();
        cropper = null;
        
        // Check if more images exist
        currentCropIndex++;
        if (currentCropIndex < selectedIndices.length) {
            // Open next image
            setTimeout(() => openCropperForIndex(currentCropIndex), 200);
        } else {
            // All done! Show preview
            renderFinalPreviews();
        }
    }, 'image/jpeg', 0.9);
}

// 7. Show Previews in Create Post screen
function renderFinalPreviews() {
    const container = document.getElementById('final-preview-container');
    container.innerHTML = '';
    container.style.display = 'flex';
    
    croppedBlobs.forEach(blob => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.className = 'thumb-preview-item';
        container.appendChild(img);
    });
}

    // --- 2. MODIFIED SWITCHTAB ---
    // Instead of changing UI directly, this now just updates the URL.
    // The 'hashchange' listener below will detect this and fire the router().
    function switchTab(id) {
        window.location.hash = id;
    }

    // --- 3. LISTEN FOR BACK BUTTON & LOAD ---
    // This detects when user clicks Back button or allows the app
    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => {
        // If no hash exists on load, set it to feed
        if(!window.location.hash) window.location.hash = 'feed';
        router();
    });

    // --- INIT ---
    function initApp() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('auth-loader');
            const btn = document.getElementById('google-btn');
            const overlay = document.getElementById('auth-overlay');

            if (user) {
                // --- USER LOGGED IN ---
                currentUser = user;
                
                // WAIT 2 SECONDS (2000ms) before transitioning
                setTimeout(() => {
                    // 1. Hide the auth screen
                    overlay.classList.add('hidden');
                    
                    // 2. Load the app data
                    checkUserProfile(user);
                }, 2000);

            } else {
                // --- USER NOT LOGGED IN ---
                // Show the login button immediately if no user is found
                
                overlay.classList.remove('hidden');
                
                if(loader) loader.style.display = 'none';
                
                if(btn) {
                    btn.classList.remove('hidden');
                    btn.style.display = 'flex'; 
                }
                
                document.getElementById('main-nav').classList.add('hidden');
            }
        });
    } catch (e) {
        console.error(e);
        alert("Init Error");
    }
}

// Add this anywhere in your script
function requestNotificationPermission() {
    if (!("Notification" in window)) {
        console.log("This browser does not support desktop notification");
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notification permission granted!");
            }
        });
    }
}

// Call this immediately when the app loads or inside initApp()
requestNotificationPermission();

function startNotificationListener() {
    // --- 1. CHAT NOTIFICATIONS (System/Browser Popup) ---
    // (This part remains unchanged from your previous code)
    db.collection('chats')
      .where('participants', 'array-contains', currentUser.uid)
      .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
              if (change.type === "modified" || change.type === "added") {
                  const chatData = change.doc.data();
                  const chatId = change.doc.id;

                  if (chatData.lastSenderId && chatData.lastSenderId !== currentUser.uid) {
                      const now = new Date();
                      const msgTime = chatData.lastUpdated ? chatData.lastUpdated.toDate() : new Date(0);
                      const diff = (now - msgTime) / 1000; 

                      if (diff < 10) { 
                          const senderId = chatData.lastSenderId;
                          const senderDetails = chatData.participantDetails[senderId];
                          const senderName = senderDetails ? senderDetails.name : "Someone";
                          showSystemNotification(senderName, chatData.lastMessage, chatId);
                      }
                  }
              }
          });
      });

    // --- 2. APP NOTIFICATIONS (Red Badge & Sound) ---
    // Listen for unread notifications
    db.collection('users').doc(currentUser.uid).collection('notifications')
      .where('read', '==', false)
      .onSnapshot(snapshot => {
          const badge = document.getElementById('notif-badge');
          
          if(!snapshot.empty) {
              badge.style.display = 'block';

              // PLAY SOUND LOGIC
              // Iterate through changes to see if a NEW document was added
              snapshot.docChanges().forEach(change => {
                  if (change.type === "added") {
                      // Play a gentle "Ding" sound
                      const audio = new Audio('https://campuspoint.netlify.app/notification.mp3');
                      audio.volume = 0.5; // 50% volume
                      
                      // Play and catch errors (e.g., if user hasn't interacted with page yet)
                      audio.play().catch(e => console.log("Audio autoplay blocked:", e));
                  }
              });

          } else {
              badge.style.display = 'none';
          }
      });
}

function showSystemNotification(title, body, chatId) {
    if (Notification.permission === "granted") {
        const options = {
            body: body,
            icon: 'https://ik.imagekit.io/rstofficial/CAMPUS.png',
            badge: 'https://ik.imagekit.io/rstofficial/campuspoint-notificationbadge2.png', // Android specific (small icon)
            vibrate: [200, 100, 200],
            tag: chatId,
            data: { url: `chat.html?chatId=${chatId}` } // Pass URL to Service Worker
        };

        // ANDROID FIX: Ask Service Worker to show it
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(function(registration) {
                registration.showNotification(`New message from ${title}`, options);
            });
        } else {
            // Fallback for Desktop if SW fails
            new Notification(`New message from ${title}`, options);
        }
    }
}

// Add this helper function to your script block
function getHobbyDetails(hobby) {
    // A stable, unique color for each hobby, visible on both themes.
    const colorMap = {
        "Coding": "#FF5555", "Music": "#D35400", "Travel": "#4DABF8",
        "Gaming": "#9B59B6", "Reading": "#2ECC71", "Fitness": "#E67E22",
        "Photography": "#F39C12", "Art": "#E91E63", "Startups": "#3498DB",
        "AI": "#1ABC9C", "Foodie": "#D35400", "Movies": "#AF7AC5",
        "Sports": "#E74C3C", "Writing": "#00BCD4", "Dance": "#34495E",
        "Nature": "#16A085", "Fashion": "#95A5A6", "Politics": "#7F8C8D"
    };
    return colorMap[hobby] || 'var(--text-secondary)';
}

    // --- NEW GPS HANDLING LOGIC ---
// --- ADVANCED GPS HANDLING ---

let gpsWatcher = null; // Store permission listener

function requestGPS() {
    const MAX_RANGE = 5000;
    const statusEl = document.getElementById('gps-status-indicator');
    
    // Display the max range in the indicator area
    statusEl.innerHTML = `<i class="fa-solid fa-satellite-dish"></i> RANGE: <span style="color:#4dabf8">${MAX_RANGE / 1000} KM</span>`;

    // 1. Check if Permissions API is supported
    if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
            
            // Handle current state
            handlePermissionState(result.state);

            // Listen for changes (e.g. if user resets settings while on page)
            result.onchange = function() {
                handlePermissionState(this.state);
            };
        });
    } else {
        // Fallback for older browsers
        attemptGeoFetch();
    }
}

function handlePermissionState(state) {
    const statusEl = document.getElementById('gps-status-indicator');
    const warningDiv = document.getElementById('radar-permission-warning');
    const contentDiv = document.getElementById('radar-content');
    const msg = document.getElementById('gps-msg');
    const manualInst = document.getElementById('gps-manual-instruction');
    const retryBtn = document.getElementById('btn-gps-retry');

    // Reset UI visibility
    contentDiv.classList.add('hidden');
    warningDiv.classList.remove('hidden');
    warningDiv.style.display = 'flex';
    manualInst.classList.add('hidden');

    if (state === 'granted') {
        // PERMISSION GRANTED: Go ahead
        statusEl.innerHTML = 'STATUS: <span style="color:#4dabf8">ACTIVE</span>';
        warningDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
        attemptGeoFetch(); // Actually get the coords
    } 
    else if (state === 'prompt') {
        // PROMPT: User hasn't decided yet
        statusEl.innerHTML = 'STATUS: <span style="color:#FFD700">WAITING</span>';
        msg.innerText = "Please tap 'Allow' when the browser popup appears.";
        retryBtn.style.display = 'block';
    } 
    else if (state === 'denied') {
        // DENIED: User blocked it. Button won't work.
        statusEl.innerHTML = 'STATUS: <span style="color:#ff5555">BLOCKED</span>';
        msg.innerText = "Location access is blocked. We cannot open the popup again.";
        manualInst.classList.remove('hidden'); // Show instruction how to fix
        retryBtn.style.display = 'none'; // Hide button since it won't work
    }
}

function attemptGeoFetch() {
    if (!navigator.geolocation) return alert("GPS not supported");

    navigator.geolocation.getCurrentPosition(
        (position) => {
            // SUCCESS
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            myLocation = { lat, lng };

            db.collection('users').doc(currentUser.uid).update({
                location: { lat, lng },
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Ensure UI is correct (in case Permissions API wasn't supported)
            document.getElementById('radar-permission-warning').classList.add('hidden');
            document.getElementById('radar-content').classList.remove('hidden');
            
            loadNearbyUsers();
        },
        (error) => {
            // ERROR (Denied or Timeout)
            console.warn("GPS Error", error);
            // If error is PERMISSION_DENIED (code 1), force denied state UI
            if(error.code === 1) handlePermissionState('denied');
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function retryGPS() {
    attemptGeoFetch();
}

    // --- AUTH & FLOW ---
    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => alert(err.message));
    }

    function checkUserProfile(user) {
        db.collection('users').doc(user.uid).get().then(doc => {
            if (doc.exists) {
                globalProfileData = doc.data();
                loadAppInterface(globalProfileData);
            } else {
                document.getElementById('setup-name').value = user.displayName;
                switchTab('setup', null);
            }
        });
    }

    async function completeSetup() {
    const name = document.getElementById('setup-name').value;
    const uni = document.getElementById('setup-university').value;
    const major = document.getElementById('setup-major').value;
    const year = document.getElementById('setup-year').value;
    const bio = document.getElementById('setup-bio').value;
    const futureGoal = document.getElementById('setup-goal').value;
    
    // NEW: Get the file
    const fileInput = document.getElementById('setup-file-input');
    const saveBtn = document.getElementById('btn-save-profile');

    if(!name || !uni || !major) return alert("Required fields missing");

    // UI Feedback
    saveBtn.innerText = "SAVING...";
    saveBtn.disabled = true;

    try {
        let finalPhotoURL = currentUser.photoURL; // Default to existing

        // Check if user selected a NEW file
        if (finalCroppedFile) {
            saveBtn.innerText = "UPLOADING IMAGE...";
            
            // 1. Compress (optional, since we resized in cropper, but good for safety)
            const compressed = await compressImage(finalCroppedFile);
            
            // 2. Upload
            const newUrl = await uploadToImageKit(compressed);
            
            if (newUrl) {
                finalPhotoURL = newUrl;
                await currentUser.updateProfile({ photoURL: finalPhotoURL });
            }
        }

        const userData = {
            uid: currentUser.uid, 
            displayName: name, 
            email: currentUser.email, 
            photoURL: finalPhotoURL, // Save the new URL to Firestore
            bannerUrl: selectedBannerUrl,
            academic: { university: uni, major: major, year: year },
            bio: bio,
            futureGoal: futureGoal,
            interests: Array.from(selectedHobbies),
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Send update
        await db.collection('users').doc(currentUser.uid).set(userData, { merge: true });

        // Update local data
        globalProfileData = { ...globalProfileData, ...userData };
        loadAppInterface(globalProfileData);
        
        // Reset UI
        saveBtn.innerText = "SAVE PROFILE";
        saveBtn.disabled = false;

        finalCroppedFile = null;
        
        // Clear file input
        fileInput.value = ""; 
        
        showShareModal(); // Or switchTab('profile')

    } catch (e) {
        console.error(e);
        alert("Error saving profile: " + e.message);
        saveBtn.innerText = "SAVE PROFILE";
        saveBtn.disabled = false;
    }
}

    // Find and replace this function in index.html
function renderHobbiesSelector() {
    const container = document.getElementById('setup-interests');
    container.innerHTML = '';
    HOBBIES_LIST.forEach(hobby => {
        const chip = document.createElement('div');
        const uniqueColor = getHobbyDetails(hobby); // Get unique color
        
        chip.className = 'interest-chip';
        
        // Apply color styles
        chip.style.borderColor = uniqueColor;
        chip.style.color = uniqueColor;
        
        if(selectedHobbies.has(hobby)) {
            chip.classList.add('selected');
            // Overwrite styles for selected state
            chip.style.backgroundColor = uniqueColor;
            chip.style.color = 'white';
            chip.style.boxShadow = `0 0 10px ${uniqueColor}50`; // Semi-transparent glow
        }
        
        chip.innerText = hobby;
        chip.onclick = () => {
            if(selectedHobbies.has(hobby)) {
                selectedHobbies.delete(hobby);
                chip.classList.remove('selected');
                // Restore unselected styles
                chip.style.backgroundColor = 'var(--bg-card)';
                chip.style.color = uniqueColor;
                chip.style.boxShadow = 'none';
            }
            else {
                selectedHobbies.add(hobby);
                chip.classList.add('selected');
                // Apply selected styles
                chip.style.backgroundColor = uniqueColor;
                chip.style.color = 'white';
                chip.style.boxShadow = `0 0 10px ${uniqueColor}50`;
            }
        };
        container.appendChild(chip);
    });
}

function updateBioCount() {
    const len = document.getElementById('setup-bio').value.length;
    document.getElementById('bio-count').innerText = `${len}/150`;
}

    function loadAppInterface(userData) {
        // Setup Header & My Profile
        document.getElementById('header-avatar').src = userData.photoURL;
        document.getElementById('header-avatar').style.display = 'block';
        document.getElementById('profile-pic').src = userData.photoURL;
        document.getElementById('profile-name').innerText = userData.displayName;
        document.getElementById('profile-academic').innerText = `${userData.academic.major} â€¢ ${userData.academic.year}`;
        document.getElementById('profile-uni').innerText = userData.academic.university;
        document.getElementById('profile-bio').innerText = userData.bio || "";
        document.getElementById('profile-banner').src = userData.bannerUrl || DEFAULT_BANNER;

        // 2. Show Goal
if(userData.futureGoal) {
    document.getElementById('profile-goal').innerText = userData.futureGoal;
    document.getElementById('profile-goal-container').style.display = 'block';
} else {
    document.getElementById('profile-goal-container').style.display = 'none';
}

startNotificationListener(); 
loadGroupLobby();
startStoryListener();

// 3. Show Interests
const intContainer = document.getElementById('profile-interests');
intContainer.innerHTML = '';
(userData.interests || []).forEach(hobby => {
    const span = document.createElement('div');
    span.className = 'interest-chip selected display-only';
    
    // --- START NEW COLOR CODE ---
    const uniqueColor = getHobbyDetails(hobby);
    span.style.backgroundColor = uniqueColor;
    span.style.borderColor = uniqueColor;
    span.style.color = 'white';
    // --- END NEW COLOR CODE ---
    
    span.innerText = hobby;
    intContainer.appendChild(span);
});
        
        // Load Stats
        // Load Stats (Updated with OnClick)
const followerEl = document.getElementById('stat-followers');
followerEl.innerText = userData.followersCount || 0;
followerEl.parentElement.style.cursor = "pointer";
followerEl.parentElement.onclick = () => openFollowList('followers', currentUser.uid, 'profile');

const followingEl = document.getElementById('stat-following');
followingEl.innerText = userData.followingCount || 0;
followingEl.parentElement.style.cursor = "pointer";
followingEl.parentElement.onclick = () => openFollowList('following', currentUser.uid, 'profile');

        document.getElementById('main-nav').classList.remove('hidden');

        // GPS Logic
        requestGPS();
        // 2. Set up a loop to update every 5 minutes (300,000 milliseconds)
        // This keeps location fresh without killing battery or Quota
        if (window.gpsInterval) clearInterval(window.gpsInterval); // Clear existing if any
        
        window.gpsInterval = setInterval(() => {
            console.log("Auto-updating GPS location...");
            attemptGeoFetch(); 
        }, 300000); // 300000ms = 5 minutes

        startFeedListener();
        loadProfilePosts();
        loadChatList(); // Load Chats
        
        switchTab('feed', document.querySelector('.nav-item'));
    }


    /* --- STORY SYSTEM VARIABLES --- */
let activeStories = {}; // Objects grouped by UID: { uid: [story1, story2] }
let currentViewerStories = []; // Array of stories being viewed currently
let currentStoryIndex = 0;
let storyTimer = null;
let currentStoryUid = null; // UID of the user whose stories we are watching

// --- 1. LISTEN TO STORIES ---
function startStoryListener() {
    const now = Date.now();
    // Query stories that expire in the future
    db.collection('stories')
      .where('expiresAt', '>', now) 
      .orderBy('expiresAt', 'asc') // This is needed for the > query
      .onSnapshot(snapshot => {
          
          activeStories = {}; // Reset local cache
          
          snapshot.forEach(doc => {
              const s = doc.data();
              s.id = doc.id;
              
              if(!activeStories[s.uid]) {
                  activeStories[s.uid] = [];
              }
              activeStories[s.uid].push(s);
          });

          renderStoryTray();
      });
}

// --- 2. RENDER THE TRAY ---
function renderStoryTray() {
    const tray = document.getElementById('stories-tray');
    tray.innerHTML = '';

    // --- 1. RENDER "MY STORY" (ALWAYS FIRST) ---
    const myStories = activeStories[currentUser.uid] || [];
    const hasMyStory = myStories.length > 0;
    
    let myRingClass = 'none';
    if (hasMyStory) {
        myRingClass = 'seen'; 
    }

    // HTML for My Story
    tray.innerHTML += `
        <div class="story-item" onclick="handleMyStoryClick(${hasMyStory})">
            <div class="story-ring-container ${myRingClass}">
                <div class="story-avatar" style="background-image: url('${currentUser.photoURL}')"></div>
                ${!hasMyStory ? '<div class="add-story-badge"><i class="fa-solid fa-plus"></i></div>' : ''}
            </div>
            <div class="story-username">Your Story</div>
        </div>
    `;

    // --- 2. PREPARE & SORT OTHER USERS ---
    // A. Filter out "Me" and create an array of user objects with their latest timestamp
    let storyUsers = Object.keys(activeStories)
        .filter(uid => uid !== currentUser.uid) // Exclude myself
        .map(uid => {
            const stories = activeStories[uid];
            // The last story in the array is the newest one (due to Firestore query order)
            const latestStory = stories[stories.length - 1]; 
            
            // Get timestamp (handle potential nulls safely)
            const time = latestStory.timestamp ? latestStory.timestamp.toDate().getTime() : 0;
            
            return {
                uid: uid,
                stories: stories,
                latestStory: latestStory,
                timestamp: time
            };
        });

    // B. Sort descending (Newest time first)
    storyUsers.sort((a, b) => b.timestamp - a.timestamp);

    // --- 3. RENDER SORTED USERS ---
    storyUsers.forEach(user => {
        const uid = user.uid;
        const stories = user.stories;
        const lastStory = user.latestStory;
        
        // Determine if seen (if any story in the stack is unseen, show colorful ring)
        let isUnseen = false;
        for (let s of stories) {
            if(!s.viewers || !s.viewers.includes(currentUser.uid)) {
                isUnseen = true;
                break; // Found one unseen, that's enough to mark the ring
            }
        }

        const ringClass = isUnseen ? 'unseen' : 'seen';

        tray.innerHTML += `
            <div class="story-item" onclick="openStoryViewer('${uid}')">
                <div class="story-ring-container ${ringClass}">
                    <div class="story-avatar" style="background-image: url('${lastStory.userPhoto}')"></div>
                </div>
                <div class="story-username">${lastStory.userName.split(' ')[0]}</div>
            </div>
        `;
    });
}

// --- 3. UPLOAD STORY ---
function handleMyStoryClick(hasStory) {
    if (hasStory) {
        // Show the custom modal instead of confirm()
        const modal = document.getElementById('story-options-modal');
        modal.classList.add('flex'); // Uses flex to align to bottom
    } else {
        // No story yet? Go straight to upload
        triggerAddStory();
    }
}

// --- NEW HELPER FUNCTIONS ---

function hideStoryOptions() {
    const modal = document.getElementById('story-options-modal');
    modal.classList.remove('flex');
}

function triggerViewStory() {
    hideStoryOptions();
    openStoryViewer(currentUser.uid);
}

function triggerAddStory() {
    hideStoryOptions();
    document.getElementById('story-file-input').click();
}

function handleStoryFileSelect() {
    startCropper('story-file-input', 'story');
}

function startCropper(inputId, context) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    cropContext = context;

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgElement = document.getElementById('cropper-target-img');
            imgElement.src = e.target.result;
            document.getElementById('cropper-modal').style.display = 'flex';

            if(cropper) cropper.destroy();

            // Config based on context
            let aspectRatio = NaN; // Free crop for posts
            if(context === 'profile') aspectRatio = 1; 
            if(context === 'story') aspectRatio = 9/16; 

            cropper = new Cropper(imgElement, {
                aspectRatio: aspectRatio,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.9,
                background: false,
            });
        }
        reader.readAsDataURL(file);
    }
    fileInput.value = ""; // Reset input
}

function finishCrop() {
    if(!cropper) return;

    // Output Size
    const canvas = cropper.getCroppedCanvas({
        width: cropContext === 'profile' ? 500 : 1080, 
    });

    canvas.toBlob((blob) => {
        // --- PROFILE FLOW ---
        if(cropContext === 'profile') {
            finalCroppedFile = new File([blob], "profile.jpg", { type: "image/jpeg" });
            document.getElementById('setup-pic-preview').src = URL.createObjectURL(finalCroppedFile);
            document.getElementById('cropper-modal').style.display = 'none';
        }
        
        // --- POST FLOW ---
        else if (cropContext === 'post') {
            finalPostFile = new File([blob], "post.jpg", { type: "image/jpeg" });
            document.getElementById('preview-img').src = URL.createObjectURL(finalPostFile);
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('cropper-modal').style.display = 'none';
        }

        // --- STORY FLOW (Pass to Fabric Editor) ---
        else if (cropContext === 'story') {
            document.getElementById('cropper-modal').style.display = 'none';
            // Open the Advanced Story Editor with the cropped image
            initStoryEditor(URL.createObjectURL(blob));
        }

        cropper.destroy();
        cropper = null;

    }, 'image/jpeg', 0.9);
}

// --- STORY EDITOR (FABRIC JS) LOGIC ---

function initStoryEditor(imageUrl) {
    const modal = document.getElementById('story-editor-modal');
    modal.style.display = 'flex';

    // 1. Setup Canvas (Responsive)
    const wrapper = document.getElementById('canvas-wrapper');
    const width = wrapper.clientWidth;
    const height = wrapper.clientHeight;

    // Create Fabric Canvas
    if(fabricCanvas) fabricCanvas.dispose();
    
    // Create canvas element dynamically to reset it
    document.getElementById('story-canvas').remove();
    const newCanvas = document.createElement('canvas');
    newCanvas.id = 'story-canvas';
    wrapper.appendChild(newCanvas);

    fabricCanvas = new fabric.Canvas('story-canvas', {
        width: width,
        height: height,
        backgroundColor: '#000'
    });

    fabricCanvas.on('mouse:down', function(options) {
        if (options.target) {
            // Check if it is a text object
            if (options.target.type === 'i-text') {
                // Prevent default editing
                options.target.editable = false; 
                // Open custom dialog
                openTextEditor(options.target);
            }
        }
    });

    // 2. Load Image as Background (Fit to screen)
    fabric.Image.fromURL(imageUrl, function(img) {
        // Scale image to fit contained
        const scale = Math.min(width / img.width, height / img.height);
        
        img.set({
            originX: 'center',
            originY: 'center',
            left: width / 2,
            top: height / 2,
            scaleX: scale,
            scaleY: scale
        });
        
        fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
        saveHistory(); // Initial state
    });

    // Reset History
    editorHistory = [];
    historyStep = -1;

    // Listen for changes to save history
    fabricCanvas.on('object:modified', saveHistory);
    fabricCanvas.on('object:added', saveHistory);
}

// --- TEXT & FONT LOGIC ---

let activeTextObject = null; // Track which text is being edited

function addNewTextLayer() {
    const text = new fabric.IText('Type here', {
        left: fabricCanvas.width / 2,
        top: fabricCanvas.height / 2,
        fontFamily: 'Inter',
        fill: '#ffffff',
        fontSize: 40,
        fontWeight: 'bold',
        originX: 'center',
        originY: 'center',
        shadow: 'rgba(0,0,0,0.8) 2px 2px 5px',
        editable: false // Disable built-in edit, use our dialog
    });
    fabricCanvas.add(text);
    fabricCanvas.setActiveObject(text);
    openTextEditor(text); // Open dialog immediately
}

function openTextEditor(obj) {
    activeTextObject = obj;
    document.getElementById('story-text-input').value = obj.text;
    document.getElementById('text-edit-dialog').style.display = 'flex';
}

function saveTextEdit() {
    if (activeTextObject) {
        const val = document.getElementById('story-text-input').value;
        activeTextObject.set({ text: val });
        fabricCanvas.renderAll();
        saveHistory();
    }
    document.getElementById('text-edit-dialog').style.display = 'none';
}

function deleteActiveObject() {
    if (activeTextObject) {
        fabricCanvas.remove(activeTextObject);
        saveHistory();
    }
    document.getElementById('text-edit-dialog').style.display = 'none';
}

function toggleFonts() {
    const tray = document.getElementById('font-tray');
    // Hide sticker tray if open
    document.getElementById('sticker-tray').style.display = 'none';
    
    tray.style.display = (tray.style.display === 'flex') ? 'none' : 'flex';
}

function applyFont(fontName) {
    const activeObj = fabricCanvas.getActiveObject();
    if (activeObj && activeObj.type === 'i-text') {
        activeObj.set({ fontFamily: fontName });
        fabricCanvas.renderAll();
        saveHistory();
    } else {
        alert("Please select a text element first.");
    }
}

// --- MENTION LOGIC ---

function openMentionDialog() {
    document.getElementById('mention-modal').style.display = 'flex';
    document.getElementById('mention-search').value = '';
    document.getElementById('mention-results').innerHTML = '';
    document.getElementById('mention-search').focus();
}

function searchUsersForMention(query) {
    const resDiv = document.getElementById('mention-results');
    if(query.length < 2) {
        resDiv.innerHTML = '';
        return;
    }

    // Simple startAt search (Case sensitive in Firestore usually, but good enough for MVP)
    db.collection('users')
        .where('displayName', '>=', query)
        .where('displayName', '<=', query + '\uf8ff')
        .limit(5)
        .get()
        .then(snapshot => {
            resDiv.innerHTML = '';
            snapshot.forEach(doc => {
                const u = doc.data();
                resDiv.innerHTML += `
                    <div class="search-item" onclick="addMentionToStory('${u.uid}', '${u.displayName}')">
                        <div class="avatar" style="background-image: url('${u.photoURL}')"></div>
                        <div>
                            <div style="font-weight:600">${u.displayName}</div>
                            <div style="font-size:0.8rem;color:#888">${u.academic.major}</div>
                        </div>
                    </div>
                `;
            });
        });
}

function addMentionToStory(uid, name) {
    document.getElementById('mention-modal').style.display = 'none';
    
    // Create text object with custom property 'mentionedUid'
    const text = new fabric.IText(`@${name}`, {
        left: fabricCanvas.width / 2,
        top: fabricCanvas.height / 2,
        fontFamily: 'Inter',
        fill: '#FFD700', // Gold color for mentions
        fontSize: 35,
        fontWeight: 'bold',
        originX: 'center',
        originY: 'center',
        shadow: 'rgba(0,0,0,0.8) 2px 2px 5px',
        editable: false,
        // CUSTOM DATA
        mentionedUid: uid 
    });

    fabricCanvas.add(text);
    fabricCanvas.setActiveObject(text);
    saveHistory();
}

// --- TOOLS ---

function addStoryText() {
    const text = new fabric.IText('Type here...', {
        left: 50,
        top: 100,
        fontFamily: 'Inter',
        fill: '#ffffff',
        fontSize: 40,
        fontWeight: 'bold',
        shadow: 'rgba(0,0,0,0.8) 2px 2px 5px'
    });
    
    // Cycle fonts on click
    text.on('mousedown', function() {
        const fonts = ['Inter', 'JetBrains Mono', 'cursive', 'serif'];
        const current = text.fontFamily;
        let nextIndex = fonts.indexOf(current) + 1;
        if(nextIndex >= fonts.length) nextIndex = 0;
        text.set('fontFamily', fonts[nextIndex]);
        fabricCanvas.renderAll();
    });

    fabricCanvas.add(text);
    fabricCanvas.setActiveObject(text);
    text.enterEditing();
}

function toggleStickers() {
    const tray = document.getElementById('sticker-tray');
    tray.style.display = tray.style.display === 'flex' ? 'none' : 'flex';
}

function addSticker(emoji) {
    const text = new fabric.Text(emoji, {
        left: fabricCanvas.width / 2,
        top: fabricCanvas.height / 2,
        fontSize: 80,
        selectable: true
    });
    fabricCanvas.add(text);
    toggleStickers(); // Hide tray
}

// --- UNDO / REDO ---

function saveHistory() {
    // Keep only the last 10 states for performance
    if(historyStep < editorHistory.length - 1) {
        editorHistory = editorHistory.slice(0, historyStep + 1);
    }
    editorHistory.push(JSON.stringify(fabricCanvas));
    historyStep++;
}

function editorUndo() {
    if (historyStep > 0) {
        historyStep--;
        fabricCanvas.loadFromJSON(editorHistory[historyStep], fabricCanvas.renderAll.bind(fabricCanvas));
    }
}

function editorRedo() {
    if (historyStep < editorHistory.length - 1) {
        historyStep++;
        fabricCanvas.loadFromJSON(editorHistory[historyStep], fabricCanvas.renderAll.bind(fabricCanvas));
    }
}

function closeStoryEditor() {
    document.getElementById('story-editor-modal').style.display = 'none';
    document.getElementById('story-file-input').value = "";
}

// --- FINAL UPLOAD ---

function uploadStoryFromCanvas() {
    document.getElementById('story-canvas').toBlob(async (blob) => {
        if (!blob) return alert("Canvas error");

        closeStoryEditor();
        showUploadModal("Uploading Story...");

        try {
            // 1. Compress
            const file = new File([blob], "story.jpg", { type: "image/jpeg" });
            const compressed = await compressImage(file);
            
            // 2. Upload
            const url = await uploadToImageKit(compressed);
            if(!url) throw new Error("Upload failed");

            // 3. Scan for Mentions (Collect UIDs)
            const objects = fabricCanvas.getObjects();
            let mentionedUserIds = [];
            
            objects.forEach(obj => {
                if (obj.mentionedUid) {
                    mentionedUserIds.push(obj.mentionedUid);
                }
            });
            // Remove duplicates
            mentionedUserIds = [...new Set(mentionedUserIds)];

            // 4. Save Story
            const expiresAt = Date.now() + (24 * 60 * 60 * 1000); 
            const myName = globalProfileData.displayName || currentUser.displayName;
            
            await db.collection('stories').add({
                uid: currentUser.uid,
                userName: myName,
                userPhoto: globalProfileData.photoURL || currentUser.photoURL,
                imageUrl: url,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                expiresAt: expiresAt,
                viewers: [],
                mentions: mentionedUserIds // Save metadata if needed later
            });

            // 5. Send Notifications
            const notifBatch = db.batch();
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            mentionedUserIds.forEach(targetUid => {
                const ref = db.collection('users').doc(targetUid).collection('notifications').doc();
                notifBatch.set(ref, {
                    type: 'mention',
                    fromUid: currentUser.uid,
                    fromName: myName,
                    fromPhoto: globalProfileData.photoURL || currentUser.photoURL,
                    text: "mentioned you in their story.",
                    timestamp: timestamp,
                    read: false
                });
            });
            
            await notifBatch.commit();

            updateProgressBar(100);

            const successAudio = new Audio('https://campuspoint.netlify.app/success.mp3');
            successAudio.volume = 0.5;
            successAudio.play().catch(e => console.log("Audio play failed", e));

            setTimeout(() => { hideUploadModal(); }, 500);

        } catch (e) {
            console.error(e);
            hideUploadModal();
            alert("Story upload failed.");
        }
    }, 'image/jpeg', 0.85);
}

// --- NOTIFICATION HELPER ---
function sendAppNotification(targetUid, type, text, postId = null, postThumb = null) {
    if (!targetUid || targetUid === currentUser.uid) return;

    const myName = globalProfileData.displayName || currentUser.displayName;
    const myPhoto = globalProfileData.photoURL || currentUser.photoURL;
    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

    // Unique ID logic for likes to prevent spam
    let docId = null;
    if (type === 'like' && postId) {
        docId = `${postId}_${currentUser.uid}`;
    }

    const notifData = {
        type: type,
        fromUid: currentUser.uid,
        fromName: myName,
        fromPhoto: myPhoto,
        text: text,
        timestamp: timestamp,
        read: false,
        postId: postId,
        postThumb: postThumb // <--- SAVING THE IMAGE URL
    };

    const ref = db.collection('users').doc(targetUid).collection('notifications');

    if (docId) {
        ref.doc(docId).set(notifData);
    } else {
        ref.add(notifData);
    }
}

// --- 4. VIEW STORY VIEWER ---
function openStoryViewer(uid) {
    currentStoryUid = uid;
    currentViewerStories = activeStories[uid];
    
    if(!currentViewerStories || currentViewerStories.length === 0) return;

    // Find the first unseen story index
    let startIndex = 0;
    for(let i=0; i<currentViewerStories.length; i++) {
        if(!currentViewerStories[i].viewers || !currentViewerStories[i].viewers.includes(currentUser.uid)) {
            startIndex = i;
            break;
        }
    }

    currentStoryIndex = startIndex;
    
    document.getElementById('story-viewer-modal').style.display = 'flex';
    showStoryAtIndex(currentStoryIndex);
}

function showStoryAtIndex(index) {
    if(index >= currentViewerStories.length) {
        closeStoryViewer();
        return;
    }
    if(index < 0) {
        index = 0; 
    }

    currentStoryIndex = index;
    const story = currentViewerStories[index];

    // 1. Update UI
    document.getElementById('sv-image').src = story.imageUrl;
    
    const avatarEl = document.getElementById('sv-avatar');
    avatarEl.style.backgroundImage = `url('${story.userPhoto}')`;
    avatarEl.onclick = (e) => { e.stopPropagation(); closeStoryViewer(); openUserProfile(story.uid); };

    const nameEl = document.getElementById('sv-name');
    nameEl.innerText = story.userName;
    nameEl.onclick = (e) => { e.stopPropagation(); closeStoryViewer(); openUserProfile(story.uid); };
    
    // Time calc
    const now = Date.now();
    const created = story.timestamp ? story.timestamp.toDate().getTime() : now;
    const diffMins = Math.floor((now - created) / 60000);
    let timeText = diffMins + "m";
    if(diffMins > 60) timeText = Math.floor(diffMins/60) + "h";
    document.getElementById('sv-time').innerText = timeText;

    // --- NEW: Views & Delete Logic ---
    const viewsBtn = document.getElementById('sv-views-btn');
    const delBtn = document.getElementById('sv-delete-btn');

    if(story.uid === currentUser.uid) {
        // IT IS MY STORY
        delBtn.style.display = 'block';
        
        // Show View Count
        const viewCount = story.viewers ? story.viewers.length : 0;
        document.getElementById('sv-views-count').innerText = viewCount;
        viewsBtn.style.display = 'flex';
        
    } else {
        // OTHER USER STORY
        delBtn.style.display = 'none';
        viewsBtn.style.display = 'none'; // Hide views for others
        markStoryAsSeen(story.id);
    }

    // 3. Render Progress Bars
    renderProgressBars();

    // 4. Start Timer (5 seconds)
    resetStoryTimer();
}

function openStoryViews(event) {
    if(event) event.stopPropagation();

    // 1. Pause the Story Timer so it doesn't skip while looking at list
    if(storyTimer) clearTimeout(storyTimer);

    // 2. Show Modal
    const modal = document.getElementById('views-modal');
    modal.style.display = 'flex';
    
    // 3. Get Current Story Viewers
    const story = currentViewerStories[currentStoryIndex];
    const viewerIds = story.viewers || [];
    const container = document.getElementById('views-list-content');

    if (viewerIds.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:30px;">No views yet.</p>';
        return;
    }

    container.innerHTML = '<div class="loader-spinner" style="margin: 30px auto;"></div>';

    // 4. Fetch User Profiles for each Viewer ID
    // Note: In a large app, you'd use pagination or cache. 
    // For this, we'll fetch them individually (Promises).
    const promises = viewerIds.map(uid => db.collection('users').doc(uid).get());

    Promise.all(promises).then(snapshots => {
        container.innerHTML = '';
        
        snapshots.forEach(doc => {
            if(doc.exists) {
                const u = doc.data();
                // Reuse your existing list item renderer!
                container.innerHTML += renderUserListItem(u);
            }
        });
    }).catch(err => {
        console.error(err);
        container.innerHTML = '<p style="text-align:center; color:#ff5555;">Error loading views.</p>';
    });
}

function closeStoryViews() {
    document.getElementById('views-modal').style.display = 'none';
    
    // Resume the story timer!
    resetStoryTimer();
}

function renderProgressBars() {
    const container = document.getElementById('story-progress-bars');
    container.innerHTML = '';
    
    currentViewerStories.forEach((s, idx) => {
        const bar = document.createElement('div');
        bar.className = 'story-progress-bar';
        
        const fill = document.createElement('div');
        fill.className = 'story-progress-fill';
        
        if(idx < currentStoryIndex) {
            fill.style.width = '100%'; // Already seen
        } else if (idx === currentStoryIndex) {
            // Animate current
            fill.style.width = '0%';
            setTimeout(() => { fill.style.width = '100%'; fill.style.transition = 'width 5s linear'; }, 50);
        } else {
            fill.style.width = '0%'; // Future
        }
        
        bar.appendChild(fill);
        container.appendChild(bar);
    });
}

function resetStoryTimer() {
    if(storyTimer) clearTimeout(storyTimer);
    storyTimer = setTimeout(() => {
        nextStory();
    }, 5000); // 5 seconds per story
}

function nextStory() {
    showStoryAtIndex(currentStoryIndex + 1);
}

function prevStory() {
    showStoryAtIndex(currentStoryIndex - 1);
}

function closeStoryViewer() {
    document.getElementById('story-viewer-modal').style.display = 'none';
    if(storyTimer) clearTimeout(storyTimer);
    // Refresh tray to update ring colors
    renderStoryTray();
}

function markStoryAsSeen(storyId) {
    // Optimistic check: don't write if already seen
    // But for simplicity, arrayUnion handles uniqueness
    db.collection('stories').doc(storyId).update({
        viewers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
}

function deleteCurrentStory() {
    const story = currentViewerStories[currentStoryIndex];
    if(!story) return;
    
    if(confirm("Delete this story?")) {
        db.collection('stories').doc(story.id).delete().then(() => {
            alert("Deleted");
            // Remove from local array immediately for UI smoothness
            currentViewerStories.splice(currentStoryIndex, 1);
            if(currentViewerStories.length === 0) {
                closeStoryViewer();
            } else {
                showStoryAtIndex(currentStoryIndex); // Will show next or stay
            }
        });
    }
}

    // --- PROFILE & FOLLOW SYSTEM ---
    // --- REPLACE YOUR EXISTING openUserProfile FUNCTION WITH THIS ---

function openUserProfile(uid) {
    if (uid === currentUser.uid) {
        window.location.hash = 'profile';
        return;
    }
    viewingUserId = uid;

    // Clear previous data
    document.getElementById('other-profile-feed').innerHTML = '<p style="text-align:center;padding:20px;color:#666">Loading posts...</p>';

    db.collection('users').doc(uid).onSnapshot(doc => {
        const u = doc.data();
        document.getElementById('other-banner').src = u.bannerUrl || DEFAULT_BANNER;
        document.getElementById('other-pic').style.backgroundImage = `url('${u.photoURL}')`;
        document.getElementById('other-name').innerText = u.displayName;

        // Academic Info
        document.getElementById('other-academic').innerText = `${u.academic.major} â€¢ ${u.academic.year} â€¢ ${u.academic.university}`;

        // Stats
        const otherFollowerEl = document.getElementById('other-stat-followers');
        otherFollowerEl.innerText = u.followersCount || 0;
        otherFollowerEl.parentElement.style.cursor = "pointer";
        otherFollowerEl.parentElement.onclick = () => openFollowList('followers', uid, 'other-profile');

        const otherFollowingEl = document.getElementById('other-stat-following');
        otherFollowingEl.innerText = u.followingCount || 0;
        otherFollowingEl.parentElement.style.cursor = "pointer";
        otherFollowingEl.parentElement.onclick = () => openFollowList('following', uid, 'other-profile');

        document.getElementById('other-bio').innerText = u.bio || "No bio.";

        // Goals
        if (u.futureGoal) {
            document.getElementById('other-goal').innerText = u.futureGoal;
            document.getElementById('other-goal-container').style.display = 'block';
        } else {
            document.getElementById('other-goal-container').style.display = 'none';
        }

        // --- FIXED INTERESTS RENDERING WITH COLORS ---
        const intContainer = document.getElementById('other-interests');
        intContainer.innerHTML = '';
        (u.interests || []).forEach(hobby => {
            const span = document.createElement('div');
            span.className = 'interest-chip selected display-only';
            
            // 1. Get the unique color
            const uniqueColor = getHobbyDetails(hobby);
            
            // 2. Apply the styles manually
            span.style.backgroundColor = uniqueColor;
            span.style.borderColor = uniqueColor;
            span.style.color = 'white';
            
            span.innerText = hobby;
            intContainer.appendChild(span);
        });
        // ---------------------------------------------

        // Follow Button Check
        db.collection('users').doc(currentUser.uid).collection('following').doc(uid).get().then(fDoc => {
            const btn = document.getElementById('btn-follow');
            if (fDoc.exists) {
                btn.innerText = "Unfollow";
                btn.style.background = "var(--bg-card)";
                btn.style.border = "1px solid var(--border)";
                btn.style.color = "var(--text-primary)";
            } else {
                btn.innerText = "Follow";
                btn.style.background = "var(--accent)";
                btn.style.border = "none";
                btn.style.color = "#ffffff";
            }
        });

        // Load their posts
        loadOtherUserPosts(uid);

        window.location.hash = 'other-profile';
    });
}

    function loadOtherUserPosts(uid) {
    db.collection('posts')
        .where('uid', '==', uid)
        .orderBy('timestamp', 'desc')
        .get()
        .then(snapshot => {
            const container = document.getElementById('other-profile-feed');
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">No posts yet.</p>';
                return;
            }

            // PASS 'other' HERE
            snapshot.forEach(doc => {
                container.appendChild(renderPost(doc, 'other'));
            });
        });
}

    function toggleFollow() {
    if(!viewingUserId) return;
    
    const myRef = db.collection('users').doc(currentUser.uid);
    const otherRef = db.collection('users').doc(viewingUserId);
    
    myRef.collection('following').doc(viewingUserId).get().then(doc => {
        if(doc.exists) {
            // --- UNFOLLOW ---
            myRef.collection('following').doc(viewingUserId).delete();
            otherRef.collection('followers').doc(currentUser.uid).delete();
            
            myRef.update({followingCount: firebase.firestore.FieldValue.increment(-1)});
            otherRef.update({followersCount: firebase.firestore.FieldValue.increment(-1)});
            
            // UI Update
            const btn = document.getElementById('btn-follow');
            btn.innerText = "Follow";
            btn.style.background = "var(--accent)";
            btn.style.border = "none";
            btn.style.color = "#ffffff";

        } else {
            // --- FOLLOW ---
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            myRef.collection('following').doc(viewingUserId).set({timestamp: timestamp});
            otherRef.collection('followers').doc(currentUser.uid).set({timestamp: timestamp});
            
            myRef.update({followingCount: firebase.firestore.FieldValue.increment(1)});
            otherRef.update({followersCount: firebase.firestore.FieldValue.increment(1)});

            // --- SEND NOTIFICATION ---
            // We use .doc(currentUser.uid) so if you follow/unfollow multiple times, 
            // it overwrites the same notification instead of spamming them.
            
            // Get my latest name/photo from global data to ensure accuracy
            const myName = globalProfileData.displayName || currentUser.displayName;
            const myPhoto = globalProfileData.photoURL || currentUser.photoURL;

            db.collection('users').doc(viewingUserId).collection('notifications').doc(currentUser.uid).set({
                type: 'follow',
                fromUid: currentUser.uid,
                fromName: myName, 
                fromPhoto: myPhoto,
                text: "started following you.",
                timestamp: timestamp,
                read: false
            });

            // UI Update
            const btn = document.getElementById('btn-follow');
            btn.innerText = "Unfollow";
            btn.style.background = "var(--bg-card)";
            btn.style.border = "1px solid var(--border)";
            btn.style.color = "var(--text-primary)";
        }
    });
}

function openNotifications() {
    switchTab('notifications');
    document.getElementById('notif-badge').style.display = 'none';

    const list = document.getElementById('notification-list');
    list.innerHTML = '<div class="loader-spinner" style="margin: 20px auto;"></div>';

    db.collection('users').doc(currentUser.uid).collection('notifications')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get()
      .then(snapshot => {
          list.innerHTML = '';
          
          if(snapshot.empty) {
              list.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:30px;">No notifications yet.</p>';
              return;
          }

          const batch = db.batch(); 

          snapshot.forEach(doc => {
              const n = doc.data();
              const time = n.timestamp ? new Date(n.timestamp.toDate()).toLocaleDateString() : '';
              
              // --- PREVIEW LOGIC ---
              let postPreviewHTML = '';
              
              if(n.postThumb) {
                  // CASE 1: Post has an image -> Show Image
                  postPreviewHTML = `<img src="${n.postThumb}" class="notif-post-thumb">`;
              } 
              else if (n.postId) {
                  // CASE 2: Post exists but is Text-Only -> Show Icon Placeholder
                  postPreviewHTML = `
                      <div class="notif-post-thumb placeholder">
                          <i class="fa-solid fa-align-left"></i>
                      </div>
                  `;
              }
              // CASE 3: Follow notification -> Show nothing (postPreviewHTML stays empty)

              // Determine Click Action
              // If it's a "Follow", go to Profile. If it's "Like/Comment", go to that specific Post.
              // Note: You'll need to handle 'openPost(pid)' later, or just default to profile for now.
              const clickAction = `openUserProfile('${n.fromUid}')`; 

              list.innerHTML += `
                  <div class="notif-item" onclick="${clickAction}">
                      <div class="avatar" style="background-image: url('${n.fromPhoto}')"></div>
                      <div class="notif-content">
                          <div class="notif-text">
                              <strong>${n.fromName}</strong> ${n.text}
                          </div>
                          <div class="notif-time">${time}</div>
                      </div>
                      ${postPreviewHTML} 
                  </div>
              `;

              if(n.read === false) {
                  batch.update(doc.ref, { read: true });
              }
          });

          batch.commit().catch(e => console.log("Error marking read", e));
      });
}



    // --- CHAT SYSTEM ---
    function startChat() {
        if(!viewingUserId) return;
        const chatId = [currentUser.uid, viewingUserId].sort().join('_');
        const otherName = document.getElementById('other-name').innerText;
        const otherPhoto = document.getElementById('other-pic').style.backgroundImage.slice(5, -2); // Extract URL

        db.collection('chats').doc(chatId).set({
            participants: [currentUser.uid, viewingUserId],
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            participantDetails: { 
                [viewingUserId]: { name: otherName, photo: otherPhoto },
                [currentUser.uid]: { name: currentUser.displayName, photo: currentUser.photoURL }
            }
        }, {merge: true}).then(() => {
            window.location.href = `chat.html?chatId=${chatId}`;
        });
    }

    function loadChatList() {
        db.collection('chats')
          .where('participants', 'array-contains', currentUser.uid)
          .onSnapshot(snap => {
              const div = document.getElementById('chat-list-container');
              div.innerHTML = '';
              if(snap.empty) {
                  div.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-secondary)'>No messages yet.</div>";
                  return;
              }
              
              let chats = [];
              snap.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
              chats.sort((a, b) => {
                  const dateA = a.lastUpdated ? a.lastUpdated.toDate() : new Date(0);
                  const dateB = b.lastUpdated ? b.lastUpdated.toDate() : new Date(0);
                  return dateB - dateA; 
              });

              chats.forEach(chat => {
                  const otherId = chat.participants.find(id => id !== currentUser.uid);
                  const otherUser = chat.participantDetails ? chat.participantDetails[otherId] : {name: 'User', photo: ''};
                  
                  div.innerHTML += `
                      <div class="chat-item" onclick="window.location.href='chat.html?chatId=${chat.id}'">
                          <div class="avatar" style="background-image:url('${otherUser.photo}')"></div>
                          <div>
                              <div style="font-weight:600;">${otherUser.name}</div>
                              <div style="font-size:0.8rem; color:var(--text-secondary);">Open Chat</div>
                          </div>
                      </div>
                  `;
              });
          });
    }

    // --- IMAGE COMPRESSION & UPLOAD ---
    function previewImage() {
    startCropper('post-file', 'post');
}

    function clearImage() {
        document.getElementById('post-file').value = "";
        document.getElementById('image-preview').style.display = 'none';
    }

    // New Compression Function
    function compressImage(file) {
    return new Promise((resolve, reject) => {
        // 1. REDUCE RESOLUTION
        // Previously 1200. Changing to 800-1000 is great for mobile apps.
        const maxWidth = 800; 

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                const elem = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Resize logic
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }

                elem.width = width;
                elem.height = height;
                const ctx = elem.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 2. REDUCE JPEG QUALITY
                // The last number (0.5) is the quality (0 to 1).
                // 0.8 = High Quality, Large Size
                // 0.5 = Medium Quality, Small Size (Recommended for fast feeds)
                // 0.3 = Low Quality, Very Small Size
                ctx.canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', 0.6); 
            }
            img.onerror = (err) => reject(err);
        }
        reader.onerror = (err) => reject(err);
    });
}

    async function uploadToImageKit(file) {
        try {
            // 1. Fetch secure signature from YOUR Netlify Function
            // Note: The path is always /.netlify/functions/<filename>
            const authResponse = await fetch('/.netlify/functions/auth');
            
            if (!authResponse.ok) throw new Error("Failed to get auth params");
            const authData = await authResponse.json();

            // 2. Prepare Upload
            const formData = new FormData();
            formData.append("file", file);
            formData.append("fileName", "cp-" + Date.now());
            formData.append("publicKey", IMAGEKIT_PUBLIC_KEY); // Public key is safe to keep in JS
            
            // 3. Use the params we fetched from the server
            formData.append("signature", authData.signature);
            formData.append("expire", authData.expire);
            formData.append("token", authData.token);
            formData.append("useUniqueFileName", "true");

            // 4. Send to ImageKit
            const response = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
                method: "POST", 
                body: formData
            });
            
            const data = await response.json();
            return data.url;

        } catch (error) {
            console.error("Upload failed", error);
            alert("Image upload failed: " + error.message);
            return null;
        }
    }

    // --- POSTS & RADAR (With Blips) ---
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        var R = 6371e3; 
        var dLat = (lat2-lat1) * (Math.PI/180);  
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }

    // --- POSTS & RADAR (With Blips) ---
// Find this function and replace it:

function loadNearbyUsers() {
    const list = document.getElementById('user-list');
    const radarCircle = document.querySelector('.radar-circle');
    const MAX_RANGE = 5000; // 5000 meters (5 km)
    
    // Display the range prominently (in the GPS status indicator area)
    const statusEl = document.getElementById('gps-status-indicator');
    statusEl.innerHTML = `<i class="fa-solid fa-satellite-dish"></i> RANGE: <span style="color:#4dabf8">${MAX_RANGE / 1000} KM</span>`;

    db.collection('users').orderBy('lastActive', 'desc').limit(20).onSnapshot(snap => {
        list.innerHTML = '';
        const oldBlips = radarCircle.querySelectorAll('.radar-blip, .blip-tooltip');
        oldBlips.forEach(el => el.remove());
        
        let usersWithDistance = [];
        snap.forEach(doc => {
            const u = doc.data();
            if(u.uid !== currentUser.uid) {
                let dist = null;
                // Only calculate distance if myLocation and user location exist
                if(myLocation && u.location) {
                    dist = getDistanceFromLatLonInMeters(myLocation.lat, myLocation.lng, u.location.lat, u.location.lng);
                }
                
                // IMPORTANT: Filter out users immediately if distance is unknown or outside MAX_RANGE
                if (dist !== null && dist <= MAX_RANGE) {
                    usersWithDistance.push({ ...u, distance: dist });
                }
            }
        });

        if(usersWithDistance.length === 0) { 
            list.innerHTML = '<p class="mono" style="color:var(--text-secondary); text-align:center;">No students found within range.</p>'; 
            return; 
        }

        usersWithDistance.sort((a, b) => a.distance - b.distance);

        usersWithDistance.forEach(u => {
            let distText = `${Math.round(u.distance)}m`;
            
            // --- 1. Populate the User List (List View) ---
            list.innerHTML += `
                <div class="user-list-item" onclick="openUserProfile('${u.uid}')">
                    <div class="avatar" style="background-image: url('${u.photoURL || ''}')"></div>
                    <div style="flex:1;">
                        <div class="h-flex" style="justify-content:space-between;">
                            <div style="font-weight:600;">${u.displayName}</div>
                            <div class="mono" style="font-size:0.7rem; color:var(--accent);">${distText}</div>
                        </div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">${u.academic?.major || 'Student'}</div>
                    </div>
                </div>
            `;

            // --- 2. Populate the Radar View (Blips) ---
            if(u.distance !== null) {
                const blip = document.createElement('div');
                blip.className = 'radar-blip';
                
                // Calculate position based on distance: map 0m to 0% and MAX_RANGE to 45% radial distance
                // We use 45% to keep the blip inside the radar circle boundary.
                const percentFromCenter = (u.distance / MAX_RANGE) * 45;Â 
                
                // Keep random angle to distribute blips realistically
                const randomAngle = Math.random() * 2 * Math.PI;
                const top = 50 + (percentFromCenter * Math.sin(randomAngle));
                const left = 50 + (percentFromCenter * Math.cos(randomAngle));
                
                blip.style.top = top + '%'; blip.style.left = left + '%';
                blip.onclick = (e) => { e.stopPropagation(); openUserProfile(u.uid); };
                
                const tooltip = document.createElement('div');
                tooltip.className = 'blip-tooltip';
                tooltip.innerText = u.displayName.split(' ')[0] + ` (${distText})`;
                tooltip.style.top = top + '%';
                tooltip.style.left = left + '%';
                
                radarCircle.appendChild(tooltip);
                radarCircle.appendChild(blip);
            }
        });
    });
}

    // --- MENU FUNCTIONS ---

// Updated toggle function to handle unique IDs based on source
function togglePostMenu(pid, source, event) {
    // Check if event exists before trying to use it
    if(event && event.stopPropagation) {
        event.stopPropagation();
    }
    
    // 1. Close all OTHER open menus first
    document.querySelectorAll('.dropdown-menu').forEach(el => {
        // We only want to close menus that are NOT the one we just clicked
        if(el.id !== `menu-${source}-${pid}`) {
            el.classList.remove('show');
        }
    });

    // 2. Toggle the specific menu we clicked
    const menu = document.getElementById(`menu-${source}-${pid}`);
    if(menu) {
        menu.classList.toggle('show');
    }
}

// 2. Global listener to close menus when clicking anywhere else
window.onclick = function(event) {
    if (!event.target.matches('.menu-trigger')) {
        document.querySelectorAll('.dropdown-menu').forEach(el => {
            el.classList.remove('show');
        });
    }
}

// --- DELETE FUNCTION ---
function deletePost(pid) {
    if(!confirm("Are you sure you want to delete this post? This cannot be undone.")) return;

    // 1. Delete from Firestore
    db.collection('posts').doc(pid).delete().then(() => {
        // UI will update automatically because of onSnapshot in startFeedListener
        alert("Post deleted successfully.");
    }).catch((error) => {
        console.error("Error removing document: ", error);
        alert("Error deleting post.");
    });
}

// --- REPORT FUNCTION ---
function reportPost(pid, reportedUid, reportedName) {
    const reason = prompt("Why are you reporting this post? (e.g., Spam, Abusive, Fake News)");
    
    if(!reason) return; // User cancelled

    db.collection('reports').add({
        postId: pid,
        reportedUserUid: reportedUid,
        reportedUserName: reportedName,
        reporterUid: currentUser.uid,
        reporterName: currentUser.displayName,
        reason: reason,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: "pending"
    }).then(() => {
        alert("Report submitted. We will review this post shortly.");
        // Optional: Hide the menu
        const menu = document.getElementById(`menu-${pid}`);
        if(menu) menu.classList.remove('show');
    }).catch(err => {
        console.error(err);
        alert("Failed to submit report.");
    });
}

    function startFeedListener() {
    db.collection('posts').orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
        const container = document.getElementById('feed-container'); 
        container.innerHTML = '';
        // PASS 'feed' HERE
        snap.forEach(doc => container.appendChild(renderPost(doc, 'feed')));
    });
}

    function loadProfilePosts() {
    db.collection('posts').where('uid', '==', currentUser.uid).orderBy('timestamp', 'desc').onSnapshot(snap => {
        const container = document.getElementById('profile-feed'); 
        container.innerHTML = '';
        document.getElementById('stat-posts').innerText = snap.size;
        // PASS 'profile' HERE
        snap.forEach(doc => container.appendChild(renderPost(doc, 'profile')));
    });
}

    function renderPost(doc, source = 'feed') {
    const post = doc.data();
    const pid = doc.id;
    const time = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    const boosts = post.boosts || [];
    const isBoosted = boosts.includes(currentUser.uid);
    const isOwner = post.uid === currentUser.uid;

    // --- MEDIA LOGIC (Image vs Video) ---
    let mediaHTML = '';

    // 1. CHECK IF IT IS A VIDEO (REEL)
    if (post.videoUrl) {
        mediaHTML = `
            <div style="width:100%; height: 450px; background: #000; border-radius: 8px; margin-top:10px; overflow:hidden; position:relative;">
                <video src="${post.videoUrl}" style="width:100%; height:100%; object-fit:contain;" controls playsinline loop></video>
                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); padding:4px 8px; border-radius:4px; color:white; font-size:0.7rem;">
                    <i class="fa-solid fa-video"></i> Reel
                </div>
            </div>
        `;
    } 
    // 2. CHECK IF IT IS AN IMAGE CAROUSEL
    else {
        const images = post.images || (post.imageUrl ? [post.imageUrl] : []);
        
        if (images.length > 0) {
            const slides = images.map(url => `
                <div class="carousel-slide">
                    <img src="${url}" class="feed-post-img" loading="lazy">
                </div>
            `).join('');

            let dotsHTML = '';
            if (images.length > 1) {
                const dots = images.map((_, i) => `
                    <div class="dot ${i === 0 ? 'active' : ''}" id="dot-${pid}-${i}"></div>
                `).join('');
                dotsHTML = `<div class="carousel-dots">${dots}</div>`;
            }

            mediaHTML = `
                <div class="post-carousel">
                    <div class="carousel-track" id="track-${pid}" onscroll="updateCarouselDots('${pid}', ${images.length})">
                        ${slides}
                    </div>
                    ${dotsHTML}
                </div>
            `;
        }
    }

    // --- BUTTONS LOGIC ---
    const deleteBtn = isOwner ? `<div class="dropdown-item danger" onclick="deletePost('${pid}')"><i class="fa-solid fa-trash"></i> Delete Post</div>` : '';
    const reportBtn = !isOwner ? `<div class="dropdown-item" onclick="reportPost('${pid}', '${post.uid}', '${post.userName}')"><i class="fa-solid fa-flag"></i> Report</div>` : '';

    const el = document.createElement('div');
    el.className = 'post-card';
    
    el.innerHTML = `
        <div class="h-flex" style="margin-bottom:10px; align-items: flex-start;">
            <div class="avatar" style="background-image: url('${post.userPhoto}'); cursor:pointer;" onclick="openUserProfile('${post.uid}')"></div>
            <div style="flex:1" onclick="openUserProfile('${post.uid}')">
                <div style="font-weight:600; font-size:0.95rem; cursor:pointer;">${post.userName}</div>
                <div style="font-size:0.75rem; color:var(--text-secondary)">${time}</div>
            </div>
            <div class="post-header-right">
                <i class="fa-solid fa-ellipsis-vertical menu-trigger" onclick="togglePostMenu('${pid}', '${source}', event)"></i>
                <div id="menu-${source}-${pid}" class="dropdown-menu">
                    ${deleteBtn} ${reportBtn}
                    <div class="dropdown-item" onclick="togglePostMenu('${pid}', '${source}', event)"><i class="fa-solid fa-xmark"></i> Close</div>
                </div>
            </div>
        </div>
        <div class="goal-tag mono" style="margin-bottom:10px; display:inline-block;">${post.goal || ''}</div>
        <p style="font-size:0.95rem; line-height:1.5;">${post.text}</p>
        
        ${mediaHTML}
        
        <div class="post-actions">
            <div class="action-item ${isBoosted ? 'boosted' : ''}" onclick="toggleBoost('${pid}')">
                <i class="fa-solid fa-bolt"></i><span>Boost (${boosts.length})</span>
            </div>
            <div class="action-item" onclick="toggleDiscussion('${pid}')">
                <i class="fa-regular fa-comment-dots"></i><span>Discussion</span>
            </div>
        </div>
        <div class="discussion-area" id="discuss-${pid}">
            <div id="preview-comments-${pid}" style="margin-bottom:10px;">
                <p style="font-size:0.8rem; color:var(--text-secondary);">Loading preview...</p>
            </div>
            <button class="secondary-btn" onclick="openDiscussionRoom('${pid}')" style="width:100%; margin-top:5px; border-color:var(--accent); color:var(--accent);">
                Open Discussion Room <i class="fa-solid fa-arrow-right-to-bracket"></i>
            </button>
            <div class="h-flex" style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                <input type="text" id="input-${pid}" class="nexus-input" style="margin-bottom:0; font-size:0.85rem; padding:8px;" placeholder="Quick reply...">
                <button onclick="postComment('${pid}')" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:6px; margin-left:8px;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    `;
    return el;
}

function triggerVideoUpload() {
    const input = document.getElementById('raw-gallery-input');
    // Force input to accept video files
    input.accept = "video/mp4, video/quicktime"; 
    input.click();
}

// Helper to update dots on scroll
function updateCarouselDots(pid, count) {
    if (count <= 1) return;
    const track = document.getElementById(`track-${pid}`);
    const width = track.offsetWidth;
    const scroll = track.scrollLeft;
    
    // Calculate current index
    const index = Math.round(scroll / width);
    
    // Update classes
    for(let i=0; i<count; i++) {
        const dot = document.getElementById(`dot-${pid}-${i}`);
        if(dot) {
            if(i === index) dot.classList.add('active');
            else dot.classList.remove('active');
        }
    }
}

    // MODIFIED CREATE POST TO HANDLE IMAGE & COMPRESSION
    async function createPost() {
    const text = document.getElementById('post-text').value;
    const goal = document.getElementById('post-goal').value || "#Update";
    const btn = document.getElementById('btn-post');

    // Validation: Must have text OR (images OR video)
    if (!text && croppedBlobs.length === 0 && !selectedVideoFile) {
        return alert("Please add text, photos, or a video.");
    }

    btn.disabled = true;
    let imageUrls = [];
    let videoUrl = null;
    let postType = 'post'; // Default

    try {
        // --- 1. HANDLE VIDEO UPLOAD ---
        if (selectedVideoFile) {
            showUploadModal("Uploading Reel (this may take a moment)...");
            postType = 'reel'; // Mark as reel
            
            // Upload directly (no compression for video in this script)
            videoUrl = await uploadToImageKit(selectedVideoFile);
            
            if(!videoUrl) throw new Error("Video upload failed");
            updateProgressBar(100);
        }
        
        // --- 2. HANDLE IMAGE UPLOAD (Existing Logic) ---
        else if (croppedBlobs.length > 0) {
            showUploadModal(`Uploading ${croppedBlobs.length} Photos...`);
            
            const uploadPromises = croppedBlobs.map(async (blob) => {
                const compressedFile = new File([blob], "post.jpg", { type: "image/jpeg" });
                const compressed = await compressImage(compressedFile);
                return await uploadToImageKit(compressed);
            });

            const results = await Promise.all(uploadPromises);
            imageUrls = results.filter(url => url !== null);
            
            if(imageUrls.length === 0) throw new Error("Image upload failed");
            updateProgressBar(100);
        } else {
            showUploadModal("Posting...");
            updateProgressBar(50);
        }

        // --- 3. SAVE TO FIRESTORE ---
        document.getElementById('upload-subtext').innerText = "Saving...";

        const authorName = globalProfileData.displayName || currentUser.displayName;
        const authorPhoto = globalProfileData.photoURL || currentUser.photoURL;

        await db.collection('posts').add({
            text: text,
            goal: goal,
            uid: currentUser.uid,
            userName: authorName,
            userPhoto: authorPhoto,
            
            // Media Fields
            type: postType,          // 'post' or 'reel'
            images: imageUrls,       // Array of image URLs
            imageUrl: imageUrls[0] || null, // Fallback
            videoUrl: videoUrl,      // Video URL if reel
            
            boosts: [],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // --- 4. SUCCESS & CLEANUP ---
        const successAudio = new Audio('https://campuspoint.netlify.app/success.mp3');
        successAudio.volume = 0.5;
        successAudio.play().catch(e => console.log("Audio play failed", e));

        setTimeout(() => {
            hideUploadModal();
            
            // Reset Form
            document.getElementById('post-text').value = '';
            document.getElementById('post-goal').value = '';
            document.getElementById('final-preview-container').innerHTML = '';
            document.getElementById('final-preview-container').style.display = 'none';
            document.getElementById('upload-type-indicator').style.display = 'none';
            
            // Clear Data
            croppedBlobs = [];
            rawFiles = [];
            selectedIndices = [];
            selectedVideoFile = null;
            
            btn.innerText = "POST UPDATE";
            btn.disabled = false;
            
            // Redirect based on type
            if(postType === 'reel') {
                switchTab('reels', document.querySelector('.nav-item:nth-child(3)'));
            } else {
                switchTab('feed', document.querySelector('.nav-item'));
            }
        }, 500);

    } catch(err) {
        console.error(err);
        hideUploadModal();
        alert("Error: " + err.message);
        btn.innerText = "POST UPDATE";
        btn.disabled = false;
    }
}

    function toggleBoost(pid) {
    const ref = db.collection('posts').doc(pid);

    db.runTransaction(t => {
        return t.get(ref).then(doc => {
            if (!doc.exists) throw "Post does not exist";

            const data = doc.data();
            const boosts = data.boosts || [];
            const isCurrentlyBoosted = boosts.includes(currentUser.uid);
            
            // Extract needed data
            const postAuthorUid = data.uid; 
            const postImage = data.imageUrl || null; // <--- GET IMAGE

            t.update(ref, { 
                boosts: isCurrentlyBoosted 
                    ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) 
                    : firebase.firestore.FieldValue.arrayUnion(currentUser.uid) 
            });
            
            return { 
                wasBoosted: !isCurrentlyBoosted, 
                authorUid: postAuthorUid,
                image: postImage // <--- RETURN IMAGE
            };
        });
    }).then(result => {
        if (result.wasBoosted) {
            showBoostAnimation();
            // Pass the image URL to the notification helper
            sendAppNotification(result.authorUid, 'like', 'boosted your post.', pid, result.image);
        }
    }).catch(error => {
        console.error("Boost transaction failed: ", error);
    });
}

    function toggleDiscussion(pid) {
    const area = document.getElementById(`discuss-${pid}`);
    area.classList.toggle('show');
    
    // Only load if showing
    if(area.classList.contains('show')) {
        loadCommentPreview(pid);
    }
}

function loadCommentPreview(pid) {
    const container = document.getElementById(`preview-comments-${pid}`);
    
    // Fetch ONLY latest 2
    db.collection('posts').doc(pid).collection('comments')
        .orderBy('timestamp', 'desc') // Latest first
        .limit(2)
        .get()
        .then(snapshot => {
            container.innerHTML = '';
            
            if(snapshot.empty) {
                container.innerHTML = '<p style="font-size:0.8rem; color:var(--text-secondary); padding:5px;">No comments yet. Be the first!</p>';
                return;
            }

            snapshot.forEach(doc => {
                const c = doc.data();
                container.innerHTML += `
                    <div class="preview-comment-item">
                        <strong>${c.userName}:</strong> ${c.text}
                    </div>
                `;
            });
        });
}

// --- DISCUSSION ROOM LOGIC ---

function openDiscussionRoom(pid) {
    currentRoomPostId = pid;
    
    // 1. Setup UI
    document.getElementById('section-discussion-room').classList.remove('hidden');
    document.getElementById('room-my-avatar').style.backgroundImage = `url('${currentUser.photoURL}')`;
    const list = document.getElementById('room-comments-list');
    list.innerHTML = '<div class="loader-spinner" style="margin: 50px auto;"></div>';

    // 2. Realtime Listener for ALL comments
    if(roomListener) roomListener(); // Unsubscribe previous if exists

    roomListener = db.collection('posts').doc(pid).collection('comments')
        .orderBy('timestamp', 'desc') // Latest at top
        .onSnapshot(snapshot => {
            list.innerHTML = '';
            
            if(snapshot.empty) {
                list.innerHTML = '<div style="text-align:center; margin-top:50px; color:var(--text-secondary)"><i class="fa-regular fa-comments" style="font-size:2rem; margin-bottom:10px;"></i><br>Start the discussion!</div>';
                return;
            }

            snapshot.forEach(doc => {
                const c = doc.data();
                const time = c.timestamp ? new Date(c.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                
                // Determine if it's Me or Others for styling (Optional visual flair)
                const isMe = c.uid === currentUser.uid;
                const alignStyle = isMe ? 'margin-left: auto; background: var(--bg-input); border-color: var(--accent);' : '';

                list.innerHTML += `
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div class="avatar" style="background-image: url('${c.userPhoto || 'default.png'}'); width:35px; height:35px; flex-shrink:0;"></div>
                        <div style="flex:1;">
                            <div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:2px;">
                                <span style="color:var(--text-primary); font-weight:600;">${c.userName}</span> â€¢ ${time}
                            </div>
                            <div class="room-comment-bubble" style="${isMe ? 'border-left: 3px solid var(--accent);' : ''}">
                                ${c.text}
                            </div>
                        </div>
                    </div>
                `;
            });
        });
}

function closeDiscussionRoom() {
    document.getElementById('section-discussion-room').classList.add('hidden');
    if(roomListener) roomListener(); // Stop listening to save data
    currentRoomPostId = null;
}

function postRoomComment() {
    const input = document.getElementById('room-input');
    const val = input.value;
    if(!val || !currentRoomPostId) return;

    // Use existing logic, but for the room
    addCommentToDB(currentRoomPostId, val).then(() => {
        input.value = ''; // Clear input
        // Notification is handled in addCommentToDB
    });
}

    // 1. Updated Quick Reply (Inline)
function postComment(pid) {
    const val = document.getElementById(`input-${pid}`).value;
    if(!val) return;

    addCommentToDB(pid, val).then(() => {
        document.getElementById(`input-${pid}`).value = '';
        // Refresh preview immediately
        loadCommentPreview(pid); 
    });
}

// 2. Shared DB Logic (Handles DB write & Notifications)
function addCommentToDB(pid, text) {
    const myName = globalProfileData.displayName || currentUser.displayName;
    const myPhoto = globalProfileData.photoURL || currentUser.photoURL;

    return db.collection('posts').doc(pid).get().then(doc => {
        if(doc.exists) {
            const postData = doc.data();
            const authorUid = postData.uid;
            const postImage = postData.imageUrl || null;

            // Add Comment
            return db.collection('posts').doc(pid).collection('comments').add({
                text: text, 
                userName: myName, 
                userPhoto: myPhoto, // Save photo for avatar display
                uid: currentUser.uid, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                // Send Notification
                const snippet = text.length > 20 ? text.substring(0, 20) + "..." : text;
                sendAppNotification(authorUid, 'comment', `commented: "${snippet}"`, pid, postImage);
            });
        }
    }).catch(err => console.error("Error posting comment:", err));
}

    function loadComments(pid) {
        const box = document.getElementById(`comments-${pid}`);
        db.collection('posts').doc(pid).collection('comments').orderBy('timestamp').onSnapshot(snap => {
            box.innerHTML = '';
            snap.forEach(d => box.innerHTML += `<div class="comment-item"><strong>${d.data().userName}:</strong> ${d.data().text}</div>`);
        });
    }

    
    function editProfile() {
    // Load text data
    document.getElementById('setup-name').value = globalProfileData.displayName || "";
    document.getElementById('setup-university').value = globalProfileData.academic.university || "";
    document.getElementById('setup-major').value = globalProfileData.academic.major || "";
    document.getElementById('setup-year').value = globalProfileData.academic.year || "";
    document.getElementById('setup-bio').value = globalProfileData.bio || "";
    document.getElementById('setup-goal').value = globalProfileData.futureGoal || "";
    updateBioCount();

    // NEW: Load current profile picture into the preview
    document.getElementById('setup-pic-preview').src = globalProfileData.photoURL || currentUser.photoURL;

    selectedBannerUrl = globalProfileData.bannerUrl || DEFAULT_BANNER;
    document.getElementById('setup-banner-preview').src = selectedBannerUrl;

    // Load saved hobbies
    selectedHobbies = new Set(globalProfileData.interests || []);
    renderHobbiesSelector();

    switchTab('setup', null);
}
    
    function cancelSetup() { if(globalProfileData.uid) switchTab('profile', document.querySelectorAll('.nav-item')[3]); }

    function toggleTheme() {
        const h = document.documentElement;
        const m = h.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        h.setAttribute('data-theme', m);
        document.getElementById('theme-btn').className = m === 'dark' ? "fa-solid fa-moon" : "fa-regular fa-sun";
    }

    // --- THEME LOGIC ---

// 1. Initialize on Load
// Check localStorage or default to 'system'
let currentThemeSetting = localStorage.getItem('theme_preference') || 'system';
applyTheme(currentThemeSetting);

function openThemeModal() {
    document.getElementById('theme-modal').style.display = 'flex';
    
    // Highlight the current selection
    document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
    document.getElementById(`opt-${currentThemeSetting}`).classList.add('active');
}

function closeThemeModal() {
    document.getElementById('theme-modal').style.display = 'none';
}

function setTheme(mode) {
    currentThemeSetting = mode;
    localStorage.setItem('theme_preference', mode); // Remember decision
    applyTheme(mode);
    closeThemeModal();
}

function applyTheme(mode) {
    const root = document.documentElement;
    const btnIcon = document.getElementById('theme-btn');
    
    let effectiveTheme = 'dark'; // Default fallback

    if (mode === 'system') {
        // Detect System Preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            effectiveTheme = 'light';
        } else {
            effectiveTheme = 'dark';
        }
    } else {
        effectiveTheme = mode; // 'light' or 'dark'
    }

    // 1. Apply to CSS
    root.setAttribute('data-theme', effectiveTheme);

    // 2. NEW: Update Browser Status Bar Color (Meta Tag)
    // This overrides the manifest.json theme_color while the app is running
    const metaThemeColor = document.querySelector("meta[name=theme-color]");
    if (metaThemeColor) {
        // Use your CSS variable colors: #050505 for dark, #F2F4F8 for light
        metaThemeColor.setAttribute("content", effectiveTheme === 'dark' ? "#050505" : "#F2F4F8");
    }

    // 3. Update Icon
    if (btnIcon) {
        btnIcon.className = effectiveTheme === 'dark' ? "fa-solid fa-moon" : "fa-regular fa-sun";
    }
}

// Listener for System Changes (if user changes OS theme while app is open)
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
    if (currentThemeSetting === 'system') {
        applyTheme('system');
    }
});

    initApp();

    // --- FOLLOWER/FOLLOWING LIST LOGIC ---

function openFollowList(type, uid, fromTab) {

    
    // Set Title
    const title = type === 'followers' ? 'FOLLOWERS' : 'FOLLOWING';
    document.getElementById('follow-list-title').innerText = title;
    
    // Show Loading
    const container = document.getElementById('follow-list-content');
    container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Loading...</p>';
    
    // Switch View
    window.location.hash = 'follow-list';

    // Fetch the IDs first
    db.collection('users').doc(uid).collection(type).limit(50).get().then(async (snapshot) => {
        if (snapshot.empty) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">List is empty.</p>';
            return;
        }

        container.innerHTML = ''; // Clear loading
        
        // Loop through docs and fetch user profiles
        // Note: In a production app, you would duplicate name/photo in the follower doc to avoid these extra reads.
        const promises = [];
        snapshot.forEach(doc => {
            const targetUid = doc.id;
            promises.push(db.collection('users').doc(targetUid).get());
        });

        const userDocs = await Promise.all(promises);

        userDocs.forEach(userDoc => {
            if (userDoc.exists) {
                const u = userDoc.data();
                container.innerHTML += renderUserListItem(u);
            }
        });
    });
}

function closeFollowList() {
    // This acts exactly like hitting the physical back button on Android
    window.history.back();
}

// Reusable render function (matches your Radar style)
function renderUserListItem(u) {
    return `
        <div class="user-list-item" onclick="openUserProfile('${u.uid}')">
            <div class="avatar" style="background-image: url('${u.photoURL || ''}')"></div>
            <div style="flex:1;">
                <div class="h-flex" style="justify-content:space-between;">
                    <div style="font-weight:600;">${u.displayName}</div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">${u.academic?.major || 'Student'}</div>
            </div>
        </div>
    `;
}

// --- REELS SYSTEM ---

let reelsObserver = null;
let currentPlayingVideo = null;

// 1. Initialize Observer (Intersection API)
// This detects which video is currently visible
function initReelsObserver() {
    const options = {
        root: document.getElementById('reels-container'),
        rootMargin: '0px',
        threshold: 0.6 // Video must be 60% visible to play
    };

    reelsObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (!video) return;

            if (entry.isIntersecting) {
                // --- MODIFICATION START ---
                // Removed "video.currentTime = 0;" so videos resume instead of restarting
                
                // Attempt to play
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Autoplay blocked:", error);
                        // The UI stays in "Paused" state (Play icon visible) automatically
                        // because video.onpause is triggered by the failure.
                    });
                }
                currentPlayingVideo = video;
                // --- MODIFICATION END ---
                
            } else {
                // Pause when scrolled away
                video.pause();
            }
        });
    }, options);
}

// 2. Load Reels Data
function loadReels() {
    const container = document.getElementById('reels-container');
    
    // Check if we already loaded to prevent flicker
    if(container.children.length > 0) return; 

    container.innerHTML = '<div class="loader-spinner" style="position:absolute;top:50%;left:50%;"></div>';

    // Fetch posts that have a 'videoUrl' property (or filter by type='reel')
    // Note: You need to update your upload logic to save `videoUrl`
    db.collection('posts')
      .where('videoUrl', '!=', null) 
      .limit(10)
      .get()
      .then(snapshot => {
          container.innerHTML = '';
          
          if(snapshot.empty) {
              container.innerHTML = '<p style="color:white; text-align:center; padding-top:50%;">No reels yet.</p>';
              return;
          }

          snapshot.forEach(doc => {
              container.appendChild(renderReelItem(doc));
          });

          // Attach observer to new elements
          document.querySelectorAll('.reel-item').forEach(el => {
              reelsObserver.observe(el);
          });
      });
}

// 3. Render Individual Reel
function renderReelItem(doc) {
    const data = doc.data();
    const pid = doc.id;
    const isLiked = data.boosts && data.boosts.includes(currentUser.uid);

    const div = document.createElement('div');
    div.className = 'reel-item';
    
    // Note: 'controls' attribute removed from video
    div.innerHTML = `
        <video class="reel-video" loop playsinline muted>
            <source src="${data.videoUrl}" type="video/mp4">
        </video>
        
        <div class="reel-play-overlay">
            <i class="fa-solid fa-play"></i>
        </div>

        <div class="reel-custom-mute-btn">
            <i class="fa-solid fa-volume-xmark"></i>
        </div>

        <div class="reel-overlay">
            <div class="reel-info">
                <div class="reel-username" onclick="openUserProfile('${data.uid}')">
                    <div class="avatar" style="background-image: url('${data.userPhoto}'); width:35px; height:35px;"></div>
                    ${data.userName}
                    <button style="background:transparent; border:1px solid rgba(255,255,255,0.5); color:white; border-radius:4px; padding:2px 8px; font-size:0.7rem; margin-left:10px;">Follow</button>
                </div>
                <div class="reel-desc">${data.text || ''}</div>
                <div style="font-size:0.8rem; margin-top:5px; opacity:0.8;">
                    <i class="fa-solid fa-music"></i> Original Audio
                </div>
            </div>
        </div>

        <div class="reel-actions">
            <div class="reel-action-btn" onclick="toggleBoost('${pid}')">
                <i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart" style="color: ${isLiked ? '#ff5555' : 'white'}"></i>
                <span>${data.boosts ? data.boosts.length : 0}</span>
            </div>
            <div class="reel-action-btn" onclick="openDiscussionRoom('${pid}')">
                <i class="fa-regular fa-comment-dots"></i>
                <span>Comment</span>
            </div>
             <div class="reel-action-btn" onclick="shareReel('${pid}')">
                <i class="fa-regular fa-paper-plane"></i>
            </div>
        </div>
    `;

    // --- LOGIC ---
    const video = div.querySelector('video');
    const playOverlay = div.querySelector('.reel-play-overlay');
    const muteBtn = div.querySelector('.reel-custom-mute-btn');
    const muteIcon = muteBtn.querySelector('i');

    // 1. Handle Play/Pause on Container Tap
    div.onclick = (e) => {
        // Prevent triggering if clicking specific buttons (actions, mute, user info)
        if(e.target.closest('.reel-actions') || 
           e.target.closest('.reel-info') || 
           e.target.closest('.reel-custom-mute-btn')) return;
        
        if (video.paused) {
            video.play();
        } else {
            video.pause();
        }
    };

    // 2. Sync UI with Video State (Handles auto-scroll pause/play)
    video.onplay = () => { playOverlay.style.display = 'none'; };
    video.onpause = () => { playOverlay.style.display = 'block'; };

    // 3. Handle Mute Toggle
    muteBtn.onclick = (e) => {
        e.stopPropagation(); // Stop click from pausing the video
        video.muted = !video.muted;
        
        if (video.muted) {
            muteIcon.className = 'fa-solid fa-volume-xmark';
        } else {
            muteIcon.className = 'fa-solid fa-volume-high';
        }
    };

    return div;
}

// 4. Update the Router to handle loading
// (Add this check inside your existing router() function)
// If hash === 'reels', call initReelsObserver() and loadReels()

    </script>
</body>
</html>