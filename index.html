<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#050505">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-title" content="CampusPoint">

<link rel="apple-touch-icon" href="https://ik.imagekit.io/rstofficial/CAMPUS.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campus Point</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    


    <style>
        :root {
            /* --- ORIGINAL DESIGN VARIABLES --- */
            --bg-main: #050505;
            --bg-glass: rgba(20, 20, 21, 0.98);
            --bg-card: #0F0F10;
            --bg-input: #1A1A1C;
            --border: #2A2A2E;
            --text-primary: #EDEDED;
            --text-secondary: #888888;
            --accent: #4dabf8;
            --accent-backup: #4dabf8;
            --accent-glow: rgba(77, 107, 248, 0.4);
            --boost-color: #FFD700;
            --header-h: 60px;
            --nav-h: 70px;
        }

        [data-theme="light"] {
            --bg-main: #F2F4F8;
            --bg-glass: rgba(255, 255, 255, 0.98);
            --bg-card: #FFFFFF;
            --bg-input: #EAECEF;
            --border: #DDE1E6;
            --text-primary: #111111;
            --text-secondary: #555555;
            --accent: #304FFE;
            --accent-glow: rgba(48, 79, 254, 0.2);
            --boost-color: #F9A825;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow-y: auto;
            min-height: 100vh;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }

        /* Allow selection in input fields so users can still type! */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        .app-container {
            width: 100%; max-width: 480px; margin: 0 auto;
            min-height: 100vh; position: relative; padding-bottom: 80px;
        }

        /* --- Header --- */
        .header {
            height: var(--header-h); padding: 0 20px;
            background: var(--bg-glass); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            position: fixed; top: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; z-index: 1000;
        }

        /* --- Content Sections --- */
        .content-area {
            padding-top: calc(var(--header-h) + 20px);
            padding-left: 20px; padding-right: 20px;
        }
        .hidden { display: none !important; }

        /* --- Forms & Inputs --- */
        .nexus-input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            padding: 14px; border-radius: 8px; color: var(--text-primary);
            font-family: 'Inter', sans-serif; margin-bottom: 15px; outline: none;
            transition: border-color 0.3s;
        }
        .nexus-input:focus { border-color: var(--accent); }
        
        label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }

        .auth-btn, .action-btn {
            background: var(--accent); color: var(--text-primary); border: none; padding: 14px 25px;
            border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px var(--accent-glow); margin-top: 10px;
        }
        .action-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- LOGIN HERO IMAGE STYLES --- */
.hero-illustration {
    width: 100%; /* Adjust size as needed */
    height: auto;
    margin-bottom: 10px;
    /* Adds a cool glow matching your accent color */ 
    animation: floatHero 4s ease-in-out infinite;
}

@keyframes floatHero {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
}

/* --- PINTEREST-STYLE AUTH SCREEN --- */
#auth-overlay {
    background-color: #000000 !important; /* Pitch black background */
    padding: 40px 25px;
    display: flex !important;
    flex-direction: column;
    justify-content: space-between; /* Pushes footer to bottom */
    align-items: center;
    z-index: 9999; /* Ensure it's on top */
}

#auth-overlay.hidden {
    display: none !important;
}

/* Center Content Area */
.auth-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 360px; /* Mobile width */
}

/* Logo Area */
.auth-logo-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 20px;
}

/* Headline: "Create a life you love" style */
.auth-headline {
    font-size: 2rem;
    font-weight: 600;
    color: #ffffff;
    text-align: center;
    line-height: 1.2;
    margin-bottom: 10px;
    letter-spacing: -0.5px;
}

.auth-subhead {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 40px;
    text-align: center;
}

/* Pinterest-style Google Button (Dark with outline) */
.pinterest-google-btn {
    width: 100%;
    background-color: transparent;
    border: 1px solid #3f3f3f;
    border-radius: 50px; /* Full pill shape */
    padding: 14px 20px;
    color: #ffffff;
    font-size: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    margin-bottom: 20px;
}

.pinterest-google-btn:active {
    background-color: #1a1a1a;
    transform: scale(0.98);
    border-color: #666;
}

/* Bottom Legal Text */
.auth-footer {
    width: 100%;
    max-width: 300px;
    text-align: center;
    font-size: 0.75rem;
    color: #777;
    line-height: 1.5;
    padding-bottom: 10px;
}

.auth-footer a {
    color: #fff;
    text-decoration: none;
    font-weight: 500;
}
        
        .secondary-btn {
            background: transparent; color: var(--text-primary); border: 1px solid var(--border);
            padding: 8px 20px; border-radius: 50px; font-size: 0.85rem; cursor: pointer; margin-top: 10px;
        }

        .secondary-btn2 {
            background: transparent; color: var(--text-primary); border: 1px solid var(--border); padding: 14px 25px;
            border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px var(--accent-glow); margin-top: 10px;
            opacity: 0.7; cursor: not-allowed;
        }

        /* --- Cards --- */
        .post-card, .chat-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 18px; margin-bottom: 15px;
        }
        
        /* --- FEED IMAGE STYLES --- */
.feed-post-img {
    width: 100%;
    display: block;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    
    /* 1. KEY: Crop content that exceeds dimensions without stretching */
    object-fit: cover; 
    
    /* 2. Default to natural height so square/standard images look normal */
    height: auto;

    /* 3. "Max 4:3 ratio in portrait" 
       On a mobile screen (~400px width), a 550px height acts as a 3:4 limit. 
       Anything taller gets cropped. */
    max-height: 550px; 

    /* 4. "Lowest size 16:9 ratio"
       On a mobile screen, 225px is roughly the 16:9 height.
       This forces thin panoramas to be taller and cropped to fill the space. */
    min-height: 225px; 
}

        .chat-item { display: flex; align-items: center; cursor: pointer; }
        .chat-item:hover { border-color: var(--accent); }

        .post-actions {
            display: flex; gap: 20px; margin-top: 15px; padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .action-item {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            font-size: 0.9rem; color: var(--text-secondary); transition: 0.2s;
        }
        
        .action-item.boosted { color: var(--boost-color); }
        .action-item:hover { color: var(--text-primary); }

        .discussion-area {
            margin-top: 15px; background: var(--bg-input); 
            border-radius: 8px; padding: 10px; display: none;
        }
        .discussion-area.show { display: block; }
        
        .comment-item {
            font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid var(--border);
        }
        .comment-item:last-child { border-bottom: none; }

        /* --- Nav --- */
        .bottom-nav {
            height: var(--nav-h); background: var(--bg-glass);
            backdrop-filter: blur(12px); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; z-index: 1000;
        }
        .nav-item { font-size: 1.3rem; color: var(--text-secondary); cursor: pointer; padding: 10px; }
        .nav-item.active { color: var(--accent); }
        
        /* --- Floating Action Button (FAB) --- */
        .floating-fab {
            position: fixed; bottom: 90px; right: 20px;
            width: 56px; height: 56px; background: var(--accent); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 20px var(--accent-glow);
            z-index: 1100; cursor: pointer; transition: transform 0.2s;
        }
        .floating-fab:active { transform: scale(0.9); }

        /* --- Radar UI --- */
        .radar-view { height: 40vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; }
        .radar-circle { width: 220px; height: 220px; border: 1px solid var(--border); border-radius: 50%; position: relative; background: radial-gradient(circle, transparent 30%, var(--bg-card) 100%); }
        .radar-sweep { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(transparent 270deg, var(--accent-glow)); animation: radarSpin 3s linear infinite; }
        
        .radar-blip { 
            width: 12px; height: 12px; background: var(--accent); border-radius: 50%; 
            position: absolute; box-shadow: 0 0 8px var(--accent); cursor: pointer; 
            z-index: 2; animation: pulse 2s infinite; transition: transform 0.2s;
        }
        .radar-blip:hover { transform: scale(1.5); background: #fff; }

        .blip-tooltip {
            position: absolute; background: var(--bg-card); border: 1px solid var(--border);
            padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; pointer-events: none;
            white-space: nowrap; z-index: 10; transform: translate(-50%, -150%);
        }

        .user-list-item {
            display: flex; align-items: center; background: var(--bg-card);
            border: 1px solid var(--border); padding: 12px; margin-bottom: 10px;
            border-radius: 10px; cursor: pointer;
        }

        /* --- Profile Stats --- */
        .stats-row { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-box { text-align: center; }

        /* --- Utils --- */
        .h-flex { display: flex; align-items: center; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .avatar { width: 40px; height: 40px; border-radius: 10px; background-size: cover; margin-right: 12px; border: 1px solid var(--border); flex-shrink: 0; }
        .goal-tag { font-size: 0.7rem; padding: 4px 8px; background: var(--accent-glow); color: var(--accent); border-radius: 6px; border: 1px solid var(--accent); margin-left: auto; }
        
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-main); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        @keyframes radarSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- NEW STYLES FOR BIO & HOBBIES --- */
.bio-text { 
    font-size: 0.9rem; line-height: 1.5; color: var(--text-secondary); 
    margin: 10px auto; max-width: 300px; font-style: italic;
}
.future-goal-display { 
    font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent); 
    margin-bottom: 15px; padding: 8px; border: 1px dashed var(--accent); 
    border-radius: 8px; display: inline-block;
}
/* Tinder-like Chips */
.interests-container { 
    display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; justify-content: center; 
}
.interest-chip { 
    padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; 
    border: 1px solid var(--border); color: var(--text-secondary); 
    cursor: pointer; transition: all 0.2s; background: var(--bg-card);
}
.interest-chip.selected { 
    background: var(--accent); color: white; border-color: var(--accent); 
    box-shadow: 0 0 10px var(--accent-glow); transform: scale(1.05);
}
/* Hide unselected chips when viewing a profile */
.interest-chip.display-only { cursor: default; pointer-events: none; }

/* --- INSTALL MODAL STYLES --- */
#install-modal {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    padding: 25px 20px;
    z-index: 5000;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
    display: none; /* Hidden by default */
    flex-direction: column;
    align-items: center;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.install-icon {
    font-size: 3rem;
    color: var(--accent);
    margin-bottom: 15px;
    background: rgba(77, 107, 248, 0.1);
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
}

.install-title {
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.install-desc {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-align: center;
    margin-bottom: 25px;
    line-height: 1.5;
}

.install-buttons {
    display: flex;
    width: 100%;
    gap: 15px;
}

/* --- POST MENU STYLES --- */
.post-header-right {
    position: relative; 
    margin-left: auto; /* Pushes menu to the far right */
}

.menu-trigger {
    padding: 5px 10px;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1.1rem;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    width: 160px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    display: none; /* Hidden by default */
    z-index: 100;
    overflow: hidden;
}

.dropdown-menu.show {
    display: block;
    animation: fadeIn 0.2s ease;
}

.dropdown-item {
    padding: 12px 15px;
    font-size: 0.85rem;
    color: var(--text-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
    border-bottom: 1px solid var(--border);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item:hover {
    background: var(--bg-input);
}

.dropdown-item.danger {
    color: #ff5555;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* --- LOADING SPINNER --- */
.loader-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 0.8s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin { 
    to { transform: rotate(360deg); } 
}

/* --- STORY TRAY STYLES --- */
.stories-wrapper {
    /* 1. Layout & Scroll */
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    scrollbar-width: none; /* Firefox */
    
    /* 2. "Post Card" Styling */
    background: var(--bg-card);
    border: 1px solid var(--border); /* Full border all around */
    border-radius: 12px;             /* Rounded corners like posts */
    margin-bottom: 15px;             /* Space between stories and first post */
    
    /* 3. Internal Padding */
    padding: 15px 0;                 /* Vertical spacing inside the card */
}

/* Hide scrollbar for Chrome/Safari */
.stories-wrapper::-webkit-scrollbar { display: none; }

.story-tray {
    display: inline-flex;
    padding: 0 15px;
    gap: 15px;
}

.story-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    width: 70px;
}

/* The Gradient Ring Container */
.story-ring-container {
    width: 68px;
    height: 68px;
    border-radius: 50%;
    padding: 2px; /* Thickness of the gap */
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Unseen Story Gradient (Instagram colors) */
.story-ring-container.unseen {
    background-backup: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    background: linear-gradient(45deg, #f09433 0%, #e6d83c 25%, #4edc27 50%, #23a7cc 75%, #185cbc 100%);
}

/* Seen Story (Gray) */
.story-ring-container.seen {
    background: #555;
}

/* No Story (Transparent/Border only) */
.story-ring-container.none {
    background: transparent;
    border: 1px solid var(--border);
    padding: 0;
}

/* The actual profile picture */
.story-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 2px solid var(--bg-card); /* Gap color matching background */
}

/* The "Add" (+) badge for current user */
.add-story-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    background: var(--accent);
    border: 2px solid var(--bg-card);
    border-radius: 50%;
    color: white;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.story-username {
    font-size: 0.75rem;
    margin-top: 5px;
    width: 100%;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-primary);
}

/* --- FULL SCREEN STORY VIEWER --- */
#story-viewer-modal {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 9999;
    display: none;
    flex-direction: column;
}

/* Progress Bars at top */
.story-progress-container {
    display: flex;
    gap: 5px;
    padding: 10px 10px;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 10;
}
.story-progress-bar {
    height: 3px;
    background: rgba(255,255,255,0.3);
    flex: 1;
    border-radius: 2px;
    overflow: hidden;
}
.story-progress-fill {
    height: 100%;
    background: #fff;
    width: 0%; 
    /* transition: width 5s linear; <-- Will be handled via JS */
}

.story-header-overlay {
    position: absolute;
    top: 25px;
    left: 15px;
    right: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
    color: white;
}

.story-image-view {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Show full image */
}

/* --- CUSTOM STORY OPTIONS MODAL --- */
#story-options-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6); /* Dimmed background */
    z-index: 10000;
    display: none; /* Hidden by default */
    align-items: flex-end; /* Align to bottom */
    justify-content: center;
}

#story-options-modal.flex {
    display: flex !important;
}

.story-options-sheet {
    background: var(--bg-card);
    width: 100%;
    max-width: 480px;
    border-radius: 20px 20px 0 0;
    border-top: 1px solid var(--border);
    padding: 10px 0;
    animation: slideUp 0.2s ease-out;
}

/* The buttons inside the sheet */
.story-opt-btn {
    width: 100%;
    padding: 18px 25px;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text-primary);
    font-size: 1rem;
    text-align: left;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    font-family: 'Inter', sans-serif;
}

.story-opt-btn:active {
    background: var(--bg-input);
}

.story-opt-btn:last-child {
    border-bottom: none;
}

.story-opt-btn i {
    font-size: 1.2rem;
    width: 25px;
    text-align: center;
}

/* --- EDIT PROFILE PIC STYLES --- */
.edit-pic-wrapper {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 25px auto;
    cursor: pointer;
}

.edit-pic-img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--border);
}

.edit-pic-badge {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 30px;
    height: 30px;
    background: var(--accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border: 2px solid var(--bg-card);
    font-size: 0.9rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* --- CROPPER MODAL STYLES --- */
#cropper-modal {
    position: fixed;
    inset: 0;
    background: #000000;
    z-index: 9999;
    display: none; /* Hidden by default */
    flex-direction: column;
}

.cropper-container-wrapper {
    flex: 1;
    background: #111;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

/* Ensure image fits max area */
#cropper-target-img {
    display: block;
    max-width: 100%;
}

.cropper-toolbar {
    height: 80px;
    background: var(--bg-card);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 20px;
}

.crop-btn {
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 1.2rem;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    cursor: pointer;
}

.crop-btn i { font-size: 1.4rem; }
.crop-btn.save { color: var(--accent); }
.crop-btn.cancel { color: #ff5555; }

/* --- BANNER & PROFILE HEADER STYLES --- */
.profile-header-wrapper {
    position: relative;
    margin-bottom: 60px; /* Space for the overlapping profile pic */
}

.banner-img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    background-color: var(--bg-card);
    border-radius: 0 0 16px 16px; /* Rounded bottom corners */
    border-bottom: 1px solid var(--border);
}

/* Position the Profile Picture (Circle) to overlap the banner */
.profile-pic-overlap {
    position: absolute;
    bottom: -50px; /* Half of height to overlap */
    left: 50%;
    transform: translateX(-50%);
    width: 110px;
    height: 110px;
    border-radius: 50%;
    border: 4px solid var(--bg-main); /* Creates a "cutout" effect */
    background-color: var(--bg-main);
    z-index: 2;
}

/* --- BANNER PICKER MODAL --- */
#banner-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 10000;
    display: none;
    flex-direction: column;
    padding: 20px;
    overflow-y: auto;
}

.banner-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 Columns */
    gap: 15px;
    margin-top: 20px;
}

.banner-option {
    width: 100%;
    height: 80px;
    border-radius: 8px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.banner-option:hover, .banner-option.selected {
    border-color: var(--accent);
    transform: scale(1.02);
}

/* --- UPLOAD PROGRESS MODAL --- */
#upload-progress-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 12000; /* Highest priority */
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}

.upload-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 30px;
    border-radius: 20px;
    width: 80%;
    max-width: 300px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.upload-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--bg-input);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    margin: 0 auto 20px auto;
    animation: spin 1s linear infinite;
}

.progress-track {
    width: 100%;
    height: 6px;
    background: var(--bg-input);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 15px;
}

.progress-bar {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px var(--accent-glow);
}

.upload-status-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.upload-subtext {
    font-size: 0.75rem;
    color: var(--text-secondary);
}


    </style>
</head>
<body>

    <div id="install-modal">
        <div class="install-icon">
            <i class="fa-solid fa-mobile-screen-button"></i>
        </div>
        <div class="install-title">Install Campus Point</div>
        <p class="install-desc">Add this app to your home screen for faster access, fullscreen view, and a better experience.</p>
        <div class="install-buttons">
            <button class="secondary-btn" onclick="hideInstallPrompt()" style="margin-top:0; flex:1;">Not Now</button>
            <button class="action-btn" onclick="triggerInstall()" style="margin-top:0; flex:1;">Install App</button>
        </div>
    </div>

    <div id="share-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5001; display: flex; justify-content: center; align-items: flex-end;">
        <div id="share-card" style="background: var(--bg-card); width: 100%; max-width: 480px; border-radius: 20px 20px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden;">

            <div style="width: 100%; height: 180px; overflow: hidden; margin-bottom: 20px;">
                <img 
                    src="https://ik.imagekit.io/rstofficial/heroimagecampuspoint.gif" 
                    style="width: 100%; height: 100%; object-fit: cover; display: block;"
                    alt="Friends connecting and collaborating GIF"
                >
            </div>
            <div style="padding: 0 20px 25px; text-align: center;">
                <div class="install-title" style="text-align: center;">Grow Your Network!</div>
                <p class="install-desc" style="margin-top: 8px; text-align: center;">
                    CampusPoint thrives on connection. Share this app with your classmatesâ€”because "friendship builds comfort".
                </p>
                <div class="install-buttons">
                    <button class="secondary-btn" onclick="hideShareModal()" style="margin-top:0; flex:1;">Maybe Later</button>
                    <button class="action-btn" id="share-button-trigger" style="margin-top:0; flex:1;">
                        <i class="fa-solid fa-share-nodes"></i> Share App
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <div id="story-options-modal" onclick="hideStoryOptions()">
    <div class="story-options-sheet" onclick="event.stopPropagation()">
        
        <div style="width: 40px; height: 5px; background: var(--border); margin: 10px auto 15px auto; border-radius: 10px;"></div>
        
        <button class="story-opt-btn" onclick="triggerViewStory()">
            <i class="fa-regular fa-eye"></i> View Your Story
        </button>
        
        <button class="story-opt-btn" onclick="triggerAddStory()">
            <i class="fa-solid fa-circle-plus"></i> Add to Story
        </button>

    </div>
</div>

    <div id="boost-gif-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000; display: flex; justify-content: center; align-items: center;">
        <div style="text-align: center;">
            <img src="https://cdn.pixabay.com/animation/2025/06/04/04/25/04-25-36-422_512.gif" style="width: 150px; height: 150px; border-radius: 10px; opacity: 0.9;" alt="Boost Animation">
            <p class="mono" style="color: var(--boost-color); font-weight: 700; font-size: 1.2rem; margin-top: 10px;">BOOSTED!</p>
        </div>
    </div>

    
    <div id="auth-overlay">
    
            <div class="auth-content">
                <img src="https://ik.imagekit.io/rstofficial/heroimagecampuspoint.gif" class="hero-illustration" style="width:100%; margin-bottom:15px;" alt="Logo">
                
                <h1 class="auth-headline">Connect.<br>Collaborate.<br>Thrive.</h1>
                <p class="auth-subhead">Your campus network starts here.</p>

                <div id="auth-loader" class="loader-spinner"></div>

                <button id="google-btn" class="pinterest-google-btn hidden" onclick="googleLogin()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1024px-Google_%22G%22_logo.svg.png" style="width:20px; height:20px;">
                    Continue with Google
                </button>

                <p id="auth-error" style="color: #ff5555; font-size: 0.8rem; height: 20px;"></p>
            </div>

            <div class="auth-footer">
                By continuing, you agree to Campus Point's 
                <a href="#" onclick="alert('Terms of Service: Be kind and respectful.')">Terms of Service</a> 
                and acknowledge you've read our 
                <a href="#" onclick="alert('Privacy Policy: We respect your data.')">Privacy Policy</a>.
            </div>

        </div>

    <div class="app-container">
        
        <header class="header">
            <div class="brand mono" style="font-weight:700;">CAMPUS<span style="color:var(--accent)">POINT</span></div>
            <div class="h-flex">
                <i class="fa-solid fa-moon" id="theme-btn" onclick="toggleTheme()" style="margin-right: 20px; color: var(--text-secondary); cursor:pointer;"></i>
                <img id="header-avatar" src="" style="width:28px; height:28px; border-radius:6px; display:none;">
            </div>
        </header>

        <div class="floating-fab" onclick="switchTab('create', null)">
            <i class="fa-solid fa-pen"></i>
        </div>

        <main id="section-setup" class="content-area hidden" style="padding-top: 0;">
    
            <div class="profile-header-wrapper" style="margin-bottom: 50px;">
            
                <img id="setup-banner-preview" src="" class="banner-img">
                
                <button class="secondary-btn" onclick="openBannerModal()" style="position: absolute; bottom: 10px; right: 10px; width: auto; background: rgba(0,0,0,0.6); color: white; border: none; font-size: 0.8rem; padding: 5px 12px; z-index: 10; border-radius: 6px;">
                    <i class="fa-solid fa-image"></i> Change Banner
                </button>

                <div class="edit-pic-wrapper profile-pic-overlap" onclick="document.getElementById('setup-file-input').click()" style="margin: 0;">
                    <img id="setup-pic-preview" src="" class="edit-pic-img">
                    <div class="edit-pic-badge">
                        <i class="fa-solid fa-pencil"></i>
                    </div>
                </div>
            </div>

    <div style="padding: 0 20px 80px 20px;"> <h2 class="mono" style="text-align:center; margin-bottom: 20px;">EDIT PROFILE</h2>
        
        <input type="file" id="setup-file-input" accept="image/*" style="display:none;" onchange="previewProfilePic()">

        <label>FULL NAME</label>
        <input type="text" id="setup-name" class="nexus-input">
        
        <label>INSTITUTION</label>
        <input type="text" id="setup-university" class="nexus-input">
        
        <label>MAJOR</label>
        <input type="text" id="setup-major" class="nexus-input">
        
        <label>YEAR</label>
        <input type="text" id="setup-year" class="nexus-input">

        <label>BIO <span id="bio-count" style="float:right; font-size:0.7rem;">0/150</span></label>
        <textarea id="setup-bio" class="nexus-input" rows="3" maxlength="150" oninput="updateBioCount()"></textarea>

        <label>INTERESTS</label>
        <div id="setup-interests" class="interests-container"></div>

        <label>FUTURE VISION</label>
        <input type="text" id="setup-goal" class="nexus-input">
        
        <button id="btn-save-profile" class="action-btn" onclick="completeSetup()">SAVE PROFILE</button>
        <button class="secondary-btn" onclick="cancelSetup()" style="width:100%;">Cancel</button>
    </div>
</main>

        <main id="section-feed" class="content-area hidden">
            <div class="stories-wrapper">
        <div id="stories-tray" class="story-tray">
            </div>
    </div>
            <div id="feed-container"></div>
        </main>

        <input type="file" id="story-file-input" accept="image/*" style="display:none;" onchange="handleStoryFileSelect()">


<div id="story-viewer-modal">
    <div id="story-progress-bars" class="story-progress-container"></div>
    
    <div class="story-header-overlay">
        <div class="h-flex">
            <div id="sv-avatar" class="avatar" style="border:none; width:32px; height:32px;"></div>
            <div id="sv-name" style="font-weight:600; font-size:0.9rem; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">User</div>
            <div id="sv-time" style="font-size:0.8rem; opacity:0.8; margin-left:10px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);">1h</div>
        </div>
        <i class="fa-solid fa-xmark" onclick="closeStoryViewer()" style="font-size:1.5rem; cursor:pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.5);"></i>
    </div>

    <img id="sv-image" src="" class="story-image-view">
    
    <div style="position:absolute; top:0; bottom:0; left:0; width:30%; z-index:5;" onclick="prevStory()"></div>
    <div style="position:absolute; top:0; bottom:0; right:0; width:30%; z-index:5;" onclick="nextStory()"></div>

    <div id="sv-delete-btn" onclick="deleteCurrentStory()" style="position:absolute; bottom:20px; right:20px; color:white; z-index:10; display:none; cursor:pointer;">
        <i class="fa-solid fa-trash"></i>
    </div>
</div>

        <main id="section-chat-list" class="content-area hidden">
            <h2 class="mono" style="margin-bottom:20px;">MESSAGES</h2>
            <div id="chat-list-container">
                <p style="text-align:center; color:var(--text-secondary)">Loading chats...</p>
            </div>
        </main>

        <main id="section-create" class="content-area hidden">
            <h2 class="mono" style="margin-bottom: 20px;">NEW UPDATE</h2>
            
            <label>TOPIC TAG</label>
            <input type="text" id="post-goal" class="nexus-input" placeholder="#ExamPrep, #Project... ">
            
            <label>CONTENT</label>
            <textarea id="post-text" class="nexus-input" rows="5" placeholder="Share your thoughts or ask a question..."></textarea>
            
            <label>ATTACH IMAGE (Will be compressed)</label>
            <div style="margin-bottom: 15px;">
                <input type="file" id="post-file" accept="image/*" style="display:none;" onchange="previewImage()">
                <button class="secondary-btn" onclick="document.getElementById('post-file').click()" style="width:100%; text-align:center;">
                    <i class="fa-solid fa-camera"></i> Select Image
                </button>
            </div>
            
            <div id="image-preview" style="display:none; margin-bottom:15px; position:relative;">
                <img id="preview-img" src="" style="width:100%; border-radius:8px; border:1px solid var(--border);">
                <button onclick="clearImage()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer;">&times;</button>
            </div>

            <button id="btn-post" class="action-btn" onclick="createPost()">POST UPDATE</button>
        </main>

        <main id="section-radar" class="content-area hidden">
    
    <div style="width: 100%; display: flex; justify-content: center; margin-bottom: 20px;">
        <div id="gps-status-indicator" class="mono" style="font-size: 0.75rem; background: var(--bg-card); border: 1px solid var(--border); padding: 6px 16px; border-radius: 50px; color: var(--text-secondary); box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <i class="fa-solid fa-satellite-dish"></i> GPS: CHECKING...
        </div>
    </div>

    <div id="radar-permission-warning" class="hidden" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; text-align: center; padding: 0 20px;">
        
        <div style="width: 70px; height: 70px; background: rgba(255, 85, 85, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <i class="fa-solid fa-map-location-dot" style="font-size: 1.8rem; color: #ff5555;"></i>
        </div>

        <h3 class="mono" style="margin-bottom: 10px; font-size: 1rem;">LOCATION REQUIRED</h3>
        
        <p id="gps-msg" style="color: var(--text-secondary); max-width: 280px; margin-bottom: 25px; line-height: 1.5; font-size: 0.9rem;">
            To see students nearby, CampusPoint needs access to your GPS location.
        </p>

        <button id="btn-gps-retry" class="action-btn" onclick="retryGPS()" style="width: auto; padding: 12px 30px;">
            <i class="fa-solid fa-location-crosshairs"></i> Allow Location
        </button>
        
        <p id="gps-manual-instruction" class="hidden" style="font-size: 0.8rem; color: #ff5555; margin-top: 15px; border: 1px dashed #ff5555; padding: 10px; border-radius: 8px; background: rgba(255,85,85,0.05);">
            <i class="fa-solid fa-lock"></i> <b>Permission Blocked</b><br>
            Tap the <b>Lock Icon ðŸ”’</b> in your browser address bar and hit "Reset Permission".
        </p>
    </div>

    <div id="radar-content" class="hidden">
        <div class="radar-view">
            <div class="radar-circle">
                <div class="radar-sweep"></div>
            </div>
        </div>
        <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; text-align: center;">NEARBY STUDENTS</h3>
        <div id="user-list"></div>
    </div>

</main>


<main id="section-groups" class="content-area hidden">
            <h2 class="mono" style="margin-bottom: 20px;">GROUP CHATS</h2>
            <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:30px;">Find people passionate about the same things.</p>
            
            <div id="group-list-container">
                <p style="text-align:center; color:var(--text-secondary)">Loading available groups...</p>
            </div>
        </main>

        <main id="section-profile" class="content-area hidden" style="padding-top: 0;">
            <div class="profile-header-wrapper">
                <img id="profile-banner" src="" class="banner-img">
                <img id="profile-pic" src="" class="profile-pic-overlap">
            </div>

            <div style="text-align: center; padding: 0 20px;">
                <h2 id="profile-name">User</h2>
                <p id="profile-academic" class="mono" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 5px;"></p>
                <p id="profile-uni" style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 15px;"></p>

                <div id="profile-bio" class="bio-text"></div>
<div id="profile-goal-container" style="display:none;">
    <div class="future-goal-display">
        <i class="fa-solid fa-rocket"></i> 5y Goal: <span id="profile-goal"></span>
    </div>
</div>
<div id="profile-interests" class="interests-container"></div>
                
                <div class="stats-row">
                    <div class="stat-box"><h3 id="stat-followers" style="color:var(--accent)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWERS</span></div>
                    <div class="stat-box"><h3 id="stat-following" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWING</span></div>
                    <div class="stat-box"><h3 id="stat-posts" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">POSTS</span></div>
                </div>

                <div class="h-flex" style="justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <button class="secondary-btn" onclick="editProfile()">Edit Profile</button>
                    <button class="secondary-btn" style="border-color: #ff5555; color: #ff5555;" onclick="firebase.auth().signOut()">Logout</button>
                </div>
            </div>
            <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">MY POSTS</h3>
            <div id="profile-feed"></div>
        </main>

        <main id="section-other-profile" class="content-area hidden" style="padding-top: 0;">
    <div class="profile-header-wrapper">
        <img id="other-banner" src="" class="banner-img">
        <div id="other-pic" class="profile-pic-overlap" style="background-size: cover; border-width: 4px; border-style: solid; border-color: var(--bg-main);"></div>
    </div>
    <div style="text-align: center; padding: 20px 0;">
        <h2 id="other-name">User</h2>
        <p id="other-academic" class="mono" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 5px;"></p>
        
        <div id="other-bio" class="bio-text"></div>
        
        <div id="other-goal-container" style="display:none;">
            <div class="future-goal-display">
                <i class="fa-solid fa-rocket"></i> 5y Goal: <span id="other-goal"></span>
            </div>
        </div>
        
        <div id="other-interests" class="interests-container"></div>
        
        <div class="stats-row">
            <div class="stat-box"><h3 id="other-stat-followers" style="color:var(--accent)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWERS</span></div>
            <div class="stat-box"><h3 id="other-stat-following" style="color:var(--text-primary)">0</h3><span class="mono" style="font-size:0.7rem">FOLLOWING</span></div>
        </div>

        <div class="h-flex" style="justify-content: center; gap: 10px; margin-bottom: 20px;">
            <button id="btn-follow" class="action-btn" style="width:auto; margin-top:0;" onclick="toggleFollow()">Follow</button>
            <button class="secondary-btn2" style="margin-top:0;" onclick="startChat()">Message</button>
        </div>
    </div> 
    <h3 class="mono" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">ACTIVITY</h3>
    <div id="other-profile-feed"></div>
</main>

        <main id="section-follow-list" class="content-area hidden">
            <div class="h-flex" style="margin-bottom: 20px;">
                <i class="fa-solid fa-arrow-left" onclick="closeFollowList()" style="font-size: 1.2rem; cursor: pointer; padding: 10px;"></i>
                <div id="follow-list-title" class="mono" style="font-weight: 700; font-size: 1.1rem; margin-left: 10px;">TITLE</div>
            </div>
            <div id="follow-list-content">
                </div>
        </main>

        <nav class="bottom-nav hidden" id="main-nav">
            <div class="nav-item active" onclick="switchTab('feed', this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="switchTab('radar', this)"><i class="fa-regular fa-compass"></i></div>
            <div class="nav-item" onclick="switchTab('groups', this)"><i class="fa-solid fa-users"></i></div>
            <div class="nav-item" onclick="switchTab('chat-list', this)"><i class="fa-regular fa-comments"></i></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><i class="fa-regular fa-user"></i></div>
        </nav>

    </div>


    <div id="cropper-modal">
        <div class="cropper-container-wrapper">
            <img id="cropper-target-img" src="">
        </div>
        
        <div class="cropper-toolbar">
            <button class="crop-btn cancel" onclick="cancelCrop()">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button class="crop-btn" onclick="rotateImage(-90)">
                <i class="fa-solid fa-rotate-left"></i> Rotate
            </button>
            <button class="crop-btn" onclick="rotateImage(90)">
                <i class="fa-solid fa-rotate-right"></i> Rotate
            </button>
            <button class="crop-btn save" onclick="finishCrop()">
                <i class="fa-solid fa-check"></i> Done
            </button>
        </div>
    </div>

    <div id="banner-modal">
    <div class="h-flex" style="justify-content: space-between; margin-bottom: 10px;">
        <h3 style="color: white;">Select Banner</h3>
        <i class="fa-solid fa-xmark" onclick="closeBannerModal()" style="color: white; font-size: 1.5rem; cursor: pointer;"></i>
    </div>
    <div id="banner-grid-container" class="banner-grid">
        </div>
</div>

<div id="upload-progress-modal">
    <div class="upload-card">
        <div class="upload-spinner"></div>
        <div class="upload-status-text">UPLOADING...</div>
        <div id="upload-subtext" class="upload-subtext">Compressing media</div>
        <div class="progress-track">
            <div id="upload-progress-bar" class="progress-bar"></div>
        </div>
    </div>
</div>

    <script>

        // Pre-defined high quality banners (Unsplash)
const BANNER_OPTIONS = [
    "https://images.unsplash.com/photo-1674257751921-4ec8fc65e563?w=600&q=80", // Gradient Blue
    "https://images.unsplash.com/photo-1557683316-973673baf926?w=600&q=80", // Gradient Dark
    "https://plus.unsplash.com/premium_photo-1723924899327-48f529ba853b?w=600&q=80", // Night Sky
    "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=600&q=80", // Tech/Globe
    "https://images.unsplash.com/photo-1493246507139-91e8fad9978e?w=600&q=80", // Mountains
    "https://images.unsplash.com/photo-1513542789411-b6a5d4f31634?w=600&q=80", // Neon City
    "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=600&q=80", // Beach
    "https://images.unsplash.com/photo-1571470804270-af65e8b3d106?w=600&q=80", // Code
    "https://images.unsplash.com/photo-1526374965328-7f61d4dc18c5?w=600&q=80", // Matrix/Cyber
    "https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=600&q=80"  // Library/Books
];

let selectedBannerUrl = BANNER_OPTIONS[0]; // Default
const DEFAULT_BANNER = BANNER_OPTIONS[0];

// --- IMPROVED PWA INSTALLATION LOGIC (Android & iOS) ---

// 1. Register Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker Registered'))
            .catch(err => console.log('Service Worker Failed', err));
    });
}

// 2. iOS Detection Helper
function isIOS() {
    return [
        'iPad Simulator',
        'iPhone Simulator',
        'iPod Simulator',
        'iPad',
        'iPhone',
        'iPod'
    ].includes(navigator.platform)
    // iPad on iOS 13 detection
    || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

// 3. Logic to Show Install Prompt
let deferredPrompt;
const installModal = document.getElementById('install-modal');
const isAppInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

// Check if already installed to avoid showing modal
if (!isAppInstalled) {
    
    // ANDROID / DESKTOP LOGIC
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show modal if not dismissed recently
        if (!localStorage.getItem('installDismissed')) {
            setTimeout(() => {
                showInstallModal('android');
            }, 2000);
        }
    });

    // iOS LOGIC (Since beforeinstallprompt doesn't fire)
    if (isIOS() && !localStorage.getItem('installDismissed')) {
        setTimeout(() => {
            showInstallModal('ios');
        }, 2000);
    }
}

function showInstallModal(platform) {
    installModal.style.display = 'flex';
    
    if (platform === 'ios') {
        // Change text and hide button for iOS
        document.querySelector('.install-title').innerText = "Install on iOS";
        document.querySelector('.install-desc').innerHTML = `
            To install this app on your iPhone:<br><br>
            1. Tap the <b>Share</b> button <i class="fa-solid fa-arrow-up-from-bracket"></i><br>
            2. Scroll down and tap <b>"Add to Home Screen"</b> <i class="fa-regular fa-square-plus"></i>
        `;
        // Hide the "Install App" button since we can't trigger it programmatically
        document.querySelector('.action-btn').style.display = 'none';
        // Make "Not Now" span full width
        document.querySelector('.secondary-btn').style.width = '100%';
        document.querySelector('.secondary-btn').innerText = "Close";
    }
}

function hideInstallModal() {
    installModal.style.display = 'none';
    localStorage.setItem('installDismissed', 'true');
}

// Rename your existing function to match the call above
function hideInstallPrompt() {
    hideInstallModal();
}

function openBannerModal() {
    const container = document.getElementById('banner-grid-container');
    container.innerHTML = '';
    
    BANNER_OPTIONS.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'banner-option';
        if(url === selectedBannerUrl) img.classList.add('selected');
        
        img.onclick = () => {
            selectedBannerUrl = url;
            // Visual feedback
            document.querySelectorAll('.banner-option').forEach(el => el.classList.remove('selected'));
            img.classList.add('selected');
            
            // Update preview
            document.getElementById('setup-banner-preview').src = url;
            
            // Close modal after short delay
            setTimeout(closeBannerModal, 200);
        };
        container.appendChild(img);
    });
    
    document.getElementById('banner-modal').style.display = 'flex';
}

function closeBannerModal() {
    document.getElementById('banner-modal').style.display = 'none';
}

// --- UPLOAD MODAL HELPERS ---
function showUploadModal(text) {
    document.getElementById('upload-progress-modal').style.display = 'flex';
    document.getElementById('upload-subtext').innerText = text || "Processing...";
    updateProgressBar(10); // Start little bit
}

function hideUploadModal() {
    document.getElementById('upload-progress-modal').style.display = 'none';
    updateProgressBar(0); // Reset
}

function updateProgressBar(percent) {
    document.getElementById('upload-progress-bar').style.width = percent + '%';
}

// --- ANIMATION FUNCTION ---
function showBoostAnimation() {
    const modal = document.getElementById('boost-gif-modal');
    // Show the modal instantly
    modal.classList.remove('hidden');

    // Hide it after 1000 milliseconds (1 second)
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 1000);
}

// --- GROUP CHAT LOBBY LOGIC (index.html) ---

function loadGroupLobby() {
    const container = document.getElementById('group-list-container');
    container.innerHTML = '';
    
    // Use the HOBBIES_LIST array to create rooms (HOBBIES_LIST should be global in index.html)
    HOBBIES_LIST.forEach(hobby => {
        const details = getHobbyIcon(hobby); // Get both icon and color
        
        container.innerHTML += `
            <div class="chat-item" onclick="checkGroupJoin('${hobby}')" style="cursor:pointer;">
                <div class="avatar" style="
                    background: ${details.color}15; 
                    font-size:1.3rem; 
                    color: ${details.color}; 
                    display:flex; 
                    align-items:center; 
                    justify-content:center;
                    border: 1px solid ${details.color}40;
                ">
                    <i class="fa-solid ${details.icon}"></i>
                </div>
                <div>
                    <div style="font-weight:600;">#${hobby} Lounge</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">Live group chat for ${hobby} enthusiasts.</div>
                </div>
                <button class="secondary-btn" style="
                    margin-top:0; 
                    margin-left:auto; 
                    padding: 6px 12px; 
                    font-weight:600; 
                    border-color: ${details.color}; 
                    color: ${details.color};
                ">Join</button>
            </div>
        `;
    });
}

function previewProfilePic() {
    const fileInput = document.getElementById('setup-file-input');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // 1. Set the image source for the cropper
            const imgElement = document.getElementById('cropper-target-img');
            imgElement.src = e.target.result;
            
            // 2. Show the modal
            document.getElementById('cropper-modal').style.display = 'flex';

            // 3. Destroy previous cropper if exists (to prevent bugs)
            if(cropper) {
                cropper.destroy();
            }

            // 4. Initialize Cropper.js
            cropper = new Cropper(imgElement, {
                aspectRatio: 1, // Force Square for profile pics
                viewMode: 1,    // Restrict crop box to image size
                dragMode: 'move',
                autoCropArea: 0.8,
                background: false, // Dark background
            });
        }
        reader.readAsDataURL(file);
    }
}

function rotateImage(deg) {
    if(cropper) cropper.rotate(deg);
}

function cancelCrop() {
    document.getElementById('cropper-modal').style.display = 'none';
    document.getElementById('setup-file-input').value = ""; // Reset input
    if(cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function finishCrop() {
    if(!cropper) return;

    // 1. Get the cropped canvas
    const canvas = cropper.getCroppedCanvas({
        width: 500,  // Resize to reasonable profile size
        height: 500
    });

    // 2. Convert canvas to Blob/File
    canvas.toBlob((blob) => {
        // Create a new File object from the blob
        finalCroppedFile = new File([blob], "profile-edited.jpg", { type: "image/jpeg" });

        // 3. Update the Preview in the Setup Screen
        document.getElementById('setup-pic-preview').src = URL.createObjectURL(finalCroppedFile);

        // 4. Close Modal
        document.getElementById('cropper-modal').style.display = 'none';
        
        // Cleanup
        cropper.destroy();
        cropper = null;

    }, 'image/jpeg', 0.9);
}

function getHobbyIcon(hobby) {
    // Map hobby to a specific Font Awesome class and a unique Hex color code.
    const map = {
        "Coding": { icon: "fa-code", color: "#FF5555" },       // Bright Red/Pink (Tech/Logic)
        "Music": { icon: "fa-compact-disc", color: "#FFD700" }, // Gold (Media/Creativity)
        "Travel": { icon: "fa-plane-departure", color: "#4DABF8" }, // Accent Blue (Exploration)
        "Gaming": { icon: "fa-gamepad", color: "#9B59B6" },    // Purple (Entertainment)
        "Reading": { icon: "fa-book", color: "#2ECC71" },      // Emerald Green (Knowledge)
        "Fitness": { icon: "fa-dumbbell", color: "#E67E22" },  // Orange (Energy/Health)
        "Photography": { icon: "fa-camera-retro", color: "#F39C12" }, // Yellow/Orange (Art)
        "Art": { icon: "fa-palette", color: "#E91E63" },       // Rose Pink (Visual Creation)
        "Startups": { icon: "fa-lightbulb", color: "#3498DB" },  // Bright Blue (Ideas)
        "AI": { icon: "fa-robot", color: "#1ABC9C" },          // Cyan/Teal (Future Tech)
        "Foodie": { icon: "fa-utensils", color: "#95A5A6" },   // Gray/Silver (Lifestyle)
        "Movies": { icon: "fa-clapperboard", color: "#D35400" }, // Dark Orange/Brown (Cinema)
        "Sports": { icon: "fa-basketball", color: "#E74C3C" }, // Coral Red (Activity)
        "Writing": { icon: "fa-pen-nib", color: "#9B59B6" },   // Purple (Intellectual)
        "Dance": { icon: "fa-compact-disc", color: "#00BCD4" }, // Turquoise/Cyan (Rhythm/Movement)
        "Nature": { icon: "fa-leaf", color: "#16A085" },       // Dark Green (Environment)
        "Fashion": { icon: "fa-shirt", color: "#AF7AC5" },     // Light Purple (Style)
        "Politics": { icon: "fa-gavel", color: "#7F8C8D" }     // Dark Gray (Authority/Civic)
    };
    
    // Return the color and icon, or a fallback.
    return map[hobby] || { icon: "fa-hashtag", color: "#888888" };
}

function checkGroupJoin(groupName) {
    const confirmation = confirm(`Joining #${groupName} Lounge:

Agreement:
1. Be respectful to all members.
2. No spamming, excessive links, or abuse.
3. Excessive violations WILL result in a permanent ban.

Do you agree to these terms and wish to enter?`);

    if (confirmation) {
        // Redirect to the new group chat file
        window.location.href = `group.html?group=${groupName}`;
    }
}

// Call the loadGroupLobby in the loadAppInterface
// Find loadAppInterface and add:
/*
function loadAppInterface(userData) {
    // ... existing code ...
    startNotificationListener(); 
    loadGroupLobby(); // <--- ADD THIS
    // ... existing code ...
}
*/

async function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response: ${outcome}`);
        deferredPrompt = null;
        installModal.style.display = 'none';
    }
}

window.addEventListener('appinstalled', () => {
    installModal.style.display = 'none';
    console.log('PWA was installed');
});

// --- SHARE MODAL FUNCTIONS ---

// The URL you want to share
const SHARE_URL = "https://campuspoint.netlify.app";

function showShareModal() {
    document.getElementById('share-modal').classList.remove('hidden');
}

function hideShareModal() {
    document.getElementById('share-modal').classList.add('hidden');
}

document.getElementById('share-button-trigger').onclick = async () => {
    hideShareModal();
    
    // Check if the Web Share API is available (Best for mobile)
    if (navigator.share) {
        try {
            await navigator.share({
                title: 'Campus Point',
                text: 'Connect with students on your campus for projects, discussions, and networking!',
                url: SHARE_URL,
            });
            console.log('Share successful');
        } catch (error) {
            // This happens if the user cancels the share, which is fine
            console.log('Error sharing:', error);
        }
    } else {
        // Fallback for browsers that don't support navigator.share (e.g., Desktop browsers)
        // Copy link to clipboard instead.
        navigator.clipboard.writeText(SHARE_URL);
        alert(`Link copied to clipboard! Share it with friends:\n${SHARE_URL}`);
    }
};

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBg1m_bFN4xzl4yJ_JiG8E6UPDZjFks7PM",
        authDomain: "campus-point-rst.firebaseapp.com",
        projectId: "campus-point-rst",
        storageBucket: "campus-point-rst.firebasestorage.app",
        messagingSenderId: "877074516750",
        appId: "1:877074516750:web:f485c45a1446c030afa55f",
        measurementId: "G-M4WDE31CTL"
    };

    // --- IMAGEKIT CONFIG (Replace with your keys) ---
    const IMAGEKIT_URL_ENDPOINT = "https://ik.imagekit.io/rstofficial"; 
    const IMAGEKIT_PUBLIC_KEY = "public_tHyBprcdz5rljWej0F2U9xfKYU0="; 
    

    const HOBBIES_LIST = [
    "Coding", "Music", "Travel", "Gaming", "Reading", "Fitness", 
    "Photography", "Art", "Startups", "AI", "Foodie", "Movies", 
    "Sports", "Writing", "Dance", "Nature", "Fashion", "Politics"
];
let selectedHobbies = new Set();

    let db, auth, currentUser;
    let globalProfileData = {};
    let myLocation = null;
    let viewingUserId = null;
    let lastProfileTab = 'profile'; // Remembers where to go back to
    let cropper = null; 
let finalCroppedFile = null; // Stores the edited file ready for upload

    // --- 1. NEW ROUTER SYSTEM ---
    
    // This function handles the actual UI changes based on the URL hash
    function router() {
        // Get the hash (remove the #) or default to 'feed'
        const hash = window.location.hash.slice(1) || 'feed';
        
        // Hide all sections
        document.querySelectorAll('.content-area').forEach(el => el.classList.add('hidden'));
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        // Handle specific screens
        const activeSection = document.getElementById('section-' + hash);
        
        if (activeSection) {
            // Show the section matching the hash
            activeSection.classList.remove('hidden');
            
            // Highlight the corresponding Bottom Nav item (if it exists)
            // We match based on the onclick attribute containing the hash name
            const navBtn = document.querySelector(`.nav-item[onclick*="'${hash}'"]`);
            if (navBtn) navBtn.classList.add('active');
        } else {
            // Fallback: If hash doesn't match any ID, go to feed
            window.location.hash = 'feed';
        }

        // Special handling for Floating Action Button (Only show on feed)
        const fab = document.querySelector('.floating-fab');
        if (fab) {
            fab.style.display = (hash === 'feed') ? 'flex' : 'none';
        }
    }

    // --- 2. MODIFIED SWITCHTAB ---
    // Instead of changing UI directly, this now just updates the URL.
    // The 'hashchange' listener below will detect this and fire the router().
    function switchTab(id) {
        window.location.hash = id;
    }

    // --- 3. LISTEN FOR BACK BUTTON & LOAD ---
    // This detects when user clicks Back button or allows the app
    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => {
        // If no hash exists on load, set it to feed
        if(!window.location.hash) window.location.hash = 'feed';
        router();
    });

    // --- INIT ---
    function initApp() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        
        auth.onAuthStateChanged(user => {
            const loader = document.getElementById('auth-loader');
            const btn = document.getElementById('google-btn');
            const overlay = document.getElementById('auth-overlay');

            if (user) {
                // --- USER LOGGED IN ---
                currentUser = user;
                
                // WAIT 2 SECONDS (2000ms) before transitioning
                setTimeout(() => {
                    // 1. Hide the auth screen
                    overlay.classList.add('hidden');
                    
                    // 2. Load the app data
                    checkUserProfile(user);
                }, 2000);

            } else {
                // --- USER NOT LOGGED IN ---
                // Show the login button immediately if no user is found
                
                overlay.classList.remove('hidden');
                
                if(loader) loader.style.display = 'none';
                
                if(btn) {
                    btn.classList.remove('hidden');
                    btn.style.display = 'flex'; 
                }
                
                document.getElementById('main-nav').classList.add('hidden');
            }
        });
    } catch (e) {
        console.error(e);
        alert("Init Error");
    }
}

// Add this anywhere in your script
function requestNotificationPermission() {
    if (!("Notification" in window)) {
        console.log("This browser does not support desktop notification");
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notification permission granted!");
            }
        });
    }
}

// Call this immediately when the app loads or inside initApp()
requestNotificationPermission();

function startNotificationListener() {
    // Listen to chats where I am a participant
    db.collection('chats')
      .where('participants', 'array-contains', currentUser.uid)
      .onSnapshot(snapshot => {
          // Iterate through changes only (not all docs)
          snapshot.docChanges().forEach(change => {
              // We only care about 'modified' events (new messages in existing chats)
              // or 'added' events (new chat started)
              if (change.type === "modified" || change.type === "added") {
                  const chatData = change.doc.data();
                  const chatId = change.doc.id;

                  // 1. Check if the message exists and wasn't sent by me
                  if (chatData.lastSenderId && chatData.lastSenderId !== currentUser.uid) {
                      
                      // 2. Check time difference to avoid notifying for old messages on page load
                      // (If message is older than 10 seconds, ignore it)
                      const now = new Date();
                      const msgTime = chatData.lastUpdated ? chatData.lastUpdated.toDate() : new Date(0);
                      const diff = (now - msgTime) / 1000; 

                      if (diff < 10) { 
                          // 3. Get sender details
                          const senderId = chatData.lastSenderId;
                          const senderDetails = chatData.participantDetails[senderId];
                          const senderName = senderDetails ? senderDetails.name : "Someone";
                          
                          // 4. Trigger the notification
                          showSystemNotification(senderName, chatData.lastMessage, chatId);
                      }
                  }
              }
          });
      });
}

function showSystemNotification(title, body, chatId) {
    if (Notification.permission === "granted") {
        const options = {
            body: body,
            icon: 'https://ik.imagekit.io/rstofficial/CAMPUS.png',
            badge: 'https://ik.imagekit.io/rstofficial/CAMPUS.png', // Android specific (small icon)
            vibrate: [200, 100, 200],
            tag: chatId,
            data: { url: `chat.html?chatId=${chatId}` } // Pass URL to Service Worker
        };

        // ANDROID FIX: Ask Service Worker to show it
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(function(registration) {
                registration.showNotification(`New message from ${title}`, options);
            });
        } else {
            // Fallback for Desktop if SW fails
            new Notification(`New message from ${title}`, options);
        }
    }
}

// Add this helper function to your script block
function getHobbyDetails(hobby) {
    // A stable, unique color for each hobby, visible on both themes.
    const colorMap = {
        "Coding": "#FF5555", "Music": "#D35400", "Travel": "#4DABF8",
        "Gaming": "#9B59B6", "Reading": "#2ECC71", "Fitness": "#E67E22",
        "Photography": "#F39C12", "Art": "#E91E63", "Startups": "#3498DB",
        "AI": "#1ABC9C", "Foodie": "#D35400", "Movies": "#AF7AC5",
        "Sports": "#E74C3C", "Writing": "#00BCD4", "Dance": "#34495E",
        "Nature": "#16A085", "Fashion": "#95A5A6", "Politics": "#7F8C8D"
    };
    return colorMap[hobby] || 'var(--text-secondary)';
}

    // --- NEW GPS HANDLING LOGIC ---
// --- ADVANCED GPS HANDLING ---

let gpsWatcher = null; // Store permission listener

function requestGPS() {
    const MAX_RANGE = 5000;
    const statusEl = document.getElementById('gps-status-indicator');
    
    // Display the max range in the indicator area
    statusEl.innerHTML = `<i class="fa-solid fa-satellite-dish"></i> RANGE: <span style="color:#4dabf8">${MAX_RANGE / 1000} KM</span>`;

    // 1. Check if Permissions API is supported
    if (navigator.permissions && navigator.permissions.query) {
        navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
            
            // Handle current state
            handlePermissionState(result.state);

            // Listen for changes (e.g. if user resets settings while on page)
            result.onchange = function() {
                handlePermissionState(this.state);
            };
        });
    } else {
        // Fallback for older browsers
        attemptGeoFetch();
    }
}

function handlePermissionState(state) {
    const statusEl = document.getElementById('gps-status-indicator');
    const warningDiv = document.getElementById('radar-permission-warning');
    const contentDiv = document.getElementById('radar-content');
    const msg = document.getElementById('gps-msg');
    const manualInst = document.getElementById('gps-manual-instruction');
    const retryBtn = document.getElementById('btn-gps-retry');

    // Reset UI visibility
    contentDiv.classList.add('hidden');
    warningDiv.classList.remove('hidden');
    warningDiv.style.display = 'flex';
    manualInst.classList.add('hidden');

    if (state === 'granted') {
        // PERMISSION GRANTED: Go ahead
        statusEl.innerHTML = 'STATUS: <span style="color:#4dabf8">ACTIVE</span>';
        warningDiv.classList.add('hidden');
        contentDiv.classList.remove('hidden');
        attemptGeoFetch(); // Actually get the coords
    } 
    else if (state === 'prompt') {
        // PROMPT: User hasn't decided yet
        statusEl.innerHTML = 'STATUS: <span style="color:#FFD700">WAITING</span>';
        msg.innerText = "Please tap 'Allow' when the browser popup appears.";
        retryBtn.style.display = 'block';
    } 
    else if (state === 'denied') {
        // DENIED: User blocked it. Button won't work.
        statusEl.innerHTML = 'STATUS: <span style="color:#ff5555">BLOCKED</span>';
        msg.innerText = "Location access is blocked. We cannot open the popup again.";
        manualInst.classList.remove('hidden'); // Show instruction how to fix
        retryBtn.style.display = 'none'; // Hide button since it won't work
    }
}

function attemptGeoFetch() {
    if (!navigator.geolocation) return alert("GPS not supported");

    navigator.geolocation.getCurrentPosition(
        (position) => {
            // SUCCESS
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            myLocation = { lat, lng };

            db.collection('users').doc(currentUser.uid).update({
                location: { lat, lng },
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Ensure UI is correct (in case Permissions API wasn't supported)
            document.getElementById('radar-permission-warning').classList.add('hidden');
            document.getElementById('radar-content').classList.remove('hidden');
            
            loadNearbyUsers();
        },
        (error) => {
            // ERROR (Denied or Timeout)
            console.warn("GPS Error", error);
            // If error is PERMISSION_DENIED (code 1), force denied state UI
            if(error.code === 1) handlePermissionState('denied');
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function retryGPS() {
    attemptGeoFetch();
}

    // --- AUTH & FLOW ---
    function googleLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(err => alert(err.message));
    }

    function checkUserProfile(user) {
        db.collection('users').doc(user.uid).get().then(doc => {
            if (doc.exists) {
                globalProfileData = doc.data();
                loadAppInterface(globalProfileData);
            } else {
                document.getElementById('setup-name').value = user.displayName;
                switchTab('setup', null);
            }
        });
    }

    async function completeSetup() {
    const name = document.getElementById('setup-name').value;
    const uni = document.getElementById('setup-university').value;
    const major = document.getElementById('setup-major').value;
    const year = document.getElementById('setup-year').value;
    const bio = document.getElementById('setup-bio').value;
    const futureGoal = document.getElementById('setup-goal').value;
    
    // NEW: Get the file
    const fileInput = document.getElementById('setup-file-input');
    const saveBtn = document.getElementById('btn-save-profile');

    if(!name || !uni || !major) return alert("Required fields missing");

    // UI Feedback
    saveBtn.innerText = "SAVING...";
    saveBtn.disabled = true;

    try {
        let finalPhotoURL = currentUser.photoURL; // Default to existing

        // Check if user selected a NEW file
        if (finalCroppedFile) {
            saveBtn.innerText = "UPLOADING IMAGE...";
            
            // 1. Compress (optional, since we resized in cropper, but good for safety)
            const compressed = await compressImage(finalCroppedFile);
            
            // 2. Upload
            const newUrl = await uploadToImageKit(compressed);
            
            if (newUrl) {
                finalPhotoURL = newUrl;
                await currentUser.updateProfile({ photoURL: finalPhotoURL });
            }
        }

        const userData = {
            uid: currentUser.uid, 
            displayName: name, 
            email: currentUser.email, 
            photoURL: finalPhotoURL, // Save the new URL to Firestore
            bannerUrl: selectedBannerUrl,
            academic: { university: uni, major: major, year: year },
            bio: bio,
            futureGoal: futureGoal,
            interests: Array.from(selectedHobbies),
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Send update
        await db.collection('users').doc(currentUser.uid).set(userData, { merge: true });

        // Update local data
        globalProfileData = { ...globalProfileData, ...userData };
        loadAppInterface(globalProfileData);
        
        // Reset UI
        saveBtn.innerText = "SAVE PROFILE";
        saveBtn.disabled = false;

        finalCroppedFile = null;
        
        // Clear file input
        fileInput.value = ""; 
        
        showShareModal(); // Or switchTab('profile')

    } catch (e) {
        console.error(e);
        alert("Error saving profile: " + e.message);
        saveBtn.innerText = "SAVE PROFILE";
        saveBtn.disabled = false;
    }
}

    // Find and replace this function in index.html
function renderHobbiesSelector() {
    const container = document.getElementById('setup-interests');
    container.innerHTML = '';
    HOBBIES_LIST.forEach(hobby => {
        const chip = document.createElement('div');
        const uniqueColor = getHobbyDetails(hobby); // Get unique color
        
        chip.className = 'interest-chip';
        
        // Apply color styles
        chip.style.borderColor = uniqueColor;
        chip.style.color = uniqueColor;
        
        if(selectedHobbies.has(hobby)) {
            chip.classList.add('selected');
            // Overwrite styles for selected state
            chip.style.backgroundColor = uniqueColor;
            chip.style.color = 'white';
            chip.style.boxShadow = `0 0 10px ${uniqueColor}50`; // Semi-transparent glow
        }
        
        chip.innerText = hobby;
        chip.onclick = () => {
            if(selectedHobbies.has(hobby)) {
                selectedHobbies.delete(hobby);
                chip.classList.remove('selected');
                // Restore unselected styles
                chip.style.backgroundColor = 'var(--bg-card)';
                chip.style.color = uniqueColor;
                chip.style.boxShadow = 'none';
            }
            else {
                selectedHobbies.add(hobby);
                chip.classList.add('selected');
                // Apply selected styles
                chip.style.backgroundColor = uniqueColor;
                chip.style.color = 'white';
                chip.style.boxShadow = `0 0 10px ${uniqueColor}50`;
            }
        };
        container.appendChild(chip);
    });
}

function updateBioCount() {
    const len = document.getElementById('setup-bio').value.length;
    document.getElementById('bio-count').innerText = `${len}/150`;
}

    function loadAppInterface(userData) {
        // Setup Header & My Profile
        document.getElementById('header-avatar').src = userData.photoURL;
        document.getElementById('header-avatar').style.display = 'block';
        document.getElementById('profile-pic').src = userData.photoURL;
        document.getElementById('profile-name').innerText = userData.displayName;
        document.getElementById('profile-academic').innerText = `${userData.academic.major} â€¢ ${userData.academic.year}`;
        document.getElementById('profile-uni').innerText = userData.academic.university;
        document.getElementById('profile-bio').innerText = userData.bio || "";
        document.getElementById('profile-banner').src = userData.bannerUrl || DEFAULT_BANNER;

        // 2. Show Goal
if(userData.futureGoal) {
    document.getElementById('profile-goal').innerText = userData.futureGoal;
    document.getElementById('profile-goal-container').style.display = 'block';
} else {
    document.getElementById('profile-goal-container').style.display = 'none';
}

startNotificationListener(); 
loadGroupLobby();
startStoryListener();

// 3. Show Interests
const intContainer = document.getElementById('profile-interests');
intContainer.innerHTML = '';
(userData.interests || []).forEach(hobby => {
    const span = document.createElement('div');
    span.className = 'interest-chip selected display-only';
    
    // --- START NEW COLOR CODE ---
    const uniqueColor = getHobbyDetails(hobby);
    span.style.backgroundColor = uniqueColor;
    span.style.borderColor = uniqueColor;
    span.style.color = 'white';
    // --- END NEW COLOR CODE ---
    
    span.innerText = hobby;
    intContainer.appendChild(span);
});
        
        // Load Stats
        // Load Stats (Updated with OnClick)
const followerEl = document.getElementById('stat-followers');
followerEl.innerText = userData.followersCount || 0;
followerEl.parentElement.style.cursor = "pointer";
followerEl.parentElement.onclick = () => openFollowList('followers', currentUser.uid, 'profile');

const followingEl = document.getElementById('stat-following');
followingEl.innerText = userData.followingCount || 0;
followingEl.parentElement.style.cursor = "pointer";
followingEl.parentElement.onclick = () => openFollowList('following', currentUser.uid, 'profile');

        document.getElementById('main-nav').classList.remove('hidden');

        // GPS Logic
        requestGPS();
        // 2. Set up a loop to update every 5 minutes (300,000 milliseconds)
        // This keeps location fresh without killing battery or Quota
        if (window.gpsInterval) clearInterval(window.gpsInterval); // Clear existing if any
        
        window.gpsInterval = setInterval(() => {
            console.log("Auto-updating GPS location...");
            attemptGeoFetch(); 
        }, 300000); // 300000ms = 5 minutes

        startFeedListener();
        loadProfilePosts();
        loadChatList(); // Load Chats
        
        switchTab('feed', document.querySelector('.nav-item'));
    }


    /* --- STORY SYSTEM VARIABLES --- */
let activeStories = {}; // Objects grouped by UID: { uid: [story1, story2] }
let currentViewerStories = []; // Array of stories being viewed currently
let currentStoryIndex = 0;
let storyTimer = null;
let currentStoryUid = null; // UID of the user whose stories we are watching

// --- 1. LISTEN TO STORIES ---
function startStoryListener() {
    const now = Date.now();
    // Query stories that expire in the future
    db.collection('stories')
      .where('expiresAt', '>', now) 
      .orderBy('expiresAt', 'asc') // This is needed for the > query
      .onSnapshot(snapshot => {
          
          activeStories = {}; // Reset local cache
          
          snapshot.forEach(doc => {
              const s = doc.data();
              s.id = doc.id;
              
              if(!activeStories[s.uid]) {
                  activeStories[s.uid] = [];
              }
              activeStories[s.uid].push(s);
          });

          renderStoryTray();
      });
}

// --- 2. RENDER THE TRAY ---
function renderStoryTray() {
    const tray = document.getElementById('stories-tray');
    tray.innerHTML = '';

    // A. Render "My Story" (First Item)
    const myStories = activeStories[currentUser.uid] || [];
    const hasMyStory = myStories.length > 0;
    
    let myRingClass = 'none';
    if (hasMyStory) {
        // Check if I have unseen stories (logic: usually own stories are always "seen" visually, 
        // but let's make it colored if active to show it exists)
        myRingClass = 'seen'; 
    }

    // HTML for My Story
    tray.innerHTML += `
        <div class="story-item" onclick="handleMyStoryClick(${hasMyStory})">
            <div class="story-ring-container ${myRingClass}">
                <div class="story-avatar" style="background-image: url('${currentUser.photoURL}')"></div>
                ${!hasMyStory ? '<div class="add-story-badge"><i class="fa-solid fa-plus"></i></div>' : ''}
            </div>
            <div class="story-username">Your Story</div>
        </div>
    `;

    // B. Render Other Users
    Object.keys(activeStories).forEach(uid => {
        if(uid === currentUser.uid) return; // Skip me (handled above)

        const userStories = activeStories[uid];
        const lastStory = userStories[userStories.length - 1]; // Use details from last story
        
        // Determine if seen
        // Simple logic: Check if currentUser ID is in 'viewers' array of the *last* story
        // For a perfect Instagram clone, check ALL stories, but this is good for MVP
        let isUnseen = false;
        userStories.forEach(s => {
            if(!s.viewers || !s.viewers.includes(currentUser.uid)) {
                isUnseen = true;
            }
        });

        const ringClass = isUnseen ? 'unseen' : 'seen';

        tray.innerHTML += `
            <div class="story-item" onclick="openStoryViewer('${uid}')">
                <div class="story-ring-container ${ringClass}">
                    <div class="story-avatar" style="background-image: url('${lastStory.userPhoto}')"></div>
                </div>
                <div class="story-username">${lastStory.userName.split(' ')[0]}</div>
            </div>
        `;
    });
}

// --- 3. UPLOAD STORY ---
function handleMyStoryClick(hasStory) {
    if (hasStory) {
        // Show the custom modal instead of confirm()
        const modal = document.getElementById('story-options-modal');
        modal.classList.add('flex'); // Uses flex to align to bottom
    } else {
        // No story yet? Go straight to upload
        triggerAddStory();
    }
}

// --- NEW HELPER FUNCTIONS ---

function hideStoryOptions() {
    const modal = document.getElementById('story-options-modal');
    modal.classList.remove('flex');
}

function triggerViewStory() {
    hideStoryOptions();
    openStoryViewer(currentUser.uid);
}

function triggerAddStory() {
    hideStoryOptions();
    document.getElementById('story-file-input').click();
}

async function handleStoryFileSelect() {
    const fileInput = document.getElementById('story-file-input');
    const file = fileInput.files[0];
    if(!file) return;

    // 1. Show Custom Modal
    showUploadModal("Compressing Story...");

    try {
        // 2. Compress
        const compressed = await compressImage(file);
        
        updateProgressBar(40);
        document.getElementById('upload-subtext').innerText = "Uploading to Server...";

        // 3. Upload
        const url = await uploadToImageKit(compressed);
        
        if(!url) throw new Error("Upload failed");

        updateProgressBar(80);
        document.getElementById('upload-subtext').innerText = "Finalizing...";

        // 4. Save to Firestore
        const expiresAt = Date.now() + (24 * 60 * 60 * 1000); 

        await db.collection('stories').add({
            uid: currentUser.uid,
            userName: currentUser.displayName,
            userPhoto: currentUser.photoURL,
            imageUrl: url,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            expiresAt: expiresAt,
            viewers: [] 
        });

        updateProgressBar(100);
        
        // Short delay to let user see 100%
        setTimeout(() => {
            hideUploadModal();
            // Optional: visual feedback toast or just refresh tray
        }, 500);

    } catch(err) {
        console.error(err);
        hideUploadModal();
        alert("Failed to upload story.");
    }

    fileInput.value = ""; 
}

// --- 4. VIEW STORY VIEWER ---
function openStoryViewer(uid) {
    currentStoryUid = uid;
    currentViewerStories = activeStories[uid];
    
    if(!currentViewerStories || currentViewerStories.length === 0) return;

    // Find the first unseen story index
    let startIndex = 0;
    for(let i=0; i<currentViewerStories.length; i++) {
        if(!currentViewerStories[i].viewers || !currentViewerStories[i].viewers.includes(currentUser.uid)) {
            startIndex = i;
            break;
        }
    }

    currentStoryIndex = startIndex;
    
    document.getElementById('story-viewer-modal').style.display = 'flex';
    showStoryAtIndex(currentStoryIndex);
}

function showStoryAtIndex(index) {
    if(index >= currentViewerStories.length) {
        closeStoryViewer();
        return;
    }
    if(index < 0) {
        // Could go to previous user here in advanced version
        index = 0; 
    }

    currentStoryIndex = index;
    const story = currentViewerStories[index];

    // 1. Update UI
    document.getElementById('sv-image').src = story.imageUrl;
    document.getElementById('sv-avatar').style.backgroundImage = `url('${story.userPhoto}')`;
    document.getElementById('sv-name').innerText = story.userName;
    
    // Time calc
    const now = Date.now();
    const created = story.timestamp ? story.timestamp.toDate().getTime() : now;
    const diffMins = Math.floor((now - created) / 60000);
    let timeText = diffMins + "m";
    if(diffMins > 60) timeText = Math.floor(diffMins/60) + "h";
    document.getElementById('sv-time').innerText = timeText;

    // 2. Show Delete button if mine
    const delBtn = document.getElementById('sv-delete-btn');
    if(story.uid === currentUser.uid) {
        delBtn.style.display = 'block';
    } else {
        delBtn.style.display = 'none';
        // Mark as Seen in DB if not mine
        markStoryAsSeen(story.id);
    }

    // 3. Render Progress Bars
    renderProgressBars();

    // 4. Start Timer (5 seconds)
    resetStoryTimer();
}

function renderProgressBars() {
    const container = document.getElementById('story-progress-bars');
    container.innerHTML = '';
    
    currentViewerStories.forEach((s, idx) => {
        const bar = document.createElement('div');
        bar.className = 'story-progress-bar';
        
        const fill = document.createElement('div');
        fill.className = 'story-progress-fill';
        
        if(idx < currentStoryIndex) {
            fill.style.width = '100%'; // Already seen
        } else if (idx === currentStoryIndex) {
            // Animate current
            fill.style.width = '0%';
            setTimeout(() => { fill.style.width = '100%'; fill.style.transition = 'width 5s linear'; }, 50);
        } else {
            fill.style.width = '0%'; // Future
        }
        
        bar.appendChild(fill);
        container.appendChild(bar);
    });
}

function resetStoryTimer() {
    if(storyTimer) clearTimeout(storyTimer);
    storyTimer = setTimeout(() => {
        nextStory();
    }, 5000); // 5 seconds per story
}

function nextStory() {
    showStoryAtIndex(currentStoryIndex + 1);
}

function prevStory() {
    showStoryAtIndex(currentStoryIndex - 1);
}

function closeStoryViewer() {
    document.getElementById('story-viewer-modal').style.display = 'none';
    if(storyTimer) clearTimeout(storyTimer);
    // Refresh tray to update ring colors
    renderStoryTray();
}

function markStoryAsSeen(storyId) {
    // Optimistic check: don't write if already seen
    // But for simplicity, arrayUnion handles uniqueness
    db.collection('stories').doc(storyId).update({
        viewers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
}

function deleteCurrentStory() {
    const story = currentViewerStories[currentStoryIndex];
    if(!story) return;
    
    if(confirm("Delete this story?")) {
        db.collection('stories').doc(story.id).delete().then(() => {
            alert("Deleted");
            // Remove from local array immediately for UI smoothness
            currentViewerStories.splice(currentStoryIndex, 1);
            if(currentViewerStories.length === 0) {
                closeStoryViewer();
            } else {
                showStoryAtIndex(currentStoryIndex); // Will show next or stay
            }
        });
    }
}

    // --- PROFILE & FOLLOW SYSTEM ---
    // --- REPLACE YOUR EXISTING openUserProfile FUNCTION WITH THIS ---

function openUserProfile(uid) {
    if (uid === currentUser.uid) {
        window.location.hash = 'profile';
        return;
    }
    viewingUserId = uid;

    // Clear previous data
    document.getElementById('other-profile-feed').innerHTML = '<p style="text-align:center;padding:20px;color:#666">Loading posts...</p>';

    db.collection('users').doc(uid).onSnapshot(doc => {
        const u = doc.data();
        document.getElementById('other-banner').src = u.bannerUrl || DEFAULT_BANNER;
        document.getElementById('other-pic').style.backgroundImage = `url('${u.photoURL}')`;
        document.getElementById('other-name').innerText = u.displayName;

        // Academic Info
        document.getElementById('other-academic').innerText = `${u.academic.major} â€¢ ${u.academic.year} â€¢ ${u.academic.university}`;

        // Stats
        const otherFollowerEl = document.getElementById('other-stat-followers');
        otherFollowerEl.innerText = u.followersCount || 0;
        otherFollowerEl.parentElement.style.cursor = "pointer";
        otherFollowerEl.parentElement.onclick = () => openFollowList('followers', uid, 'other-profile');

        const otherFollowingEl = document.getElementById('other-stat-following');
        otherFollowingEl.innerText = u.followingCount || 0;
        otherFollowingEl.parentElement.style.cursor = "pointer";
        otherFollowingEl.parentElement.onclick = () => openFollowList('following', uid, 'other-profile');

        document.getElementById('other-bio').innerText = u.bio || "No bio.";

        // Goals
        if (u.futureGoal) {
            document.getElementById('other-goal').innerText = u.futureGoal;
            document.getElementById('other-goal-container').style.display = 'block';
        } else {
            document.getElementById('other-goal-container').style.display = 'none';
        }

        // --- FIXED INTERESTS RENDERING WITH COLORS ---
        const intContainer = document.getElementById('other-interests');
        intContainer.innerHTML = '';
        (u.interests || []).forEach(hobby => {
            const span = document.createElement('div');
            span.className = 'interest-chip selected display-only';
            
            // 1. Get the unique color
            const uniqueColor = getHobbyDetails(hobby);
            
            // 2. Apply the styles manually
            span.style.backgroundColor = uniqueColor;
            span.style.borderColor = uniqueColor;
            span.style.color = 'white';
            
            span.innerText = hobby;
            intContainer.appendChild(span);
        });
        // ---------------------------------------------

        // Follow Button Check
        db.collection('users').doc(currentUser.uid).collection('following').doc(uid).get().then(fDoc => {
            const btn = document.getElementById('btn-follow');
            if (fDoc.exists) {
                btn.innerText = "Unfollow";
                btn.style.background = "var(--bg-card)";
                btn.style.border = "1px solid var(--border)";
            } else {
                btn.innerText = "Follow";
                btn.style.background = "var(--accent)";
                btn.style.border = "none";
            }
        });

        // Load their posts
        loadOtherUserPosts(uid);

        window.location.hash = 'other-profile';
    });
}

    function loadOtherUserPosts(uid) {
    db.collection('posts')
        .where('uid', '==', uid)
        .orderBy('timestamp', 'desc')
        .get()
        .then(snapshot => {
            const container = document.getElementById('other-profile-feed');
            container.innerHTML = '';
            
            if (snapshot.empty) {
                container.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">No posts yet.</p>';
                return;
            }

            // PASS 'other' HERE
            snapshot.forEach(doc => {
                container.appendChild(renderPost(doc, 'other'));
            });
        });
}

    function toggleFollow() {
        if(!viewingUserId) return;
        const myRef = db.collection('users').doc(currentUser.uid);
        const otherRef = db.collection('users').doc(viewingUserId);
        
        myRef.collection('following').doc(viewingUserId).get().then(doc => {
            if(doc.exists) {
                // Unfollow
                myRef.collection('following').doc(viewingUserId).delete();
                otherRef.collection('followers').doc(currentUser.uid).delete();
                myRef.update({followingCount: firebase.firestore.FieldValue.increment(-1)});
                otherRef.update({followersCount: firebase.firestore.FieldValue.increment(-1)});
            } else {
                // Follow
                myRef.collection('following').doc(viewingUserId).set({timestamp: new Date()});
                otherRef.collection('followers').doc(currentUser.uid).set({timestamp: new Date()});
                myRef.update({followingCount: firebase.firestore.FieldValue.increment(1)});
                otherRef.update({followersCount: firebase.firestore.FieldValue.increment(1)});
            }
        });
    }

    // --- CHAT SYSTEM ---
    function startChat() {
        if(!viewingUserId) return;
        const chatId = [currentUser.uid, viewingUserId].sort().join('_');
        const otherName = document.getElementById('other-name').innerText;
        const otherPhoto = document.getElementById('other-pic').style.backgroundImage.slice(5, -2); // Extract URL

        db.collection('chats').doc(chatId).set({
            participants: [currentUser.uid, viewingUserId],
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            participantDetails: { 
                [viewingUserId]: { name: otherName, photo: otherPhoto },
                [currentUser.uid]: { name: currentUser.displayName, photo: currentUser.photoURL }
            }
        }, {merge: true}).then(() => {
            window.location.href = `chat.html?chatId=${chatId}`;
        });
    }

    function loadChatList() {
        db.collection('chats')
          .where('participants', 'array-contains', currentUser.uid)
          .onSnapshot(snap => {
              const div = document.getElementById('chat-list-container');
              div.innerHTML = '';
              if(snap.empty) {
                  div.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-secondary)'>No messages yet.</div>";
                  return;
              }
              
              let chats = [];
              snap.forEach(doc => { chats.push({ id: doc.id, ...doc.data() }); });
              chats.sort((a, b) => {
                  const dateA = a.lastUpdated ? a.lastUpdated.toDate() : new Date(0);
                  const dateB = b.lastUpdated ? b.lastUpdated.toDate() : new Date(0);
                  return dateB - dateA; 
              });

              chats.forEach(chat => {
                  const otherId = chat.participants.find(id => id !== currentUser.uid);
                  const otherUser = chat.participantDetails ? chat.participantDetails[otherId] : {name: 'User', photo: ''};
                  
                  div.innerHTML += `
                      <div class="chat-item" onclick="window.location.href='chat.html?chatId=${chat.id}'">
                          <div class="avatar" style="background-image:url('${otherUser.photo}')"></div>
                          <div>
                              <div style="font-weight:600;">${otherUser.name}</div>
                              <div style="font-size:0.8rem; color:var(--text-secondary);">Open Chat</div>
                          </div>
                      </div>
                  `;
              });
          });
    }

    // --- IMAGE COMPRESSION & UPLOAD ---
    function previewImage() {
        const file = document.getElementById('post-file').files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    function clearImage() {
        document.getElementById('post-file').value = "";
        document.getElementById('image-preview').style.display = 'none';
    }

    // New Compression Function
    function compressImage(file) {
    return new Promise((resolve, reject) => {
        // 1. REDUCE RESOLUTION
        // Previously 1200. Changing to 800-1000 is great for mobile apps.
        const maxWidth = 500; 

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                const elem = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Resize logic
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }

                elem.width = width;
                elem.height = height;
                const ctx = elem.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // 2. REDUCE JPEG QUALITY
                // The last number (0.5) is the quality (0 to 1).
                // 0.8 = High Quality, Large Size
                // 0.5 = Medium Quality, Small Size (Recommended for fast feeds)
                // 0.3 = Low Quality, Very Small Size
                ctx.canvas.toBlob((blob) => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', 0.5); 
            }
            img.onerror = (err) => reject(err);
        }
        reader.onerror = (err) => reject(err);
    });
}

    async function uploadToImageKit(file) {
        try {
            // 1. Fetch secure signature from YOUR Netlify Function
            // Note: The path is always /.netlify/functions/<filename>
            const authResponse = await fetch('/.netlify/functions/auth');
            
            if (!authResponse.ok) throw new Error("Failed to get auth params");
            const authData = await authResponse.json();

            // 2. Prepare Upload
            const formData = new FormData();
            formData.append("file", file);
            formData.append("fileName", "cp-" + Date.now());
            formData.append("publicKey", IMAGEKIT_PUBLIC_KEY); // Public key is safe to keep in JS
            
            // 3. Use the params we fetched from the server
            formData.append("signature", authData.signature);
            formData.append("expire", authData.expire);
            formData.append("token", authData.token);
            formData.append("useUniqueFileName", "true");

            // 4. Send to ImageKit
            const response = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
                method: "POST", 
                body: formData
            });
            
            const data = await response.json();
            return data.url;

        } catch (error) {
            console.error("Upload failed", error);
            alert("Image upload failed: " + error.message);
            return null;
        }
    }

    // --- POSTS & RADAR (With Blips) ---
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
        var R = 6371e3; 
        var dLat = (lat2-lat1) * (Math.PI/180);  
        var dLon = (lon2-lon1) * (Math.PI/180); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }

    // --- POSTS & RADAR (With Blips) ---
// Find this function and replace it:

function loadNearbyUsers() {
    const list = document.getElementById('user-list');
    const radarCircle = document.querySelector('.radar-circle');
    const MAX_RANGE = 5000; // 5000 meters (5 km)
    
    // Display the range prominently (in the GPS status indicator area)
    const statusEl = document.getElementById('gps-status-indicator');
    statusEl.innerHTML = `<i class="fa-solid fa-satellite-dish"></i> RANGE: <span style="color:#4dabf8">${MAX_RANGE / 1000} KM</span>`;

    db.collection('users').orderBy('lastActive', 'desc').limit(20).onSnapshot(snap => {
        list.innerHTML = '';
        const oldBlips = radarCircle.querySelectorAll('.radar-blip, .blip-tooltip');
        oldBlips.forEach(el => el.remove());
        
        let usersWithDistance = [];
        snap.forEach(doc => {
            const u = doc.data();
            if(u.uid !== currentUser.uid) {
                let dist = null;
                // Only calculate distance if myLocation and user location exist
                if(myLocation && u.location) {
                    dist = getDistanceFromLatLonInMeters(myLocation.lat, myLocation.lng, u.location.lat, u.location.lng);
                }
                
                // IMPORTANT: Filter out users immediately if distance is unknown or outside MAX_RANGE
                if (dist !== null && dist <= MAX_RANGE) {
                    usersWithDistance.push({ ...u, distance: dist });
                }
            }
        });

        if(usersWithDistance.length === 0) { 
            list.innerHTML = '<p class="mono" style="color:var(--text-secondary); text-align:center;">No students found within range.</p>'; 
            return; 
        }

        usersWithDistance.sort((a, b) => a.distance - b.distance);

        usersWithDistance.forEach(u => {
            let distText = `${Math.round(u.distance)}m`;
            
            // --- 1. Populate the User List (List View) ---
            list.innerHTML += `
                <div class="user-list-item" onclick="openUserProfile('${u.uid}')">
                    <div class="avatar" style="background-image: url('${u.photoURL || ''}')"></div>
                    <div style="flex:1;">
                        <div class="h-flex" style="justify-content:space-between;">
                            <div style="font-weight:600;">${u.displayName}</div>
                            <div class="mono" style="font-size:0.7rem; color:var(--accent);">${distText}</div>
                        </div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">${u.academic?.major || 'Student'}</div>
                    </div>
                </div>
            `;

            // --- 2. Populate the Radar View (Blips) ---
            if(u.distance !== null) {
                const blip = document.createElement('div');
                blip.className = 'radar-blip';
                
                // Calculate position based on distance: map 0m to 0% and MAX_RANGE to 45% radial distance
                // We use 45% to keep the blip inside the radar circle boundary.
                const percentFromCenter = (u.distance / MAX_RANGE) * 45;Â 
                
                // Keep random angle to distribute blips realistically
                const randomAngle = Math.random() * 2 * Math.PI;
                const top = 50 + (percentFromCenter * Math.sin(randomAngle));
                const left = 50 + (percentFromCenter * Math.cos(randomAngle));
                
                blip.style.top = top + '%'; blip.style.left = left + '%';
                blip.onclick = (e) => { e.stopPropagation(); openUserProfile(u.uid); };
                
                const tooltip = document.createElement('div');
                tooltip.className = 'blip-tooltip';
                tooltip.innerText = u.displayName.split(' ')[0] + ` (${distText})`;
                tooltip.style.top = top + '%';
                tooltip.style.left = left + '%';
                
                radarCircle.appendChild(tooltip);
                radarCircle.appendChild(blip);
            }
        });
    });
}

    // --- MENU FUNCTIONS ---

// Updated toggle function to handle unique IDs based on source
function togglePostMenu(pid, source, event) {
    // Check if event exists before trying to use it
    if(event && event.stopPropagation) {
        event.stopPropagation();
    }
    
    // 1. Close all OTHER open menus first
    document.querySelectorAll('.dropdown-menu').forEach(el => {
        // We only want to close menus that are NOT the one we just clicked
        if(el.id !== `menu-${source}-${pid}`) {
            el.classList.remove('show');
        }
    });

    // 2. Toggle the specific menu we clicked
    const menu = document.getElementById(`menu-${source}-${pid}`);
    if(menu) {
        menu.classList.toggle('show');
    }
}

// 2. Global listener to close menus when clicking anywhere else
window.onclick = function(event) {
    if (!event.target.matches('.menu-trigger')) {
        document.querySelectorAll('.dropdown-menu').forEach(el => {
            el.classList.remove('show');
        });
    }
}

// --- DELETE FUNCTION ---
function deletePost(pid) {
    if(!confirm("Are you sure you want to delete this post? This cannot be undone.")) return;

    // 1. Delete from Firestore
    db.collection('posts').doc(pid).delete().then(() => {
        // UI will update automatically because of onSnapshot in startFeedListener
        alert("Post deleted successfully.");
    }).catch((error) => {
        console.error("Error removing document: ", error);
        alert("Error deleting post.");
    });
}

// --- REPORT FUNCTION ---
function reportPost(pid, reportedUid, reportedName) {
    const reason = prompt("Why are you reporting this post? (e.g., Spam, Abusive, Fake News)");
    
    if(!reason) return; // User cancelled

    db.collection('reports').add({
        postId: pid,
        reportedUserUid: reportedUid,
        reportedUserName: reportedName,
        reporterUid: currentUser.uid,
        reporterName: currentUser.displayName,
        reason: reason,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        status: "pending"
    }).then(() => {
        alert("Report submitted. We will review this post shortly.");
        // Optional: Hide the menu
        const menu = document.getElementById(`menu-${pid}`);
        if(menu) menu.classList.remove('show');
    }).catch(err => {
        console.error(err);
        alert("Failed to submit report.");
    });
}

    function startFeedListener() {
    db.collection('posts').orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
        const container = document.getElementById('feed-container'); 
        container.innerHTML = '';
        // PASS 'feed' HERE
        snap.forEach(doc => container.appendChild(renderPost(doc, 'feed')));
    });
}

    function loadProfilePosts() {
    db.collection('posts').where('uid', '==', currentUser.uid).orderBy('timestamp', 'desc').onSnapshot(snap => {
        const container = document.getElementById('profile-feed'); 
        container.innerHTML = '';
        document.getElementById('stat-posts').innerText = snap.size;
        // PASS 'profile' HERE
        snap.forEach(doc => container.appendChild(renderPost(doc, 'profile')));
    });
}

    function renderPost(doc, source = 'feed') {
    const post = doc.data();
    const pid = doc.id;
    
    // Format Timestamp
    const time = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    
    // Boost Logic
    const boosts = post.boosts || [];
    const isBoosted = boosts.includes(currentUser.uid);
    
    // Owner Check
    const isOwner = post.uid === currentUser.uid;

    // Image HTML (Using the new CSS class for aspect ratio)
    const imageHTML = post.imageUrl ? `<img src="${post.imageUrl}" class="feed-post-img" alt="Post Image">` : '';

    // --- MENU BUTTONS ---
    // 1. Delete Button: Only if isOwner is true
    const deleteBtn = isOwner ? `
        <div class="dropdown-item danger" onclick="deletePost('${pid}')">
            <i class="fa-solid fa-trash"></i> Delete Post
        </div>
    ` : '';

    // 2. Report Button: Only if isOwner is false
    const reportBtn = !isOwner ? `
        <div class="dropdown-item" onclick="reportPost('${pid}', '${post.uid}', '${post.userName}')">
            <i class="fa-solid fa-flag"></i> Report
        </div>
    ` : '';

    const el = document.createElement('div');
    el.className = 'post-card';
    
    el.innerHTML = `
        <div class="h-flex" style="margin-bottom:10px; align-items: flex-start;">
            <div class="avatar" style="background-image: url('${post.userPhoto}'); cursor:pointer;" onclick="openUserProfile('${post.uid}')"></div>
            
            <div style="flex:1" onclick="openUserProfile('${post.uid}')">
                <div style="font-weight:600; font-size:0.95rem; cursor:pointer;">${post.userName}</div>
                <div style="font-size:0.75rem; color:var(--text-secondary)">${time}</div>
            </div>

            <div class="post-header-right">
                <i class="fa-solid fa-ellipsis-vertical menu-trigger" onclick="togglePostMenu('${pid}', '${source}', event)"></i>
                
                <div id="menu-${source}-${pid}" class="dropdown-menu">
                    ${deleteBtn}
                    ${reportBtn}
                    <div class="dropdown-item" onclick="togglePostMenu('${pid}', '${source}', event)">
                        <i class="fa-solid fa-xmark"></i> Close
                    </div>
                </div>
            </div>
        </div>

        <div class="goal-tag mono" style="margin-bottom:10px; display:inline-block;">${post.goal}</div>
        <p style="font-size:0.95rem; line-height:1.5;">${post.text}</p>
        ${imageHTML}
        
        <div class="post-actions">
            <div class="action-item ${isBoosted ? 'boosted' : ''}" onclick="toggleBoost('${pid}')">
                <i class="fa-solid fa-bolt"></i><span>Boost (${boosts.length})</span>
            </div>
            <div class="action-item" onclick="toggleDiscussion('${pid}')">
                <i class="fa-regular fa-comment-dots"></i><span>Discussion</span>
            </div>
        </div>
        
        <div class="discussion-area" id="discuss-${pid}">
            <div id="comments-${pid}" style="margin-bottom:10px;"></div>
            <div class="h-flex">
                <input type="text" id="input-${pid}" class="nexus-input" style="margin-bottom:0; font-size:0.85rem; padding:8px;" placeholder="Comment...">
                <button onclick="postComment('${pid}')" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:6px; margin-left:8px;"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    `;
    return el;
}

    // MODIFIED CREATE POST TO HANDLE IMAGE & COMPRESSION
    async function createPost() {
    const text = document.getElementById('post-text').value;
    const goal = document.getElementById('post-goal').value || "#Update";
    const fileInput = document.getElementById('post-file');
    const btn = document.getElementById('btn-post');

    if(!text && !fileInput.files[0]) return alert("Please add text or an image.");

    // Disable button to prevent double clicks
    btn.disabled = true;

    let uploadedImageUrl = "";

    try {
        if(fileInput.files.length > 0) {
            // 1. Show Modal
            showUploadModal("Optimizing Image...");
            
            // 2. Compress
            const compressedFile = await compressImage(fileInput.files[0]);
            
            updateProgressBar(50);
            document.getElementById('upload-subtext').innerText = "Uploading Media...";

            // 3. Upload
            uploadedImageUrl = await uploadToImageKit(compressedFile);
            
            if(!uploadedImageUrl) {
                throw new Error("Image upload failed");
            }
            updateProgressBar(90);
        } else {
            // If text only, just show a quick spinner
            showUploadModal("Posting update...");
            updateProgressBar(50);
        }

        document.getElementById('upload-subtext').innerText = "Saving Post...";

        // 4. Save to Firestore
        await db.collection('posts').add({
            text: text,
            goal: goal,
            imageUrl: uploadedImageUrl,
            uid: currentUser.uid,
            userName: currentUser.displayName,
            userPhoto: currentUser.photoURL,
            boosts: [],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        updateProgressBar(100);

        // Success!
        setTimeout(() => {
            hideUploadModal();
            
            // Cleanup UI
            document.getElementById('post-text').value = '';
            clearImage();
            btn.innerText = "POST UPDATE";
            btn.disabled = false;
            
            // Go to feed
            switchTab('feed', document.querySelector('.nav-item'));
        }, 500);

    } catch(err) {
        console.error(err);
        hideUploadModal();
        alert("Error posting: " + err.message);
        btn.innerText = "POST UPDATE";
        btn.disabled = false;
    }
}

    function toggleBoost(pid) {
        const ref = db.collection('posts').doc(pid);

        db.runTransaction(t => {
            return t.get(ref).then(doc => {
                const boosts = doc.data().boosts || [];
                const isCurrentlyBoosted = boosts.includes(currentUser.uid);

                t.update(ref, { 
                    boosts: isCurrentlyBoosted 
                        ? firebase.firestore.FieldValue.arrayRemove(currentUser.uid) 
                        : firebase.firestore.FieldValue.arrayUnion(currentUser.uid) 
                });
                
                // Return whether the post was boosted (true) or unboosted (false)
                return !isCurrentlyBoosted;
            });
        }).then(wasBoosted => {
            // SUCCESS: If the action was a BOOST (not an unboost), show the animation
            if (wasBoosted) {
                showBoostAnimation();
            }
            // If it was an unboost, we don't need a visible animation.
            
        }).catch(error => {
            console.error("Boost transaction failed: ", error);
            // Optional: Show an error toast here
        });
    }

    function toggleDiscussion(pid) {
        const area = document.getElementById(`discuss-${pid}`);
        area.classList.toggle('show');
        if(area.classList.contains('show')) loadComments(pid);
    }

    function postComment(pid) {
        const val = document.getElementById(`input-${pid}`).value;
        if(!val) return;
        db.collection('posts').doc(pid).collection('comments').add({
            text: val, userName: currentUser.displayName, uid: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => document.getElementById(`input-${pid}`).value = '');
    }

    function loadComments(pid) {
        const box = document.getElementById(`comments-${pid}`);
        db.collection('posts').doc(pid).collection('comments').orderBy('timestamp').onSnapshot(snap => {
            box.innerHTML = '';
            snap.forEach(d => box.innerHTML += `<div class="comment-item"><strong>${d.data().userName}:</strong> ${d.data().text}</div>`);
        });
    }

    
    function editProfile() {
    // Load text data
    document.getElementById('setup-name').value = globalProfileData.displayName || "";
    document.getElementById('setup-university').value = globalProfileData.academic.university || "";
    document.getElementById('setup-major').value = globalProfileData.academic.major || "";
    document.getElementById('setup-year').value = globalProfileData.academic.year || "";
    document.getElementById('setup-bio').value = globalProfileData.bio || "";
    document.getElementById('setup-goal').value = globalProfileData.futureGoal || "";
    updateBioCount();

    // NEW: Load current profile picture into the preview
    document.getElementById('setup-pic-preview').src = globalProfileData.photoURL || currentUser.photoURL;

    selectedBannerUrl = globalProfileData.bannerUrl || DEFAULT_BANNER;
    document.getElementById('setup-banner-preview').src = selectedBannerUrl;

    // Load saved hobbies
    selectedHobbies = new Set(globalProfileData.interests || []);
    renderHobbiesSelector();

    switchTab('setup', null);
}
    
    function cancelSetup() { if(globalProfileData.uid) switchTab('profile', document.querySelectorAll('.nav-item')[3]); }

    function toggleTheme() {
        const h = document.documentElement;
        const m = h.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        h.setAttribute('data-theme', m);
        document.getElementById('theme-btn').className = m === 'dark' ? "fa-solid fa-moon" : "fa-regular fa-sun";
    }

    initApp();

    // --- FOLLOWER/FOLLOWING LIST LOGIC ---

function openFollowList(type, uid, fromTab) {

    
    // Set Title
    const title = type === 'followers' ? 'FOLLOWERS' : 'FOLLOWING';
    document.getElementById('follow-list-title').innerText = title;
    
    // Show Loading
    const container = document.getElementById('follow-list-content');
    container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">Loading...</p>';
    
    // Switch View
    window.location.hash = 'follow-list';

    // Fetch the IDs first
    db.collection('users').doc(uid).collection(type).limit(50).get().then(async (snapshot) => {
        if (snapshot.empty) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-secondary); margin-top:20px;">List is empty.</p>';
            return;
        }

        container.innerHTML = ''; // Clear loading
        
        // Loop through docs and fetch user profiles
        // Note: In a production app, you would duplicate name/photo in the follower doc to avoid these extra reads.
        const promises = [];
        snapshot.forEach(doc => {
            const targetUid = doc.id;
            promises.push(db.collection('users').doc(targetUid).get());
        });

        const userDocs = await Promise.all(promises);

        userDocs.forEach(userDoc => {
            if (userDoc.exists) {
                const u = userDoc.data();
                container.innerHTML += renderUserListItem(u);
            }
        });
    });
}

function closeFollowList() {
    // This acts exactly like hitting the physical back button on Android
    window.history.back();
}

// Reusable render function (matches your Radar style)
function renderUserListItem(u) {
    return `
        <div class="user-list-item" onclick="openUserProfile('${u.uid}')">
            <div class="avatar" style="background-image: url('${u.photoURL || ''}')"></div>
            <div style="flex:1;">
                <div class="h-flex" style="justify-content:space-between;">
                    <div style="font-weight:600;">${u.displayName}</div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">${u.academic?.major || 'Student'}</div>
            </div>
        </div>
    `;
}
    </script>
</body>
</html>